<head>
    {% include "sub/head" %}
    {% block head %}{% endblock %}
</head>

<body>
    {% include "sub/head_content" %}
    <div class="page_header" id="pageNav"></div>
    <section class="contents_wrap g-col2 ty1">
        <article class="conts g-row" style="overflow:auto; height: 100%;">
            <ul class="list_sty pj_list ty_list" id="projectList">
                <!-- ÌòÑÏû• Í∞úÏÑ§ Î™©Î°ù -->
            </ul>
        </article>

        <article class="conts g-row">
            <div class="conts_form">
                <div class="btn_area s_default _outline">
                    <button type="button" class="btn _point" id="new_request">{{ message('btn.029') }}</button>
                    <!-- Ïã†Í∑úÏã†Ï≤≠ -->
                    <button type="button" class="btn" id="save_request">{{ message('btn.047') }}</button>
                    <!-- Ïã†Í∑úÏã†Ï≤≠ Ïãú: Í∞úÏÑ§ÏöîÏ≤≠ / ÌîÑÎ°úÏ†ùÌä∏ ÏàòÏ†ï Ïãú: Ï†ÄÏû• -->
                </div>

                <div class="form_box">
                    <form id="newRequestForm">
                        <!-- row -->
                        <div class="row">
                            <div class="col">
                                <div class="form_label required">{{ message('item.com.007') }}</div> <!-- Í≥µÏÇ¨Î™Ö -->
                                <div class="form_data">
                                    <input type="text" id="plcNm" name="plcNm" class="maxlength" maxlength="100"
                                        required>
                                </div>
                            </div>
                        </div>
                        <!-- row -->
                        <div class="row">
                            <div class="col">
                                <div class="form_label">{{ message('item.com.008') }}</div> <!-- ÌòÑÏû•ÏúÑÏπò -->
                                <div class="form_data">
                                    <span class="item_group">
                                        <input type="text" id="plcLctAdrsCntnts" name="plcLctAdrsCntnts"
                                            class="maxlength" maxlength="100">
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- row -->
                        <div class="row">
                            <div class="col">
                                <div class="form_label">{{ message('item.info.007') }}</div> <!-- Í≥µÏÇ¨Í∏∞Í∞Ñ -->
                                <div class="form_data">
                                    <span class="item_group">
                                        <input type="date" id="pjtBgnDate" name="pjtBgnDate" class="date w-md">
                                        ~
                                        <input type="date" id="pjtEndDate" name="pjtEndDate" class="date w-md">
                                        <span class="item_wrap w-sm put_txt _day">
                                            <input type="text" id="cnstwkDaynum" name="cnstwkDaynum" class="maxlength"
                                                maxlength="5">
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- row -->
                        <div class="row cols2">
                            <div class="col">
                                <div class="form_label">{{ message('item.info.002') }}</div> <!-- Í≥µÏÇ¨Íµ¨Î∂Ñ -->
                                <div class="form_data">
                                    <span class="selectbox" id="selectBox1">
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form_label">{{ message('item.info.012') }}</div> <!-- Í≥ÑÏïΩÍµ¨Î∂Ñ -->
                                <div class="form_data">
                                    <span class="selectbox" id="selectBox2">
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form_label">{{ message('item.info.009') }}</div> <!-- Í≥µÏÇ¨ÏäπÏù∏ÏùºÏûê -->
                                <div class="form_data">
                                    <input type="date" id="aprvlDate" name="aprvlDate" class="date w-md">
                                </div>
                            </div>
                        </div>
                        <!-- row -->
                        <div class="row cols3">
                            <div class="col merge2">
                                <div class="form_label">{{ message('item.info.023') }}</div> <!-- Ï£ºÏöîÏãúÏÑ§ -->
                                <div class="form_data">
                                    <input type="text" id="mainFcltyCntnts" name="mainFcltyCntnts" class="maxlength"
                                        maxlength="200" />
                                </div>
                            </div>
                            <div class="col">
                                <div class="form_label">{{ message('item.info.024') }}</div> <!-- ÏàòÏöîÍ∏∞Í¥Ä -->
                                <div class="form_data">
                                    <input type="text" id="dminsttNm" name="dminsttNm" class="maxlength"
                                        maxlength="100" />
                                </div>
                            </div>
                        </div>
                        <!-- row -->
                        <div class="row cols2">
                            <div class="col">
                                <div class="form_label">{{ message('item.pinstall.006') }}</div> <!-- Îã¥ÎãπÏûê -->
                                <div class="form_data">
                                    <input type="text" id="ofclNm" name="ofclNm" class="maxlength" maxlength="20">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form_label">E-mail</div>
                                <div class="form_data">
                                    <input type="email" id="email" name="email" class="form-control email maxlength"
                                        maxlength="100">
                                </div>
                            </div>
                            <div class="col">
                                <div class="form_label">{{ message('item.contract.036') }}</div> <!-- Ï†ÑÌôîÎ≤àÌò∏ -->
                                <div class="form_data">
                                    <input type="tel" id="telNo" name="telNo" class="form-control telNo maxlength"
                                        maxlength="20">
                                </div>
                            </div>
                        </div>
                        <!-- row -->
                        <div class="row">
                            <div class="col">
                                <div class="form_label">{{ message('item.com.022') }}</div> <!-- ÎπÑÍ≥† -->
                                <div class="form_data">
                                    <textarea id="rmk" name="rmk" class="maxlength" maxlength="2000"></textarea>
                                </div>
                            </div>
                        </div>
                        <!-- row -->
                        <div class="row">
                            <div class="col">
                                <div class="form_label">{{ message('item.pinstall.002') }}</div> <!-- ÏûêÎ£åÏ≤®Î∂Ä -->
                                <div class="form_data">

                                    <div class="attach_wrap">
                                        <div class="attach_toolbar">
                                            <div class="btn_area s_small">
                                                <button type="button" class="btn _outline" id="removeAllButton">{{
                                                    message('btn.020') }}</button> <!-- Î™®ÎëêÏÇ≠Ï†ú -->
                                                <div class="attach_btn">
                                                    <input type="file" id="fileInput" name="files" multiple>
                                                    <button type="button" class="btn _fill" id="addFileButton">{{
                                                        message('btn.021') }}</button> <!-- ÌååÏùºÏ≤®Î∂Ä -->
                                                </div>
                                            </div>
                                            <div class="attach_info">
                                                <span class="attach_result">
                                                    <span class="sucess">
                                                        <i class="ic ic-check"></i>
                                                        <b class="num" id="uploadedFileCount">0</b>
                                                    </span>
                                                    <span class="fail">
                                                        <i class="ic ic-close"></i>
                                                        <b class="num" id="failedFileCount">0</b>
                                                    </span>
                                                </span>
                                                <span class="attach_capacity">
                                                    <span class="item" id="uploadedFileSize">0 KB</span>
                                                    <span class="item">25 MB</span>
                                                </span>
                                            </div>
                                        </div>

                                        <div class="attach_area">
                                            <!-- Ï≤®Î∂ÄÌååÏùº ÎØ∏Îì±Î°ù Ïãú -->
                                            <p class="data_info">
                                                Í≥µÏÇ¨ Í≥ÑÏïΩÏÑú , Í≥µÏÇ¨ Í∞úÏöî Ï†ïÎ≥¥, Ï°∞Í∞êÎèÑ Îì±Ïùò ÌååÏùºÏùÑ Ï≤®Î∂ÄÌï¥ Ï£ºÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.
                                            </p>

                                            <!-- Ï≤®Î∂ÄÌååÏùº Îì±Î°ù Ïãú ÌôúÏÑ±Ìôî 'hide'Ï†úÍ±∞-->
                                            <div class="attach_list hide">
                                                <ul class="file_header">
                                                    <li class="header_item">
                                                        <button type="button" class="icon_btn">
                                                            <i class="ic ic-close"></i>
                                                            <span class="blind">{{ message('item.com.020') }}</span>
                                                            <!-- ÌååÏùºÎ™Ö -->
                                                        </button>
                                                        <span class="f_name">{{ message('item.com.020') }}</span>
                                                        <!-- ÌååÏùºÎ™Ö -->
                                                        <span class="f_progress">{{ message('item.info.036')
                                                            }}</span> <!-- ÏßÑÌñâÏÉÅÌÉú -->
                                                        <span class="f_capacity">{{ message('item.com.021') }}</span>
                                                        <!-- ÌÅ¨Í∏∞ -->
                                                    </li>
                                                </ul>
                                                <ul class="file_list" id="fileList"></ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </article>
    </section>
    {% include "sub/pop_box" %}
</body>


</html>
<style>
    .label._default {
        background-color: #BAB9C5;
    }
</style>
<script src="/assets/js/validation.js"></script>
<script src="/assets/js/main_common.js"></script>
<script>
    $(function () {
        gaia.create({
            $init: function ($params) {
                page.loadSelectBoxes();
                page.init();
            }
        });
    });

    var page = {
        uploadedFileCount: null,
        failedFileCount: null,
        uploadedFileSize: null,
        maxTotalFileSize: 25 * 1024 * 1024, // 25 MB
        currentProjectNo: null,
        currentProject: null,
        totalFileSize: 0,
        failedFileCounts: 0,
        successfulFileCount: 0,
        existingFiles: [],
        allRemovedFiles: [],
        removedFiles: {}, // ÌîÑÎ°úÏ†ùÌä∏Î≥ÑÎ°ú ÏÇ≠Ï†úÎêú ÌååÏùºÏùÑ Í¥ÄÎ¶¨

        init: function () {
            $(function () {
                var title = "{{ message('item.pinstall.001') }}"
                gaiaPortal.navMenuInit("MAIN", title);
                $("#menuDepth").append(`<li class=\"breadcrumb_item\" id=\"depth_txt\">${title}</li>`);
                page.fetchProjects();
                page.cacheElements();
                page.addEventListeners();
            })
        },
        cacheElements() {
            this.newRequestButton = document.getElementById('new_request');
            this.saveRequestButton = document.getElementById('save_request');
            this.newRequestForm = document.getElementById('newRequestForm');
            this.projectList = document.getElementById('projectList');
            this.addFileButton = document.getElementById('addFileButton');
            this.removeAllButton = document.getElementById('removeAllButton');
            this.fileInput = document.getElementById('fileInput');
            this.fileList = document.getElementById('fileList');
            this.uploadedFileCount = document.getElementById('uploadedFileCount'); // ÏÑ±Í≥µÌïú ÌååÏùº Í∞úÏàò
            this.failedFileCount = document.getElementById('failedFileCount'); // Ïã§Ìå®Ìïú ÌååÏùº Í∞úÏàò
            this.uploadedFileSize = document.getElementById('uploadedFileSize'); // ÏóÖÎ°úÎìúÎêú ÌååÏùº Ïö©Îüâ
        },

        addEventListeners() {
            document.getElementById('pjtBgnDate').addEventListener('input', this.calculateDays.bind(this));
            document.getElementById('pjtEndDate').addEventListener('input', this.calculateDays.bind(this));

            // Ïã†Í∑úÏã†Ï≤≠ ÌõÑ Ï†ÄÏû•ÏùÄ Í∞úÏÑ§ÏöîÏ≤≠, Ï¢åÏ∏°ÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏ ÏÖÄÎ†âÌä∏ ÌõÑÏóêÎäî Ï†ÄÏû•
            this.newRequestButton.addEventListener('click', () => {
                if (this.saveRequestButton) {
                    this.saveRequestButton.textContent = "{{ message('btn.047') }}";
                }
            });

            // ÌååÏùº Î™©Î°ù Îã®Ïùº ÏÇ≠Ï†ú(x) Î≤ÑÌäº
            document.querySelectorAll('.file-item .remove-button').forEach(button => {
                button.addEventListener('click', (event) => this.removeFile(event));
            });

            // ÌååÏùºÏ≤®Î∂Ä Ï∞Ω
            this.addFileButton.addEventListener('click', () => this.fileInput.click());

            // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠
            this.attachArea = document.querySelector('.attach_area');
            this.attachArea.addEventListener('dragover', (event) => this.dragOver(event));
            this.attachArea.addEventListener('dragleave', () => this.dragLeave());
            this.attachArea.addEventListener('drop', (event) => this.handleDrop(event));

            this.saveRequestButton.addEventListener('click', (event) => this.saveRequest(event));   // Ï†ÄÏû•

            this.fileInput.addEventListener('change', () => this.updateFileListFromInput());    // ÌååÏùºÎ™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏

            this.newRequestButton.addEventListener('click', () => this.resetNewRequest());  // Ïã†Í∑úÏöîÏ≤≠

            this.removeAllButton.addEventListener('click', () => this.removeAllFiles());    // Î™®ÎëêÏÇ≠Ï†ú
        },

        // ÌååÏùº ÏÇ≠Ï†ú(Îã®Ïùº)
        removeFile(event) {
            const fileItem = event.target.parentElement;
            const fileNo = fileItem.getAttribute('data-file-no');
            const sno = fileItem.getAttribute('data-sno');

            this.allRemovedFiles.push({ fileNo, sno });
            fileItem.remove();
        },

        // ÌååÏùº ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠
        dragOver(event) {
            event.preventDefault();
            this.attachArea.classList.add('dragging');
        },
        dragLeave() {
            this.attachArea.classList.remove('dragging');
        },
        handleDrop(event) {
            event.preventDefault();
            this.attachArea.classList.remove('dragging');

            const newFiles = event.dataTransfer.files;
            if (newFiles.length > 0) {
                this.existingFiles = this.existingFiles.concat(newFiles); // Í∏∞Ï°¥ ÌååÏùº Î™©Î°ùÏóê ÏÉà ÌååÏùº Ï∂îÍ∞Ä
                this.updateFileList(newFiles);
            }
        },

        // Ï†ÄÏû•
        saveRequest(event) {
            event.preventDefault();

            // ÏóÖÎ°úÎìú Ïö©ÎüâÏù¥ 25MBÎ•º Ï¥àÍ≥ºÌñàÏùÑ Í≤ΩÏö∞ Í≤ΩÍ≥† Î©îÏãúÏßÄ ÌëúÏãú
            if (this.totalFileSize > this.maxTotalFileSize) {
                gaiaCommon.customAlert("{{ message('msg.app.012') }}".replace('{0}', 25));  // ÏóÖÎ°úÎìú Ïö©Îüâ 25MBÏùÑ(Î•º) Ï¥àÍ≥ºÌïòÏòÄÏäµÎãàÎã§.
                return;
            }

            // Ïã†Í∑úÏã†Ï≤≠ -> Í∞úÏÑ§ÏöîÏ≤≠ÏùºÎïåÎßå Î©îÏùº Î∞úÏÜ°(ÏµúÏ¥àÎ°ú ÌòÑÏû•Í∞úÏÑ§ ÏãúÏóêÎßå)
            if (this.saveRequestButton.textContent === "{{ message('btn.047') }}") {
                this.saveProjectData()
                // this.sendMail(); // Ï†ÄÏû• ÏÑ±Í≥µ ÌõÑ Î©îÏùº Ï†ÑÏÜ°
            } else {
                this.saveProjectData()
            }
        },

        sendMail() {    // Î©îÏùº Ï†ÑÏÜ°
            fetch('/resource/mail/send/pjtInstall ', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include' // Ïø†ÌÇ§Î•º Ìï®Íªò Ï†ÑÏÜ°
            }).then((response) => {
                if (!response.ok) {
                    if (response.status === 403) {
                        alert(SESSION_EXPIRED_MSG);
                        location.reload('/');
                    }
                }
                response.json()
            });
        },

        updateFileListFromInput() { // 'ÌååÏùºÏ≤®Î∂Ä'Î°ú Ï≤®Î∂ÄÎêú ÌååÏùº Ï∂îÍ∞Ä
            const newFiles = this.fileInput.files;
            this.existingFiles = this.existingFiles.concat(newFiles);
            if (newFiles.length > 0) {
                this.updateFileList(newFiles);
            }
        },

        resetNewRequest() { // 'Ïã†Í∑úÏã†Ï≤≠'
            this.newRequestForm.reset();
            document.getElementById('cnstwkDaynum').value = '';
            this.clearFileList();
            this.uploadedFileSize.textContent = '0 KB';
            this.uploadedFileCount.textContent = '0';
            this.currentProjectNo = null;
            this.newRequestForm.classList.remove('readonly');
            this.saveRequestButton.style.display = 'block';
        },

        removeAllFiles() { // 'Î™®ÎëêÏÇ≠Ï†ú'
            const fileItems = document.querySelectorAll('.file_list .list_item');
            fileItems.forEach(fileItem => {
                const fileNo = fileItem.dataset.fileNo;
                const sno = fileItem.dataset.sno;
                this.allRemovedFiles.push({ fileNo, sno });

                if (!this.removedFiles[this.currentProjectNo]) {
                    this.removedFiles[this.currentProjectNo] = [];
                }
                this.removedFiles[this.currentProjectNo].push({ fileNo, sno });
            });
            this.updateFileSizeSummary();
            this.clearFileList();
            this.fileInput.value = '';
        },

        // ÌîÑÎ°úÏ†ùÌä∏ ÌÅ¥Î¶≠ Ïãú ÌååÏùº Î™©Î°ù Ï≤òÎ¶¨
        onProjectClick(project) {
            if (project.attachments) {
                this.processFetchedFiles(project.attachments);
            } else {
                this.clearFileList();
            }
            this.setCurrentProject(project.plcReqNo);
        },

        setCurrentProject(plcReqNo) { // Î™©Î°ùÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏ ÌÅ¥Î¶≠
            this.currentProjectNo = plcReqNo;
            if (!this.removedFiles[this.currentProjectNo]) {
                this.removedFiles[this.currentProjectNo] = [];
            }
            console.log(this.removedFiles)
        },

        processFetchedFiles(attachments) {   // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ ÌååÏùº Ï†ïÎ≥¥ Ï≤òÎ¶¨
            const files = attachments.map(file => ({
                name: file.fileNm,
                size: file.fileSize,
                fileNo: file.fileNo,
                sno: file.sno
            }));

            this.updateFileList(files);
        },

        clearFileList() {  // ÌååÏùº Î™©Î°ù Ï¥àÍ∏∞Ìôî
            this.fileList.innerHTML = '';
            this.totalFileSize = 0;
            this.successfulFileCount = 0;
            this.failedFileCounts = 0;
            this.existingFiles = [];
            this.updateFileSizeSummary();
            this.updateFileCount();
            this.updateFailedFileCount();

            // ÌååÏùº Î™©Î°ùÏù¥ ÎπÑÏóàÏùÑ Îïå Î©îÏãúÏßÄ ÌëúÏãú
            const dataInfo = document.querySelector('.data_info');
            const attachList = document.querySelector('.attach_list');

            if (this.fileList.querySelectorAll('.list_item').length === 0) {
                dataInfo.classList.remove('hide');
                attachList.classList.add('hide');
            }
        },

        removeFileFromProject(fileNo, sno) {   // ÌååÏùº ÏÇ≠Ï†ú Ï≤òÎ¶¨ Ìï®Ïàò
            if (!this.removedFiles[this.currentProjectNo]) {
                this.removedFiles[this.currentProjectNo] = [];
            }
            this.removedFiles[this.currentProjectNo].push({ fileNo, sno });
            console.log("removeFileFromProject", this.removedFiles)
        },

        updateFileSizeSummary() {  // ÌååÏùº ÌÅ¨Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            const totalSizeText = this.formatFileSize(this.totalFileSize);
            document.getElementById('uploadedFileSize').textContent = `${totalSizeText}`;
        },

        formatFileSize(size) { // ÌååÏùº ÌÅ¨Í∏∞ Ìè¨Îß∑ÌåÖ
            if (size >= 1024 * 1024) {
                return (size / (1024 * 1024)).toFixed(2) + ' MB';
            } else if (size >= 1024) {
                return (size / 1024).toFixed(2) + ' KB';
            } else {
                return size + ' bytes';
            }
        },

        updateFileList(files) { // ÌååÏùº Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
            const existingFileNames = this.existingFiles.map(file => file.name);
            const fileListElement = document.getElementById('fileList');
            const dataInfo = document.querySelector('.data_info');
            const attachList = document.querySelector('.attach_list');
            this.totalFileSize = this.existingFiles.reduce((sum, file) => sum + (file.size || 0), 0);

            if (files.length === 0 && this.existingFiles.length === 0) {
                dataInfo.classList.remove('hide');
                attachList.classList.add('hide');
            } else {
                dataInfo.classList.add('hide');
                attachList.classList.remove('hide');

                const allFiles = [...this.existingFiles, ...files];

                allFiles.forEach(file => {
                    if (!existingFileNames.includes(file.name)) {
                        const fileItem = this.createFileItem(file, fileListElement);
                        this.handleFileItemClick(fileItem, file, fileListElement, dataInfo, attachList);
                    }
                });

                this.updateFileCount();
                this.updateFailedFileCount();
            }
        },

        createFileItem(file, fileListElement) {
            const fileItem = document.createElement('li');
            fileItem.classList.add('list_item');
            fileItem.dataset.filename = file.name;
            fileItem.dataset.fileNo = file.fileNo || '';
            fileItem.dataset.sno = file.sno || '';

            const fileName = document.createElement('span');
            fileName.classList.add('f_name');
            fileName.textContent = file.name;

            const fileSizeText = this.formatFileSize(file.size);
            const fileSize = document.createElement('span');
            fileSize.classList.add('f_capacity');
            fileSize.textContent = fileSizeText;

            const progressContainer = document.createElement('span');
            progressContainer.classList.add('f_progress');

            const progress = document.createElement('span');
            progress.classList.add('progress');

            const successIndicator = document.createElement('span');
            successIndicator.classList.add(file.size > this.maxTotalFileSize ? 'fail' : 'sucess');
            successIndicator.innerHTML = file.size > this.maxTotalFileSize ? '<i class="ic ic-close"></i>' : '<i class="ic ic-check"></i>';

            if (file.size > this.maxTotalFileSize) {
                progress.innerHTML = `<span class="bar" style="width: 100%;"></span>`;
                progress.classList.add('fail');
                this.failedFileCounts++;
            } else {
                progress.innerHTML = `<span class="bar" style="width: 0%;"></span>`;
                progress.classList.add('ing');
            }

            progressContainer.appendChild(progress);
            progressContainer.appendChild(successIndicator);

            fileItem.appendChild(this.createRemoveButton(file, fileListElement));
            fileItem.appendChild(fileName);
            fileItem.appendChild(progressContainer);
            fileItem.appendChild(fileSize);

            fileListElement.appendChild(fileItem);
            this.totalFileSize += file.size;
            this.updateFileSizeSummary();

            if (file.size <= this.maxTotalFileSize) {
                this.successfulFileCount++;
                this.existingFiles.push(file);
                this.uploadFile(file, fileItem);
            }

            return fileItem;
        },

        createRemoveButton(file, fileListElement) {
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.classList.add('icon_btn');
            removeButton.innerHTML = '<i class="ic ic-close"></i><span class="blind">ÏÇ≠Ï†ú</span>';

            if (this.currentProject && this.currentProject.openPstats !== '0701') {
                removeButton.style.visibility = 'hidden';
            }

            return removeButton;
        },

        handleFileItemClick(fileItem, file, fileListElement, dataInfo, attachList) {
            const removeButton = fileItem.querySelector('.icon_btn');
            removeButton.addEventListener('click', () => {
                this.removeFileFromProject(file.fileNo, file.sno);
                fileItem.remove();
                this.totalFileSize -= file.size;
                this.updateFileSizeSummary();

                if (file.size <= this.maxTotalFileSize) {
                    this.successfulFileCount--;
                    this.updateFileCount();
                } else {
                    this.failedFileCounts--;
                    this.updateFailedFileCount();
                }

                this.existingFiles = this.existingFiles.filter(f => f.fileNo !== file.fileNo || f.sno !== file.sno);

                if (fileListElement.querySelectorAll('.list_item').length === 0) {
                    dataInfo.classList.remove('hide');
                    attachList.classList.add('hide');
                }
                document.querySelector('#fileInput').value = '';
            });
        },

        updateFileCount() { // ÌååÏùº Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
            const uploadedFileCountElement = document.getElementById('uploadedFileCount');
            uploadedFileCountElement.textContent = this.successfulFileCount > 0 ? this.successfulFileCount : '0';
        },

        updateFailedFileCount(failedCount) { // Ïã§Ìå®Ìïú ÌååÏùº Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
            const failedFileCountElement = document.getElementById('failedFileCount');
            failedFileCountElement.textContent = this.failedFileCounts > 0 ? this.failedFileCounts : '0';
        },

        uploadFile(file, fileItem) { // ÌååÏùº ÏóÖÎ°úÎìú ÏÉÅÌÉú ÌôïÏù∏
            const formData = new FormData();
            formData.append('file', file);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    this.updateProgress(file.name, percentComplete, fileItem);
                }
            };
            xhr.onload = () => {
                this.updateProgress(file.name, xhr.status === 200 ? 100 : 0, fileItem, xhr.status === 200);
            };
            xhr.onerror = () => {
                this.updateProgress(file.name, 0, fileItem, false);
            };
            xhr.send(formData);
        },

        updateProgress(fileName, percent, fileItem, success = true) { // ÌååÏùº ÏóÖÎ°úÎìú ÏÉÅÌÉúÎ∞î
            const progressBar = fileItem.querySelector('.progress .bar');
            const progressContainer = fileItem.querySelector('.progress');
            const successIndicator = fileItem.querySelector('.sucess');
            progressBar.style.width = percent + '%';

            if (percent === 100) {
                progressBar.style.display = 'none';
                progressContainer.classList.remove('ing');
                successIndicator.classList.remove('hide');
                successIndicator.classList.add(success ? 'sucess' : 'fail');
                successIndicator.innerHTML = success ? '<i class="ic ic-check"></i>' : '<i class="ic ic-close"></i>';
            } else {
                progressBar.style.display = 'block';
                successIndicator.classList.add('hide');
                progressBar.classList.add('ing');
            }
        },

        formatFileSize(size) { // ÌååÏùº ÌÅ¨Í∏∞ Ìè¨Îß∑
            return size < 1024 ? `${size} bytes` : size < 1048576 ? `${(size / 1024).toFixed(2)} KB` : `${(size / 1048576).toFixed(2)} MB`;
        },

        // ÎÇ†Ïßú ÌòïÏãù Î≥ÄÍ≤Ω
        formatDateString(dateString) {
            if (!dateString) return '';
            const year = dateString.substring(0, 4);
            const month = dateString.substring(4, 6);
            const day = dateString.substring(6, 8);
            return `${year}-${month}-${day}`;
        },
        convertToCompactDate(dateString) {
            if (!dateString) return '';

            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!regex.test(dateString)) {
                throw new Error('Invalid date format. Expected format: YYYY-MM-DD');
            }
            const year = dateString.substring(0, 4);
            const month = dateString.substring(5, 7);
            const day = dateString.substring(8, 10);

            return `${year}${month}${day}`;
        },

        calculateDays() {  // ÎÇ†Ïßú Í≥ÑÏÇ∞
            const pjtBgnDate = document.getElementById('pjtBgnDate').value;
            const pjtEndDate = document.getElementById('pjtEndDate').value;

            if (pjtBgnDate && pjtEndDate) {
                const start = new Date(pjtBgnDate);
                const end = new Date(pjtEndDate);
                if (start > end) {
                    gaiaCommon.customAlert("{{ message('msg.pinstall.001') }}"); // ÏãúÏûë ÎÇ†ÏßúÍ∞Ä Ï¢ÖÎ£å ÎÇ†ÏßúÎ≥¥Îã§ Îä¶ÏäµÎãàÎã§.
                    document.getElementById('pjtBgnDate').value = '';
                    document.getElementById('pjtEndDate').value = '';
                    document.getElementById('cnstwkDaynum').value = '';
                    return;
                }
                const timeDiff = end - start;
                const dayDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('cnstwkDaynum').value = dayDiff;
            }
        },
        // ÌòÑÏû• Í∞úÏÑ§ Î™©Î°ù
        fetchProjects() {
            gaiaCommon.get('/api/project/get/pjt-list', '', function(data){
                const projects = data.details.projectList;
                const projectList = document.getElementById('projectList');
                console.log(projects);

                if (Array.isArray(projects)) {
                    projectList.innerHTML = '';

                    projects.forEach(function (project) {
                        const listItem = document.createElement('li');
                        listItem.className = 'list_item';

                        const statusSpan = document.createElement('span');
                        statusSpan.className = 'label ' + page.getStatusClass(project.openPstats);
                        statusSpan.textContent = project.openPstatsNm;

                        const titleStrong = document.createElement('strong');
                        titleStrong.className = 'prj_tit';
                        titleStrong.textContent = gaiaCommon.decodeSafeText(project.plcNm);

                        const buttonDiv = document.createElement('div');
                        buttonDiv.style.display = 'flex';
                        buttonDiv.style.alignItems = 'center';

                        const cancelButton = document.createElement('button');
                        cancelButton.type = 'button';
                        cancelButton.className = 'btn _outline s_small';
                        cancelButton.textContent = "{{ message('btn.005') }}"; // 'Ï∑®ÏÜå'
                        cancelButton.addEventListener('click', function (event) {
                            event.stopPropagation();
                            page.deleteProject(project.plcReqNo);
                        }.bind(this));

                        if (project.openPstats !== '0701') {
                            cancelButton.style.visibility = 'hidden';
                        }

                        buttonDiv.appendChild(cancelButton);

                        const link = document.createElement('a');
                        link.href = '#';
                        link.appendChild(statusSpan);
                        link.appendChild(titleStrong);
                        link.appendChild(buttonDiv);

                        listItem.appendChild(link);

                        listItem.addEventListener('click', function () {
                            const allItems = projectList.querySelectorAll('.list_item');
                            allItems.forEach(item => item.classList.remove('active'));
                            listItem.classList.add('active');

                            page.loadProjectData(project.plcReqNo);
                            this.currentProject = project;

                            if (page.saveRequestButton) {
                                page.saveRequestButton.textContent = "{{ message('btn.006') }}";
                            }

                            if (project.openPstats !== '0701') {
                                document.getElementById('newRequestForm').classList.add('readonly');
                                page.saveRequestButton.style.display = 'none';
                            } else {
                                document.getElementById('newRequestForm').classList.remove('readonly');
                                page.saveRequestButton.style.display = 'block';
                            }
                        }.bind(this));

                        projectList.appendChild(listItem);
                    }.bind(this));
                }
            }, function(error){
                console.error('ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®:', error);
            })
        },


        getStatusClass(statusCode) {
            switch (statusCode) {
                case '0701':
                    return '_request';
                case '0702':
                    return '_success';
                case '0703':
                    return '_ing';
                default:
                    return '_default';  // '0704'
            }
        },


        // ÌòÑÏû• Í∞úÏÑ§ Ï∑®ÏÜå
        deleteProject(plcReqNo) {
            gaiaCommon.customConfirm("{{ message('item.pinstall.007') }}", "{{ message('item.pinstall.007') }}", "{{ message('msg.pinstall.002') }}?", () => {
                gaiaCommon.post(`/api/project/delete/${plcReqNo}`, '', function(result){
                    gaiaCommon.customAlert("{{ message('msg.043') }}"); // Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§
                    page.fetchProjects();
                    window.location.reload();
                })
            });
        },

        // ÌòÑÏû• Í∞úÏÑ§ Ï°∞Ìöå
        loadProjectData(plcReqNo) {
            gaiaCommon.get(`/api/project/get/${plcReqNo}`, '', function(data){
                page.currentProjectNo = plcReqNo;

                const projectInstall = data.details.projectInstall;
                const attachments = data.details.attachments || [];

                if (projectInstall) {
                    const fields = [
                        'plcNm', 'plcLctAdrsCntnts', 'pjtBgnDate', 'pjtEndDate',
                        'cnstwkDaynum', 'majorCnsttyCd', 'cntrctType', 'aprvlDate',
                        'mainFcltyCntnts', 'dminsttNm', 'ofclNm', 'email', 'telNo', 'rmk'
                    ];

                    fields.forEach(function (fieldId) {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            if (field.type === 'date') {
                                field.value = page.formatDateString(projectInstall[fieldId]);
                            } else {
                                field.value = projectInstall[fieldId] !== null ? gaiaCommon.decodeSafeText(projectInstall[fieldId]) : '';
                            }
                        }
                    }.bind(this)); // üîÅ this Ïú†ÏßÄ

                    // ÌååÏùº Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
                    const fileList = document.getElementById('fileList');
                    if (fileList) {
                        page.clearFileList(); // Í∏∞Ï°¥ ÌååÏùº Î™©Î°ù ÏßÄÏö∞Í∏∞
                        if (attachments.length > 0) {
                            page.processFetchedFiles(attachments); // ÏÉà ÌååÏùº Î™©Î°ù Ï∂îÍ∞Ä
                        } else {
                            page.updateFileSizeSummary(); // ÌååÏùº ÏÇ¨Ïù¥Ï¶à ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏
                            page.updateFileCount();       // ÌååÏùº Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
                        }
                    }

                    // ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ ÌëúÏãú
                    const newRequestForm = document.getElementById('newRequestForm');
                    if (newRequestForm) {
                        newRequestForm.style.display = 'block';
                    }

                    this.currentProjectNo = plcReqNo; // ÌòÑÏû¨ ÏàòÏ†ï Ï§ëÏù∏ ÌîÑÎ°úÏ†ùÌä∏ Î≤àÌò∏ ÏÑ§Ï†ï
                }
            }, function(error){
                console.error('ÌîÑÎ°úÏ†ùÌä∏ ÏÉÅÏÑ∏ Ï°∞Ìöå Ïã§Ìå®:', error);
            })
        },

        // ÏÖÄÎ†âÌä∏ Î∞ïÏä§Ïùò ÏÑ†ÌÉùÎêú Í∞íÏùÑ Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò
        getSelectedValue(containerId) {
            const selectBox = document.getElementById(containerId);
            return selectBox ? selectBox.value : '';
        },

        // ÏÖÄÎ†âÌä∏ Î∞ïÏä§Ïùò ÏÑ†ÌÉùÎêú ÌÖçÏä§Ìä∏Î•º Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò
        getSelectedText(containerId) {
            const selectBox = document.getElementById(containerId);
            return selectBox ? selectBox.options[selectBox.selectedIndex].text : '';
        },

        // ÌòÑÏû• Í∞úÏÑ§ Ï†ÄÏû•
        saveProjectData() {
            const plcNm = $('input[name="plcNm"]').val();
            if (!plcNm) {
                gaiaCommon.customAlert("{{ message('msg.023') }}");    // Í≥µÏÇ¨Î™ÖÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.
                return;
            }

            const formData = new FormData(newRequestForm);
            const selectBoxes = ['cntrctType', 'majorCnsttyCd'];
            selectBoxes.forEach(id => {
                formData.append(id, this.getSelectedValue(id));
            });

            // Ï†úÍ±∞Îêú ÌååÏùº Ï†ïÎ≥¥ Ï∂îÍ∞Ä
            if (this.currentProjectNo && this.removedFiles[this.currentProjectNo]) {
                this.removedFiles[this.currentProjectNo].forEach(file => {
                    formData.append('removedFiles[]', file.fileNo);
                    formData.append('removedSnos[]', file.sno);
                });
            }

            // ÌååÏùº Ï≤®Î∂Ä Ï∞ΩÏóêÏÑú ÏûêÎèôÏúºÎ°ú Ï∂îÍ∞ÄÎêú files ÌïÑÎìú Ï†úÍ±∞
            formData.delete('files');
            // Í∏∞Ï°¥ ÌååÏùº Î™©Î°ùÏù∏ existingFilesÎßå ÏàòÎèôÏúºÎ°ú formDataÏóê Ï∂îÍ∞Ä
            this.existingFiles.forEach(file => {
                formData.append('files', file);
            });

            const pattern = /^[A-Za-z0-9_\.\-]+@[A-Za-z0-9\-]+\.[A-za-z0-9\-]+/;
            const email = document.getElementById('email').value;

            if (email !== '' && !pattern.test(email)) {
                gaiaCommon.customAlert("{{ message('msg.030') }}");
                return false;
            }

            const jsonObject = {
                plcNm: document.getElementById('plcNm').value,
                plcLctAdrsCntnts: document.getElementById('plcLctAdrsCntnts').value,
                cnstwkDaynum: document.getElementById('cnstwkDaynum').value,
                majorCnsttyCd: this.getSelectedValue('majorCnsttyCd'),
                cntrctType: this.getSelectedValue('cntrctType'),
                pjtBgnDate: this.convertToCompactDate(document.getElementById('pjtBgnDate').value),
                pjtEndDate: this.convertToCompactDate(document.getElementById('pjtEndDate').value),
                aprvlDate: this.convertToCompactDate(document.getElementById('aprvlDate').value),
                mainFcltyCntnts: document.getElementById('mainFcltyCntnts').value,
                dminsttNm: document.getElementById('dminsttNm').value,
                ofclNm: document.getElementById('ofclNm').value,
                email: email,
                telNo: document.getElementById('telNo').value,
                rmk: document.getElementById('rmk').value
            };
            formData.append('projectData', new Blob([JSON.stringify(jsonObject)], { type: 'application/json' }));

            const url = this.currentProjectNo
                ? `/api/project/update/${this.currentProjectNo}` // ÏàòÏ†ï ÏöîÏ≤≠
                : '/api/project/create/pjt'; // Ïã†Í∑ú ÏÉùÏÑ± ÏöîÏ≤≠

            gaiaCommon.post(url, formData, function (response){
                if (page.currentProjectNo) {
                    gaiaCommon.customAlert("{{ message('msg.007') }}", function () {   // ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§
                        page.fetchProjects();
                        window.location.replace('/project/project_install');
                    });
                } else {
                    gaiaCommon.customAlert("{{ message('msg.044') }}", function () {   // ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§
                        page.fetchProjects();
                        window.location.replace('/project/project_install');
                    });
                }
            }, function (error){
                gaiaCommon.LoadingOverlay('body', false);
                gaiaCommon.customAlert('{{ message("msg.045") }}');	// Ï†ÄÏû•Ïóê Ïã§Ìå® ÌñàÏäµÎãàÎã§.
            })
        },

        // ÏÖÄÎ†âÌä∏ Î∞ïÏä§ Ìò∏Ï∂ú
        loadSelectBoxes() {
            const selectBoxes = [
                { cmnGrpCd: 'ce229e27-98c6-8c89-7be7-cbc27b0b1fc8', elementId: "selectBox1", selectBoxId: 'majorCnsttyCd' },
                { cmnGrpCd: '0575cf90-0d6a-4d96-a298-d252c8179c32', elementId: "selectBox2", selectBoxId: 'cntrctType' }
            ];

            selectBoxes.forEach(box => {
                this.makeSelectBox(box.cmnGrpCd, box.elementId, box.selectBoxId);
            });
        },

        makeSelectBox(cmnGrpCd, elementId, selectBoxId) {
            let requestData = {
                cmnGrpCd: cmnGrpCd,
                selectBoxId: selectBoxId,
                selectBoxNmType: "KOR",
                ckeckedValue: "",
                orderByCol: "",
                orderByType: "",
                initText: "=ÏÑ†ÌÉù=",
                paramNm: "selectBox",
                funName: "",
                funParam: "",
                funtype: "onchange",
            };

            gaiaCommon.post("/api/util/make-selectBox", [requestData], function(data){
                let returnMap = data.details.returnMap;
                let selectBoxElement = document.getElementById(elementId);
                selectBoxElement.innerHTML = returnMap["selectBox"];
            }, function(error,status){
                console.error("Error making select box:", status, error);
            })
        },
    };
</script>
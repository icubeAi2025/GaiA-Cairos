{% extends 'layout/base_content' %}
{% block content %}
<section class="contents_wrap g-row">

    <article class="conts g-row">
        <div class="group">
            <div class="conts_form" id="company-form">
                <div class="btn_area s_default _outline">
                    <button type="button" class="btn _outline" onclick="page.createCompany()">{{ message('btn.006') }}</button>
                    <!-- 저장 -->
                    <button type="button" class="btn" onclick="page.close()">{{ message('btn.007') }}</button>
                    <!-- 닫기 -->
                </div>

                <div class="form_box">
                    <div class="container" style="display: flex; align-items: center;">
                        <span class="caption">
                            <span><b class="c_red">*</b> {{ message('item.com.023') }}</span>
                        </span>
                    </div>
                    <!-- row -->
                    <div class="row cols2">
                        <div class="col">
                            <div class="form_label">{{ message('item.contract.009') }}</div> <!-- 공사계약명 -->
                            <div class="form_data">
                                <span id="cntrctNm"></span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label required">{{ message('item.org.004') }}</div> <!-- 공종 구분 -->
                            <div class="form_data">
                                <div class="selectbox" id="cnsttyCdTypeSelect">
                                    <div class="select_header">
                                        <span>{{ message('item.com.005') }}</span> <!-- 선택 -->
                                        <i class="ic ic-arrow-down"></i>
                                    </div>
                                    <ul class="list_sty dropdown_list checkbox_list" style="display: none;"
                                        id="contractType" tabindex="-1">

                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row cols2">
                        <div class="col">
                            <div class="form_label required">{{ message('item.org.010') }}</div> <!-- 사업자등록번호 -->
                            <div class="form_data">
                                <span class="item_wrap">
                                    <input type="text" class="form-control number maxlength" maxlength="10" id="bsnsmnNo" name="bsnsmnNo">
                                </span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label required">{{ message('item.contract.016') }}</div> <!-- 대표계약 회사명 -->
                            <div class="form_data">
                                <span class="item_wrap">
                                    <input type="hidden" name="corpNo" id="corpNo">
                                    <input type="text" class="maxlength" maxlength="100" name="corpNm" id="corpNm" readonly />
                                    <button type="button" class="btn icon_btn _fill search" onclick="popup.corpNmSearch()">
                                        <i class="ic ic-search"></i>
                                        <span class="blind">검색</span>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row">
                        <div class="col">
                            <div class="form_label">{{ message('item.contract.020') }}</div> <!-- 업체주소 -->
                            <div class="form_data">
                                <input type="text" id="corpAdrs" name="corpAdrs" class="maxlength" maxlength="200">
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row cols4">
                        <div class="col">
                            <div class="form_label">{{ message('item.contract.018') }}</div> <!-- 사무실번호 -->
                            <div class="form_data">
                                <input type="text" id="telNo" class="form-control maxlength telNo" maxlength="15" name="telNo">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">{{ message('item.contract.019') }}</div> <!-- 팩스번호 -->
                            <div class="form_data">
                                <input type="text" id="faxNo" name="faxNo" class="telNo maxlength" maxlength="15">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">{{ message('item.contract.017') }}</div> <!-- 업체 대표자 -->
                            <div class="form_data">
                                <input type="text" id="corpCeo" name="corpCeo" class="maxlength" maxlength="20">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">{{ message('item.org.005') }}</div> <!-- 담당자명 -->
                            <div class="form_data">
                                <span class="item_wrap">
                                    <input type="hidden" name="ofclId" id="ofclId">
                                    <input type="text" name="ofclNm" id="ofclNm" class="maxlength" maxlength="20" readonly>
                                    <button type="button" class="btn icon_btn _fill ofclNmSearchBtn" onclick="popup.ofclNmSearch()">
                                        <i class="ic ic-search"></i>
                                        <span class="blind">{{ message('btn.015') }}</span> <!-- 조회 -->
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row cols4">
                        <div class="col">
                            <div class="form_label">{{ message('item.contract.022') }}</div> <!-- 지분율 -->
                            <div class="form_data">
                                <span class="item_wrap put_txt _per">
                                    <input type="text" class="form-control maxlength decimal2 3" name="shreRate"
                                        maxlength="18">
                                </span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">{{ message('item.contract.023') }}</div> <!-- 대표 여부 -->
                            <div class="form_data">
                                <div class="item_group" role="group" aria-label="Basic radio group">
                                    <label class="form_check">
                                        <input type="checkbox" id="representativeCheck" name="useYn"
                                            class="check_mark" />
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </article>
</section>
<div id="popup" class="popup_overlay modal_base" style="display: none;">
    <!-- 모달창 내용 -->
</div>
{% endblock content %}
{% block footer_script %}
<style>
    .selectbox {
        position: relative;
        width: 100%;
        cursor: pointer;
    }

    .select_header {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .checkbox_list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        z-index: 1000;
        display: none;
    }

    .form_check {
        display: block;
        padding: 5px;
        margin-left: 0;
    }

    .focus-style {
		outline: 2px solid black;
		outline-offset: 2px;
		border-radius: 4px;
    }
</style>
<script>
    var selectedItems = [];
    const params = new URLSearchParams(window.location.search);
    const pjtNo = params.get('pjtNo');
    const cntrctNo = params.get('cntrctNo');

    $(function () {
        gaia.create({
            $init: function ($params) {
                page.initializeSelectBoxes();
                page.init();
            }
        });
    });

    var popup = {
        data: {},
        close: function () {
            $("#popup").html("");
        },
        add: function () {
            if (popup.data.ofclNm) {
                $("#ofclNm").val(popup.data.ofclNm);
                // 2025-06-10 담당자ID - Eureca 연동 mandatory 변경에따른 추가
                $('#ofclId').val(popup.data.ofclId);
            }
            if (popup.data.corpNm) {

                $("#corpNm").val(popup.data.corpNm);
                $('#corpNo').val(popup.data.corpNo);
                $('#corpAdrs').val(popup.data.compAdrs);
                $('#corpCeo').val(popup.data.corpCeo);
                $('#bsnsmnNo').val(popup.data.bsnsmnNo);
                $('#telNo').val(popup.data.compTelno);
                $('#faxNo').val(popup.data.compFaxno);

            }

            $("#popup").html("");
        },

        ofclNmSearch: function () {
            gaiaCommon.checkAuth("OFCL_SEARCH_03", () => {
                $("#popup").load("/project/ofclNmSearch");
                $("#popup").css({"display": "flex"});
            });
        },
        corpNmSearch: function () {
            gaiaCommon.checkAuth("CORP_SEARCH_03", () => {
                $("#popup").load(`/project/corpNmSearch?pjtNo=${pjtNo}&cntrctNo=${cntrctNo}`);
                $("#popup").css({"display": "flex"});
            });
        },
    }

    var page = {
        data: {},

        init: function () {
            // nav 주소 바꾸기
            const titleElement = document.querySelector('h3.conts_tit');
            var title;
            title = "{{ message('item.contract.021') }}"; // 계약 도급 추가

            gaiaPortal.navMenuInit('M010201', title);
            $("#menuDepth").append(`<li class=\"breadcrumb_item\" name=\"new_item\">${title}</li>`);
            
            page.loadCntrctNm();
        },

        // 공사 계약명 찾기
        loadCntrctNm: function () {
            gaiaCommon.get("/api/project/contractstatus/company/get/cntrctNm/" + cntrctNo, {}, function (result) {
                $('#cntrctNm').text(gaiaCommon.decodeSafeText(result.details.cntrctNm));
            });
        },
        // 도급 등록
        createCompany: function () {

            selectedItems = $('input[name="cnsttyCd"]:checked').map(function () {
                return $(this).val();
            }).get();

            const bsnsmnNo = $('input[name="bsnsmnNo"]').val();
            const corpNm = $('input[name="corpNm"]').val();

            if (selectedItems.length === 0) {
                gaiaCommon.customAlert("{{ message('msg.contract.014')}}"); // 공종을 선택해주세요.

                const $header = $('#cnsttyCdTypeSelect .select_header');
                $header.addClass('focus-style');

                setTimeout(() => {
                    $header.removeClass('focus-style');
                }, 1500);
                return;
            }
            if (!bsnsmnNo) {
                gaiaCommon.customAlert("{{ message('msg.contract.025') }}");    // 사업자등록번호를 입력해주세요.
                $('input[name="bsnsmnNo"]').focus();
                return;
            }
            if (!corpNm) {
                gaiaCommon.customAlert("{{ message('msg.contract.026') }}");    // 대표계약회사명을 입력해주세요.
                $('input[name="corpNm"]').focus();
                return;
            }

            const contractData = {
                cntrctNm: $('input[name="cntrctNm"]').val(),
                cnsttyCd: selectedItems.join(','),
                bsnsmnNo: $('input[name="bsnsmnNo"]').val(),
                corpNm: $('input[name="corpNm"]').val(),
                corpNo: $('input[name="corpNo"]').val(),
                telNo: $('input[name="telNo"]').val(),
                faxNo: $('input[name="faxNo"]').val(),
                corpAdrs: $('input[name="corpAdrs"]').val(),
                corpCeo: $('input[name="corpCeo"]').val(),
                shreRate: $('input[name="shreRate"]').val(),
                ofclNm: $('input[name="ofclNm"]').val(),
                ofclId: $('input[name="ofclId"]').val(),
                rprsYn: $('#representativeCheck').is(':checked') ? "Y" : "N",
                cntrctNo: cntrctNo
            };

            gaiaCommon.LoadingOverlay('body', true);
            gaiaCommon.post("/api/project/contractstatus/company/create", contractData, function (result) {
                gaiaCommon.customAlert("{{ message('msg.contract.018') }}", function () {  // 도급 등록이 완료되었습니다.
                    gaiaCommon.LoadingOverlay('body', false);
                    window.location.replace(`/project/contractstatus?pjtNo=${pjtNo}&cntrctNo=${cntrctNo}`);
                });
            },function (error) {
                gaiaCommon.LoadingOverlay('body', false);
                console.error(error);
                gaiaCommon.customAlert("{{ message('msg.api.001') }}");
            });
        },
        initializeSelectBoxes: function () {
            gaiaCommon.get("/api/project/contractstatus/company/types", '', function (result) {
                const checkboxList = $('#cnsttyCdTypeSelect .dropdown_list');
                checkboxList.empty();

                if (result.details && result.details.cnsttyCd) {
                    result.details.cnsttyCd.forEach(function (item) {
                        const checkbox = `
                    <li class="list_item">
                        <label class="form_check">
                            <input class="check_mark" type="checkbox" name="cnsttyCd" value="${item.cmn_cd}" />
                            <span class="check_label">${item.cmn_cd_nm_krn}</span>
                        </label>
                    </li>
                    `;
                        checkboxList.append(checkbox);
                    });
                }

                // 드롭다운 클릭 시 체크박스 목록 토글
                $('#cnsttyCdTypeSelect').on('click', function (event) {
                    event.stopPropagation();
                    checkboxList.toggle();
                });

                checkboxList.on('click', function (event) {
                    event.stopPropagation();
                });

                // 다른 화면 클릭 시 드롭박스 닫기
                $(document).on('click', function () {
                    checkboxList.hide();
                });

                // 체크박스 클릭 시 텍스트 업데이트
                checkboxList.on('click', 'input[name="cnsttyCd"]', function () {
                    page.updateSelectedItems();
                });
            },function (xhr, status, error) {
                console.error("Failed to fetch data:", status, error);
            })
        },

        updateSelectedItems: function () {
            selectedItems = $('input[name="cnsttyCd"]:checked').map(function () {
                return $(this).next('.check_label').text();
            }).get();

            const selectedCount = selectedItems.length;
            const headerText = selectedCount > 0
                ? selectedItems[0] + (selectedCount > 1 ? ` 외 ${selectedCount - 1}건` : '')
                : '선택';

            $('#cnsttyCdTypeSelect .select_header span').text(headerText);
        },

        close: function () {
            window.location.replace(`/project/contractstatus?pjtNo=${pjtNo}&cntrctNo=${cntrctNo}`);
        }
    };
</script>
{% endblock footer_script %}
{% extends 'layout/base_content' %} {% block content %}
<article class="conts g-row">
    <div class="group">
        <div class="conts_form">
            <div class="btn_area s_default _outline">
                {{ btnHtml | raw }}
                <button type="button" class="btn" id="close-popup" onclick="page.close()">
                    {{ message("btn.007") }}
                </button>
            </div>
            <form name="addForm" id="addForm">
                <div class="form_box">
                    <!-- row -->
                    <div class="row cols2">
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.003") }}
                            </div>
                            <div class="form_data" id="cntrctNm">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.004") }}
                            </div>
                            <div class="form_data" id="scontrctCcnsttyCdNm">
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row cols2">
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.005") }}
                            </div>
                            <div class="form_data" id="scontrctCntrctNo">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.006") }}
                            </div>
                            <div class="form_data" id="corpNm">
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row cols2">
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.009") }}
                            </div>
                            <div class="form_data" id="scontrctCorpBsnsmnNo">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.010") }}
                            </div>
                            <div class="form_data" id="scontrctCorpNm">
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row cols2">
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.018") }}
                            </div>
                            <div class="form_data" id="cntrctChgNo">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.027") }}
                            </div>
                            <div class="form_data" id="cntrctChgTypeNm">
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row cols2">
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.028") }}
                            </div>
                            <div class="form_data" id="chgApprDate">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.029") }}
                            </div>
                            <div class="form_data" id="cntrctChgDate">
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row cols2">
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.030") }}
                            </div>
                            <div class="form_data">
                                <span class="item_group">
                                    <span id="cntrctBgnDate"></span>
                                    <span class="_tilde">~</span>
                                    <span id="chgCbgnDate"></span>
                                </span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.031") }}
                            </div>
                            <div class="form_data">
                                <span class="put_txt _day" id="chgConPrd"></span>
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row cols2">
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.032") }}
                            </div>
                            <div class="form_data" id="fstCntrctAmt">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.033") }}
                            </div>
                            <div class="form_data" id="preCntrctAmt">
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row cols2">
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.034") }}
                            </div>
                            <div class="form_data" class="cost" id="cntrctAmt">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.035") }}
                            </div>
                            <div class="form_data" id="Amt">
                            </div>
                        </div>
                    </div>
                    <!-- row -->
                    <div class="row cols">
                        <div class="col">
                            <div class="form_label">
                                {{ message("item.sub.036") }}
                            </div>
                            <div class="form_data" id="rmrk">
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</article>
{% endblock content %} {% block footer_script %}
<script>
    const newWindowViewRenderer = window.NewWindowViewRenderer;

    const params = new URLSearchParams(window.location.search);
    let pjtNo;
    const cntrctNo = params.get("cntrctNo");
    const scontrctCorpId = params.get("scontrctCorpId");
    const cntrctChgId = params.get("cntrctChgId");

    var page = {
        data: {
            init: ""
        },
        init() {
            pjtNo = pjtInfo.pjtNo;

            this.loadData(cntrctNo, scontrctCorpId, cntrctChgId);
            gaiaPortal.navMenuInit("M010202", "{{ message('item.sub.039') }}");
            $("#menuDepth").append(`<li class="breadcrumb_item">{{ message('item.sub.039') }}</li>`);
        },

        close: function () {
            sessionStorage.setItem('cntrctNo', cntrctNo);
            window.location.replace(`/project/subcontract?pjtNo=${pjtNo}&cntrctNo=${pjtInfo.cntrctNo}&scontrctCorpId=${scontrctCorpId}`);
        },

        enableInputs: function () {
            window.location.href = `/project/subcontract/changeUpdate?pjtNo=${pjtNo}&cntrctNo=${cntrctNo}&scontrctCorpId=${scontrctCorpId}&cntrctChgId=${cntrctChgId}`;
        },


        //데이터 출력
        loadData: function (cntrctNo, scontrctCorpId, cntrctChgId) {
            const url = "/api/project/subcontract/" + cntrctNo + "/" + scontrctCorpId + "/" + cntrctChgId;

            gaiaCommon.get(url, '', function (data) {
                let subcontractChange = data.details.subcontractChange;

                $("#cntrctChgNo").text(subcontractChange.cntrctChgNo);
                $("#cntrctChgTypeNm").text(gaiaCommon.decodeSafeText(subcontractChange.cntrctChgTypeNm));
                $("#chgApprDate").text(formatDate2(subcontractChange.chgApprDate));
                $("#cntrctChgDate").text(formatDate2(subcontractChange.cntrctChgDate));
                $("#chgCbgnDate").text(formatDate2(subcontractChange.chgCbgnDate));
                $("#chgConPrd").text(subcontractChange.chgConPrd);
                $("#cntrctAmt").text(addCommas(subcontractChange.cntrctAmt));
                $("#rmrk").text(gaiaCommon.decodeSafeText(subcontractChange.rmrk));

                $("#cntrctNm").text(gaiaCommon.decodeSafeText(subcontractChange.cntrctNm));
                $("#scontrctCcnsttyCdNm").text(gaiaCommon.decodeSafeText(subcontractChange.scontrctCcnsttyCdNm));
                $("#scontrctCntrctNo").text(gaiaCommon.decodeSafeText(subcontractChange.scontrctCntrctNo));
                $("#gcontrctCorpNo").text(gaiaCommon.decodeSafeText(subcontractChange.gcontrctCorpNo));
                $("#corpNm").text(gaiaCommon.decodeSafeText(subcontractChange.corpNm));
                $("#scontrctCorpBsnsmnNo").text(gaiaCommon.decodeSafeText(subcontractChange.scontrctCorpBsnsmnNo));
                $("#scontrctCorpNm").text(gaiaCommon.decodeSafeText(subcontractChange.scontrctCorpNm));
                $("#cntrctBgnDate").text(formatDate2(subcontractChange.cntrctBgnDate));
                $("#fstCntrctAmt").text(addCommas(subcontractChange.fstCntrctAmt));
                $("#preCntrctAmt").text(addCommas(subcontractChange.preCntrctAmt));

                Amt();
                console.log("subcontractChange",subcontractChange)
            }, function (xhr, status, error) {
                console.error("Error:", error);
            });
        },
    };

    document
        .getElementById("cntrctBgnDate")
        .addEventListener("change", calculateDays);
    document
        .getElementById("chgCbgnDate")
        .addEventListener("change", calculateDays);

    document.getElementById("cntrctAmt").addEventListener("change", Amt);

    // YYYYMMDD 형식으로 변환
    function formatDate(dateStr) {
        if (!dateStr) {
            return null;
        }
        const date = new Date(dateStr);
        const year = date.getFullYear();
        const month = ("0" + (date.getMonth() + 1)).slice(-2);
        const day = ("0" + date.getDate()).slice(-2);

        return year + month + day;
    }
    // YYYY-MM-DD 형식으로 변환
    function formatDate2(dateStr) {
        if (!dateStr) {
            return null;
        }
        const year = dateStr.slice(0, 4);
        const month = dateStr.slice(4, 6);
        const day = dateStr.slice(6, 8);
        return `${year}-${month}-${day}`;
    }

    //기간계산
    function calculateDays() {
        const bgnDate = document.getElementById("cntrctBgnDate").value;
        const endDate = document.getElementById("chgCbgnDate").value;

        if (bgnDate && endDate) {
            const start = new Date(bgnDate);
            const end = new Date(endDate);

            if (end < start) {
                gaiaCommon.customAlert("{{ message('msg.027') }}");
                // 입력 필드 값 초기화
                document.getElementById("chgCbgnDate").value = "";
                document.getElementById("cnstwkDaynum").value = "";
                return;
            }

            const timeDiff = end - start;
            const dayDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            document.getElementById("chgConPrd").value = dayDiff + 1;
        }
    }

    // 변경 차액 계산
    function Amt() {
        const preCntrctAmt =
            removeCommas(document.getElementById("preCntrctAmt").textContent) || 0;
        const cntrctAmt =
            removeCommas(document.getElementById("cntrctAmt").textContent) || 0;
        const Amt = preCntrctAmt - cntrctAmt; // A-B

        if (Amt < 0) {
            $('#Amt').css('color', 'red');
        } else {
            $('#Amt').css('color', 'blue');
        }

        $('#Amt').text(Amt === 0 ? "0" : addCommas(Amt));
    }

    $(function () {
        gaia.create({
            $init: function ($params) {
                page.init();

                gaia.loaded = true
            }
        });
    })
</script>
{% endblock footer_script %}
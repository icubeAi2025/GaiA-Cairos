{% extends 'layout/base_content' %}
{% block content %}
    <section class="contents_wrap g-row">
        <article class="conts g-row">
            <div class="group">
                <div class="conts_grid">
                    <div class="btn_area s_default">
                        {{ btnHtml | raw }}
                        <button type="button" class="btn _outline" id="cancel">{{ message("btn.007") }}</button>
                    </div>
                </div>
            </div>

            <!-- Activity ëª©ë¡ -->
            <div class="group" id="inputChgTomorrowForm">
                <div class="conts_grid">
                    <h4 class="conts_s-tit">Activity {{ message("item.com.066") }}</h4>
                    <div class="search_wrap">
                        <!-- S: search wrap ---------------------------------------------- -->
                        <input type="date" id="sDate" class="date w-md">
                        <span class="_tilde">~</span>
                        <input type="date" id="eDate" class="date w-md">

                        <!-- searchbox -->
                        <div class="searchbox_wrap">
                            <input type="text" id="searchText" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                            <button type="submit" class="icon_btn search">
                                <i class="ic ic-search"></i>
                                <span class="blind">ê²€ìƒ‰</span>
                            </button>
                        </div>
                    </div>
                    <!-- // E: search wrap ---------------------------------------------- -->
                    <div class="grid" id="activityGrid"></div>
                </div>
            </div>

            <!-- ëª…ì¼ ê³„íš -->
            <div class="group">
                <div class="s_conts">
                    <span class="tree_route">ëª…ì¼ ê³„íš Activity</span>
                    <div class="conts_grid">
                        <h4 class="conts_s-tit">ëª…ì¼ ê³„íš Activity</h4>
                        <!-- ëª…ì¼ ì•¡í‹°ë¹„í‹° -->
                        <div class="btn_area s_default">
                            <button type="button" class="btn _outline" id="deleteActivity">ì‚­ì œ</button>
                        </div>
                        <div class="grid" id="tomorrowGrid"></div>
                    </div>
=
                </div>
            </div>

        </article>
    </section>
{% include "page/construction/dailyreport/dailyreport_qdb" %}
{% include 'sub/grid' %}
    <link rel="stylesheet" href="/assets/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/content.css" />
{% endblock content %}
{% block footer_script %}
    <script src="/assets/js/construction/construction.js"></script>
    <style>
        #activityGrid .tui-grid-cell[data-column-name="actions_add"]{
          text-align:center;
          overflow:visible;
          padding:0;
        }

        /* ì „ì—­ float/right ë¬´ë ¥í™” + ê°€ìš´ë° ë°°ì¹˜ìš© inline-flex */
        #activityGrid .tui-grid-cell[data-column-name="actions_add"] .icon_btn.more{
          float:none !important;
          transform:none !important;
          position:static !important;
          display:inline-flex;
          align-items:center;
          justify-content:center;
          margin:0;
          cursor: pointer;
        }
        .more::after {
            content: none;
        }
        .selectbox {
            width:100px;
            position:relative;
            margin-right: 5px;
        }
    </style>
    <script src="/assets/js/construction/construction.js"></script>
    <script src="/assets/js/grid.js"></script>
    <script>
        var urlParams = new URLSearchParams(location.search);
        var cntrctNo = urlParams.get('cntrctNo');
        var rId = urlParams.get('rId');
        var drDt = urlParams.get('drDt');

        // ìˆœìˆ˜ number ë¦¬í„´
        function N(v){ if(v==null||v==='') return 0; const n=Number(String(v).replace(/,/g,'')); return isFinite(n)?n:0; }


        // ===== Activity Grid =====
        const activityGrid = new tui.Grid({
            el: document.getElementById('activityGrid'),
            bodyHeight: 250,
            scrollX: true,
            scrollY: true,
            rowHeaders: [],
            columnOptions: { resizable: true },
            header: {
                height: 80,
                complexColumns: [
                    {
                        header: 'ê³„íš',
                        name: 'plan',
                        childNames: ['plan_start', 'plan_finish']
                    }
                ],
            },
            columns: [
                 {
                    header: ' ',
                    name: 'actions_add',
                    width: 70,
                    align: 'center',
                    renderer: {
                        type: window.IconRenderer,
                        options: [
                            {
                                type: 'plus',
                                success: (rowData) => {
                                    const rowKey = rowData?.rowKey;
                                    const row = activityGrid.getRow(rowKey);
                                    if (!row) return;

                                    // plan_reqre_daynum ê³„ì‚° (ì¢…ë£Œì¼ - ì‹œì‘ì¼ + 1)
                                    const planStart = new Date(row.plan_start);
                                    const planFinish = new Date(row.plan_finish);
                                    const planReqreDaynum = !isNaN(planStart) && !isNaN(planFinish)
                                        ? Math.floor((planFinish - planStart) / (1000 * 60 * 60 * 24)) + 1
                                        : 0;

                                    // actual_reqre_daynum
                                    let actualReqreDaynum = 0;
                                    if (row.actual_bgn_date && row.actual_end_date) {
                                        const diff = Math.floor(
                                            (new Date(row.actual_end_date) - new Date(row.actual_bgn_date)) / (1000 * 60 * 60 * 24)
                                        ) + 1;
                                        actualReqreDaynum = diff > 0 ? diff : 0;
                                    }

                                    // today_bohal ê³„ì‚° (100 / (plan_finish - actual_bgn_date || plan_start))
                                    const actualStart = row.actual_bgn_date || row.plan_start;
                                    const dateDiff = (d1, d2) =>
                                        Math.max(Math.floor((new Date(d2) - new Date(d1)) / (1000 * 60 * 60 * 24)), 0) + 1;
                                    const todayBohal =
                                        planFinish && actualStart
                                        ? (100 / dateDiff(actualStart, planFinish)).toFixed(2)
                                        : 0;

                                    // tomorrowGridì— Activity ì¶”ê°€
                                    const newRow = {
                                        path_nm: row.path_nm,
                                        activity_id: row.activity_id,
                                        activity_nm: row.activity_nm,
                                        plan_start: row.plan_start,
                                        plan_finish: row.plan_finish,
                                        plan_reqre_daynum: planReqreDaynum,
                                        actual_bgn_date: row.actual_bgn_date,
                                        actual_end_date: row.actual_end_date,
                                        actual_reqre_daynum: actualReqreDaynum,
                                        today_bohal: Number(todayBohal),
                                        total_progress: row.ori_total_progress || 0,
                                        ori_total_progress: row.ori_total_progress || 0,
                                        expt_cost: row.expt_cost || 0
                                    };

                                    // â˜… ìƒíƒœ ìë™ ì„¸íŒ…
                                    const [rowWithStars] = setStatusStars([newRow]);
                                    tomorrowGrid.appendRow(rowWithStars);

                                    // activityGridì—ì„œ ì‚­ì œ
                                    activityGrid.removeRow(rowKey);

                                    // ìµœì‹  tomorrowGrid ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ìì› ì¡°íšŒ
                                    const tomorrowData = tomorrowGrid.getData();
                                    if (tomorrowData && tomorrowData.length > 0) {
                                        initResourceData(tomorrowData);
                                    } else {
                                        // ìì› ëª©ë¡ ì´ˆê¸°í™”
                                        resetResourceList();
                                    }
                                }
                            }
                        ]
                    }
                },
                { header: 'WBS', name: 'path_nm', align:'center' },
                { header: 'Activity ID', name: 'activity_id', width: 365, align:'center' },
                { header: 'Activity ëª…', name: 'activity_nm', width: 365, align:'left' },
                { header: 'ê³„íš ê¸ˆì•¡', name: 'expt_cost', width: 365, align:'right' },
                { header: 'ê³„íš ì‹œì‘ì¼', name: 'plan_start', width: 180, align:'center' },
                { header: 'ê³„íš ì¢…ë£Œì¼', name: 'plan_finish', width: 180, align:'center' },
                { header: 'actual_bgn_date', name: 'actual_bgn_date', hidden: true },
                { header: 'actual_end_date', name: 'actual_end_date', hidden: true },
                { header: 'ori_total_progress', name: 'ori_total_progress', hidden: true }
            ],
            data: []
        });

        // ===== Tomorrow Grid (complex header) =====
        class StatusStarRenderer {
            constructor(props) {
                this.el = document.createElement('div');
                this.el.style.cursor = 'pointer';
                this.el.style.fontSize = '20px';
                this.el.style.textAlign = 'center';
                this.el.style.userSelect = 'none';

                this.render(props);

                this.el.addEventListener('click', () => {
                    const grid = props.grid;
                    const rowKey = props.rowKey;
                    const name = props.columnInfo.name;
                    const currentVal = grid.getValue(rowKey, name);
                    const nextVal = !currentVal;
                    const row = grid.getRow(rowKey);
                    if (!row) return;

                    let newBgn = row.actual_bgn_date || '';
                    let newEnd = row.actual_end_date || '';

                    // ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
                    ['bgn', 'ing', 'end'].forEach(col => grid.setValue(rowKey, col, false, false));

                    if (nextVal) {
                        // í´ë¦­í•œ ìƒíƒœë§Œ true
                        grid.setValue(rowKey, name, true, false);

                        if (name === 'bgn') {
                            // ì‹œì‘
                            newBgn = drDt;
                            newEnd = '';
                        }
                        else if (name === 'ing') {
                            // ì§„í–‰ì¤‘: ì‹œì‘ì¼ ì—†ìœ¼ë©´ drDt ì„¸íŒ…
                            if (!newBgn) newBgn = drDt;
                            newEnd = '';
                        }
                        else if (name === 'end') {
                            // ì¢…ë£Œ: ì‹œì‘ì¼ ì—†ìœ¼ë©´ drDt, ì¢…ë£Œì¼ì€ ë¬´ì¡°ê±´ drDt
                            if (!newBgn) newBgn = drDt;
                            newEnd = drDt;
                        }
                    } else {
                        // í•´ì œ ë¡œì§
                        if (name === 'bgn') {
                            newBgn = '';
                        }
                        if (name === 'end') {
                            newEnd = '';
                        }
                    }

                    // ë‚ ì§œ ë™ê¸°í™”
                    grid.setValue(rowKey, 'actual_bgn_date', newBgn, false);
                    grid.setValue(rowKey, 'actual_end_date', newEnd, false);

                    // ë‚´ë¶€ ë°ì´í„°ì—ë„ ë°˜ì˜
                    row.actual_bgn_date = newBgn;
                    row.actual_end_date = newEnd;
                    row.bgn = grid.getValue(rowKey, 'bgn');
                    row.ing = grid.getValue(rowKey, 'ing');
                    row.end = grid.getValue(rowKey, 'end');

                    grid.refreshLayout();
                });
            }

            getElement() {
                return this.el;
            }

            render(props) {
                const value = props.value === true;
                this.el.style.color = value ? '#333' : '#ccc';
                this.el.textContent = value ? 'â˜…' : 'â˜†';
            }
        }

        const tomorrowGrid = new tui.Grid({
            el: document.getElementById('tomorrowGrid'),
            bodyHeight: 250,
            scrollX: true,
            scrollY: true,
            rowHeaders: [],
            columnOptions: { resizable: true },
            rowHeaders: [
                {
                    type: 'checkbox',
                    width: 70,
                    renderer: {
                        type: window.IconRenderer,
                        options: [
                            { type: 'checkBox' },
                            {
                                type: 'trash',
                                success: (rowData) => {
                                    const rowKey = rowData?.rowKey;
                                    if (rowKey == null) return;

                                    const row = tomorrowGrid.getRow(rowKey);
                                    if (!row) return;

                                    // activityGridì— ë³µê·€
                                    const exists = activityGrid.getData().some(r => r.activity_id === row.activity_id);
                                    if (!exists) {
                                        activityGrid.appendRow({
                                            path_nm: row.path_nm,
                                            activity_id: row.activity_id,
                                            activity_nm: row.activity_nm,
                                            expt_cost: row.expt_cost || 0,
                                            plan_start: row.plan_start,
                                            plan_finish: row.plan_finish,
                                            plan_reqre_daynum: row.plan_reqre_daynum,
                                            actual_bgn_date: row.actual_bgn_date,
                                            actual_end_date: row.actual_end_date,
                                            ori_total_progress: row.ori_total_progress
                                        });
                                    }

                                    tomorrowGrid.removeRow(rowKey);

                                    // ìµœì‹  tomorrowGrid ê¸°ì¤€ ìì› ì¬ì¡°íšŒ
                                    const tomorrowData = tomorrowGrid.getData();
                                    if (tomorrowData && tomorrowData.length > 0) {
                                        initResourceData(tomorrowData);
                                    } else {
                                        // ìì› ëª©ë¡ ì´ˆê¸°í™”
                                        resetResourceList();
                                    }
                                }
                            }
                        ]
                      }
                },
            ],
            header: {
                height: 80,
                complexColumns: [
                    { header: 'ê³„íš', name: 'plan', childNames: ['plan_start', 'plan_finish', 'plan_reqre_daynum'] },
                    { header: 'ê¸ˆì¼ì‹¤í–‰', name: 'actual', childNames: ['actual_bgn_date', 'actual_end_date', 'actual_reqre_daynum'] },
                    { header: 'ìƒíƒœ', name: 'status', childNames: ['bgn', 'ing', 'end'] }
                ],
            },
            columns: [
                { header:'WBS', name:'path_nm' , width: 140,},
                {
                    header: 'Activity ID',
                    name: 'activity_id',
                    width: 120,
                    align: 'center',
                    renderer: {
                        type: window.IconRenderer,
                        options: [
                            { type: 'eyes',   success: (rowData) => openQdbModal(rowData) }
                        ]
                    }
                },
                { header:'Activity ëª…', name:'activity_nm', width:200 },
                { header:'ì‹œì‘ì¼', name:'plan_start',align:'center', width: 100, },
                { header:'ì¢…ë£Œì¼', name:'plan_finish',align:'center', width: 100, },
                { header:'ì†Œìš”ì¼ìˆ˜', name:'plan_reqre_daynum',align:'center', },
                {
                    header: 'ì‹œì‘ì¼',
                    name: 'actual_bgn_date',
                    align: 'center',
                    width: 100,
                    formatter: ({ row }) => {
                        // bgn ë˜ëŠ” ing, end ì¤‘ í•˜ë‚˜ë¼ë„ trueë©´ ë‚ ì§œ í‘œì‹œ
                        if (row.bgn || row.ing || row.end) {
                          return row.actual_bgn_date || drDt;
                        }
                        // ëª¨ë“  ìƒíƒœ falseë©´ ë¹ˆê°’
                        return '';
                      }
                },
                { header:'ì¢…ë£Œì¼', name:'actual_end_date',align:'center', width: 100,},
                { header:'ì†Œìš”ì¼ìˆ˜', name:'actual_reqre_daynum',align:'center',  },
                { header:'ì‹œì‘', name:'bgn', align:'center', renderer:{ type: StatusStarRenderer } },
                { header:'ì§„í–‰', name:'ing', align:'center', renderer:{ type: StatusStarRenderer } },
                { header:'ì¢…ë£Œ', name:'end', align:'center', renderer:{ type: StatusStarRenderer } },
                {
                    header: 'ë³´í• (%)',
                    name: 'today_bohal',
                    width: 150,
                    align: 'center'
                },
                { header: 'ori_total_progress', name: 'ori_total_progress', hidden: true },
                { header: 'expt_cost', name: 'expt_cost', hidden: true }
            ],
            data: []
        });

        // ì‚­ì œ ë²„íŠ¼
        $('#deleteActivity').on('click', function () {
            const checkedRows = tomorrowGrid.getCheckedRows();

            if (checkedRows.length === 0) {
                gaiaCommon.customAlert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            checkedRows.forEach(row => {
                const exists = activityGrid.getData().some(r => r.activity_id === row.activity_id);
                if (!exists) {
                    activityGrid.appendRow({
                    path_nm: row.path_nm,
                    activity_id: row.activity_id,
                    activity_nm: row.activity_nm,
                    expt_cost: row.expt_cost || 0,
                    plan_start: row.plan_start,
                    plan_finish: row.plan_finish,
                    plan_reqre_daynum: row.plan_reqre_daynum,
                    actual_bgn_date: row.actual_bgn_date,
                    actual_end_date: row.actual_end_date,
                    ori_total_progress: row.ori_total_progress || 0});
                }

                // tomorrowGridì—ì„œ ì‚­ì œ
                tomorrowGrid.removeRow(row.rowKey);
            });

            gaiaCommon.customAlert('ì„ íƒëœ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        });

        // ì´ˆê¸° ë°ì´í„° ì„¸íŒ… ë¡œì§ ì˜ˆì‹œ
        // ì‹œì‘: ê³„íšì‹œì‘(plan) ì¡´ì¬, ê¸ˆì¼ì‹œì‘(actual) ë¯¸ì¡´ì¬
        // ì§„í–‰: ê¸ˆì¼ì‹œì‘ ì¡´ì¬, ê¸ˆì¼ì¢…ë£Œ ë¯¸ì¡´ì¬
        // ì¢…ë£Œ: ê¸ˆì¼ì¢…ë£Œ ì¡´ì¬
        function setStatusStars(data) {
            return data.map(row => {
                const hasPlanStart = !!row.plan_start;
                const hasActualBgn = !!row.actual_bgn_date;
                const hasActualEnd = !!row.actual_end_date;

                let bgn = false, ing = false, end = false;

                // ê³„íšë§Œ ìˆê³ , ì•„ì§ ì‹œì‘ ì•ˆí–ˆì„ ë•Œ
                if (hasPlanStart && !hasActualBgn) {
                    bgn = true;
                    ing = false;
                    end = false;
                }
                // ì§„í–‰: ì‹œì‘ì¼ ìˆê³ , ì¢…ë£Œì¼ ì—†ì„ ë•Œ
                else if (hasActualBgn && !hasActualEnd) {
                    bgn = false;
                    ing = true;
                    end = false;
                }
                // ì¢…ë£Œ: actual_end_date ê°€ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ì¢…ë£Œ
                else if (hasActualEnd) {
                    bgn = false;
                    ing = false;
                    end = true;
                }
                return { ...row, bgn, ing, end };
            });
        }

        // QDB ì¡°íšŒ íŒì—… ì˜¤í”ˆ
        function openQdbModal(rowData) {
            document.getElementById('qdbModal').style.display = 'block';

            const activityId = rowData.activity_id;
            const todayBohal = rowData.today_bohal ?? 0;
            const wbs = rowData.path_nm ?? '';
            const activityNm = rowData.activity_nm ?? '';

            $('#wbs').text(wbs);
            $('#activityNm').text(activityNm);
            $('#bohal span, #bohal').text(todayBohal);

            initQdbData({
                cntrctNo: cntrctNo,
                activityId: activityId,
                todayBohal: todayBohal,
                searchText: ''
            });
        }

        function initData() {
            const param = {
                cntrctNo: cntrctNo,
                dailyReportId: rId,
                workDtType: 'TM',
                planStart: $("#sDate").val(),
                planFinish: $("#eDate").val(),
                searchText: $("#searchText").val()
            }
            gaiaCommon.post(
                BASEPATH + 'dailyreport/dailyreport-chg',
                param,
                function (response) {
                    const details = (response && response.details) || {};
                    let activityData = details.prActivityList || [];
                    let tomorrowActivityData = details.tomorrowDailyReportActivityList || [];

                    // activityGrid ë°ì´í„° ì¤‘ tomorrowGridì— ì—†ëŠ” í•­ëª©ë§Œ í•„í„°ë§
                    const tomorrowIds = new Set(tomorrowActivityData.map(item => item.activity_id));
                    const filteredActivityData = activityData.filter(
                        item => !tomorrowIds.has(item.activity_id)
                    );

                    // ì•¡í‹°ë¹„í‹° ëª©ë¡
                    activityGrid.resetData(filteredActivityData);
                    refreshGrid(activityGrid);

                    // ê¸ˆì¼ ì•¡í‹°ë¹„í‹° ëª©ë¡
                    // â˜… ìƒíƒœë³„ ë³„ ì„¸íŒ…
                    const dataWithStars = setStatusStars(tomorrowActivityData);
                    tomorrowGrid.resetData(dataWithStars);
                    refreshGrid(tomorrowGrid);

                },
                function (error) {
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                }
            );
        }


        window.addEventListener('resize', () => {
          activityGrid.refreshLayout();
        });
        $("#cancel").click(function () {
            window.location.href = "/construction/dailyreport/update"+`?rId=${rId}&pjtNo=${pjtInfo.pjtNo}&cntrctNo=${pjtInfo.cntrctNo}&_condition=init`;
            sessionStorage.setItem('cntrctNo', cntrctNo);
        });
        $("#save").click(function () {
            window.location.href = "/construction/dailyreport-tomorrow-detail?cntrctNo=" + cntrctNo + "&rId=" + rId+`&pjtNo=${pjtInfo.pjtNo}` + "&drDt=" + drDt;
            sessionStorage.setItem('cntrctNo', cntrctNo);
        });
        $(document).ready(()=>{
            gaia.create({
                $init: function ($params) {
                    gaiaPortal.navMenuInit('M0401', "{{ message('item.construction.901') }}" + " ëª…ì¼ ì•¡í‹°ë¹„í‹° " + "{{ message('btn.003') }}");
                    $("#menuDepth").append('<li class=\"breadcrumb_item\" name=\"new_item\">{{ message("item.construction.901") }}  ëª…ì¼ ì•¡í‹°ë¹„í‹° {{ message("btn.003") }}</li>');
                }
            });
            initData();
        });

        let reportRefreshGrid = function (...grids) {
            const _section = document.getElementById("content")

            if (!_section) return;

            let timer;
            const resizeObserver = new ResizeObserver(() => {
                clearTimeout(timer);

                timer = setTimeout(() => {
                    for (const grid of grids) {
                        if (!grid || !(grid instanceof tui.Grid)) continue;

                        const dataWidth = Number(elem.el.getAttribute("data-width"));

                        grid.el.setAttribute("data-width", dataWidth);

                        const newWidth = dataWidth;

                        // ğŸ”¸ 1. DOM width ì§ì ‘ ë°˜ì˜ (ì¦‰ì‹œ ë°˜ì‘)
                        grid.el.style.width = `${newWidth}px`;
                        grid.refreshLayout()
                    }
                }, 10);
            });

            resizeObserver.observe(_section);
        };
    </script>
{% endblock footer_script %}
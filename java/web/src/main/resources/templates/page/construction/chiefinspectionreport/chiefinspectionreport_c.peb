    {% extends 'layout/base_content' %}
        {% block content %}
        <section class="contents_wrap g-row">
            <article class="conts g-row">
                <div class="group" id="outline">
                    <div class="conts_form">
                        <div class="btn_area s_default _outline">
                            <button type="button" class="btn" onclick="page.save()">{{message('btn.006')}}</button> <!-- 저장 -->
                            <button type="button" class="btn" onclick="page.close()">{{message('btn.007')}}</button> <!-- 닫기 -->
                        </div>
                        <div class="s_conts">
                            <span class="tree_route">개요</span>
                            <div class="form_box">
                                <span class="caption">
                                    <span><b class="c_red">*</b> {{ message('item.com.023') }}</span>
                                </span>
                                <!-- row -->
                                <div class="row cols">
                                    <div class="col">
                                        <div class="form_label required">보고일자</div>
                                        <div class="form_data">
                                            <input type="date" id="dailyReportDate" class="date w-md">
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form_label required">보고서 번호</div>
                                        <div class="form_data">
                                            <input type="text" id="reportNo"
                                                   class="form-control maxlength" maxlength="20">
                                        </div>
                                    </div>
                                </div>
                                <!-- row -->
                                <div class="row cols">
                                    <div class="col">
                                        <div class="form_label">제목</div>
                                        <div class="form_data">
                                            <input type="text" id="title" class="maxlength" maxlength="100">
                                        </div>
                                    </div>
                                </div>
                                <!-- row -->
                                <div class="row cols">
                                    <div class="form_label">기상현황</div>
                                    <div style="width: 100%;">
                                        <div class="row cols">
                                            <div class="col">
                                                <div class="form_label">날씨 오전</div>
                                                <div class="form_data">
                                                    <input type="text" id="amWthr" class="maxlength w-lg" maxlength="30">
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="form_label">날씨 오후</div>
                                                <div class="form_data">
                                                    <input type="text" id="pmWthr" class="maxlength w-lg" maxlength="30">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row cols">
                                            <div class="col">
                                                <div class="form_label">최저 온도</div>
                                                <div class="form_data">
                                            <span class="item_wrap put_txt _celsius">
                                                <input type="text" id="dlowstTmprtVal"class="maxlength w-lg" maxlength="30">
                                            </span>
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="form_label">최고 온도</div>
                                                <div class="form_data">
                                            <span class="item_wrap put_txt _celsius">
                                                <input type="text" id="dtopTmprtVal" class="maxlength w-lg" maxlength="10">
                                            </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row cols">
                                            <div class="col">
                                                <div class="form_label">강수량</div>
                                                <div class="form_data">
                                            <span class="item_wrap put_txt _mm">
                                                <input type="text" id="prcptRate" class="maxlength w-lg" maxlength="30">
                                            </span>
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="form_label">강설량</div>
                                                <div class="form_data">
                                            <span class="item_wrap put_txt _mm">
                                                <input type="text" id="snowRate" class="maxlength w-lg" maxlength="30">
                                            </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row cols" id="progressRow">
                                    <div class="form_label">공정현황</div>
                                    <div style="width: 100%;">
                                        <div class="row">
                                            <div class="col">
                                                <div class="form_label division_row">구분</div>
                                                <div class="form_label division_row">계획(%)</div>
                                                <div class="form_label division_row">실적(%)</div>
                                                <div class="form_label division_row">대비(%)</div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col">
                                                <div class="form_label  division_row">당일</div>
                                                <div class="form_data  division_row">
                                                    <span id="todayPlanBohalRate"></span>
                                                </div>
                                                <div class="form_data  division_row">
                                                    <span id="todayArsltBohalRate"></span>
                                                </div>
                                                <div class="form_data  division_row">
                                                    <span id="todayProcess"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col">
                                                <div class="form_label division_row">누적</div>
                                                <div class="form_data division_row">
                                                    <span id="acmltPlanBohalRate"></span>
                                                </div>
                                                <div class="form_data  division_row">
                                                    <span id="acmltArsltBohalRate"></span>
                                                </div>
                                                <div class="form_data  division_row">
                                                    <span id="acmltProcess"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </article>
        </section>
        {% endblock content %}
    {% block footer_script %}
    <style>
        .division_row {
            flex: 1;
            justify-content: center;
            border-left: 1px solid var(--form-in-bd);
            padding-right: 1.5em;
        }

        .hide {
            display: none;
        }
    </style>
    <script>
        var pjtNo;
        var urlParams = new URLSearchParams(location.search);
        var cntrctNo = urlParams.get('cntrctNo');

        $(function () {
            gaia.create({
                $init: function ($params) {
                    page.init();
                }
            });
        });

        let page = {

            init: function () {
                pjtNo = pjtInfo.pjtNo;
                cntrctNo = cntrctNo ?? pjtInfo.cntrctNo;

                gaiaPortal.navMenuInit('M0406', "CM 책임기술인 업무일지 추가");

                const today = new Date().toLocaleDateString("en-CA");  // "2025-08-02"
                $("#dailyReportDate").attr("max", today);

                $("#dailyReportDate").change(function (e) {
                    page.getDailyReport();
                });
            },

            // 책임감리일지 추가
            save: function () {
                let reportNo = $('#reportNo').val();
                let dailyReportDate =  $('#dailyReportDate').val();

                if (!dailyReportDate) {
                    gaiaCommon.customAlert('보고일자를 선택해주세요');
                    $('#dailyReportDate').focus();
                    return;
                }

                if (!reportNo) {
                    gaiaCommon.customAlert('보고서 번호를 입력해주세요');
                    $('#reportNo').focus();
                    return;
                }

                param = {
                    cntrctNo: cntrctNo,
                    dailyReportDate: $('#dailyReportDate').val(),
                    reportNo: reportNo,
                    title: $('#title').val(),
                    cfTimeRange: `09~12시



13~18시`,
                    // 날씨
                    amWthr: $('#amWthr').val(),
                    pmWthr: $('#pmWthr').val(),
                    dlowstTmprtVal: $('#dlowstTmprtVal').val(),
                    dtopTmprtVal: $('#dtopTmprtVal').val(),
                    prcptRate: $('#prcptRate').val(),
                    snowRate: $('#snowRate').val(),

                    // 공정률
                    todayPlanBohalRate: $('#todayPlanBohalRate').text(),
                    todayArsltBohalRate: $('#todayArsltBohalRate').text(),
                    todayProcess: $('#todayProcess').text(),
                    acmltPlanBohalRate: $('#acmltPlanBohalRate').text(),
                    acmltArsltBohalRate: $('#acmltArsltBohalRate').text(),
                    acmltProcess: $('#acmltProcess').text(),
                }

                gaiaCommon.LoadingOverlay('body', true);
                $.ajax({
                    url: '/api/construction/chiefinspectionreport/create',
                    method: 'POST',
                    processData: false,
                    contentType: 'application/json',
                    data: JSON.stringify(param),
                    success: function (response) {
                        gaiaCommon.LoadingOverlay('body', false);
                        if (response.details.success == true) {
                            const dailyReportId = response.details.dailyReportId;
                            gaiaCommon.customAlert('{{ message("msg.044") }}', function () {
                                window.location.href = `/construction/chiefinspectionreport/update?pjtNo=${pjtNo}&cntrctNo=${cntrctNo}&dailyReportId=${dailyReportId}&_condition=init`;
                                sessionStorage.setItem('cntrctNo', cntrctNo);
                            });
                        } else if (response.details.success == false){
                            gaiaCommon.customAlert(response.details.message);
                        } else {
                            gaiaCommon.customAlert(response.message);
                        }
                    },
                    error: function (xhr) {
                        gaiaCommon.LoadingOverlay('body', false);
                        gaiaCommon.customAlert('{{ message("msg.045") }}');	// 저장에 실패 했습니다.
                    }
                });
            },

            // 닫기
            close: function () {
                window.location.href = `/construction/chiefinspectionreport?pjtNo=${pjtNo}&cntrctNo=${cntrctNo}&_condition=init`; sessionStorage.setItem('cntrctNo', cntrctNo);
            },

            // 작업일보 데이터 조회
            getDailyReport:function (){
                gaiaCommon.LoadingOverlay('body', true);

                let param = {
                    dailyReportDate: $("#dailyReportDate").val(),
                    cntrctNo: cntrctNo
                }

                $.ajax({
                    url: `/api/construction/chiefinspectionreport/getDailyReport`,
                    method: 'POST',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(param),
                    success: function (response) {
                        if (response.ok) {
                            const dailyReport = response.details.dailyReport;
                            const reportId = response.details.reportId;

                            // 공정율 정보 처리 (reportId가 있든 없든 처리)
                            $("#acmltPlanBohalRate").text(dailyReport?.acmltPlanBohalRate ?? '0');
                            $("#acmltArsltBohalRate").text(dailyReport?.acmltArsltBohalRate ?? '0');
                            $("#acmltProcess").text(dailyReport?.acmltProcess ?? '0');
                            $("#todayPlanBohalRate").text(dailyReport?.todayPlanBohalRate ?? '0');
                            $("#todayArsltBohalRate").text(dailyReport?.todayArsltBohalRate ?? '0');
                            $("#todayProcess").text(dailyReport?.todayProcess ?? '0');


                            if (reportId) {
                                gaiaCommon.customAlert("해당날짜에 책임감리일지가 이미 존재합니다.");
                                $("#dailyReportDate").val('');

                                // 날씨 정보 초기화
                                $("#amWthr").val('');
                                $("#pmWthr").val('');
                                $("#dlowstTmprtVal").val('');
                                $("#dtopTmprtVal").val('');
                                $("#prcptRate").val('');
                                $("#snowRate").val('');

                                gaiaCommon.LoadingOverlay('body', false);

                            }else {
                                page.callJsonApi();
                            }
                        }
                    },
                    error: function (response) {
                        gaiaCommon.LoadingOverlay('body', false);
                        return false;
                    },
                });
            },

            // 기상청 날씨 정보 가져오기
            callJsonApi: function () {
                gaiaCommon.customAlert("{{ message('msg.dailyreport.001') }}");
                var formData = {
                    pjtNo: pjtNo
                    , tm: $("#dailyReportDate").val().replaceAll("-", "")
                }

                $.ajax({
                    url: '/api/util/kma-weather',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        let kma = response.details.kma;

                        // 날씨 정보
						$("#amWthr").val(kma.am_wf);
						$("#pmWthr").val(kma.pm_wf);
						$("#dlowstTmprtVal").val(kma.ta_min);
						$("#dtopTmprtVal").val(kma.ta_max);
						$("#prcptRate").val(kma.rn_day);
						$("#snowRate").val(kma.sd_max);

                        gaiaCommon.LoadingOverlay('body', false);
                    },
                    error: function (response) {
                        gaiaCommon.customAlert("{{ message('msg.construction.002') }}");
                        gaiaCommon.LoadingOverlay('body', false);
                        return false;
                    },
                });
            }
        }
    </script>
    {% endblock footer_script %}
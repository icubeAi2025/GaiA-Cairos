<div class="modal fade" id="qdbModal" style="z-index:1000;">
    <div class="pop_box _xlg">
        <div class="pop_header">
            <h5 class="pop_tit">실행 내역</h5>
            <div class="btn_area">
                <button type="button" class="icon_btn pop_close" onclick="cancelQdbModal()">
                    <span class="blind">창닫기</span>✕
                </button>
            </div>
        </div>

        <div class="pop_body">
            <section>
                <h4 class="conts_s-tit">* Activity 정보</h4>
                <!-- 요청: 아래 코드 스타일로 라벨/텍스트에어리어 -->
                <div class="form_box" id="formBox">
                    <div class="row" id="row">
                        <div class="col" style="width:100%;">
                            <div class="form_label">WBS</div>
                            <div class="form_data" id="wbs">본동 / 부대 / 조경공사 / 공통</div>
                        </div>
                    </div>
                    <div class="row" id="row">
                        <div class="col" style="width:100%;">
                            <div class="form_label">Activity 이름</div>
                            <div class="form_data" id="activityNm">본동,조경,부대공사,공통,수목제거공사</div>
                        </div>
                    </div>
                    <div class="row" id="row">
                        <div class="col" style="width:100%;">
                            <div class="form_label">보할</div>
                            <div class="form_data" id="bohal"><span id="bohal">10 </span> (%)</div>
                        </div>
                    </div>
                </div>
            </section>

            <hr style="margin:16px 0;">

            <!-- ========== 하단 *CBS 정보* ========== -->
            <section>
                <h4 class="conts_s-tit">* CBS 정보</h4>

                <!-- 검색란 (요청한 마크업 그대로) -->
                <form id="qdbSearchForm" onsubmit="return false;">
                    <div class="row">
                        <div class="searchbox_wrap" style="width: 20%; margin-right: 5px;">
                             <input type="text" id="searchQdbText" placeholder="코드, 품명">
                            <button type="submit" class="icon_btn search" id="btnSearch">
                                <i class="ic ic-search"></i>
                                <span class="blind">검색</span>
                            </button>
                        </div>
                        <button type="button" class="icon_btn" id="btnApply">
                            <i class="ic ic-outgoing"></i>
                        </button>
                    </div>
                </form>

                <!-- TUI Grid 영역 -->
                <div class="grid-shell">
                    <div class="grid" id="cbsGrid"></div>
                </div>
            </section>
        </div>

        <div class="pop_footer">
            <div class="btn_area s_default jc_e">
                <button type="button" class="btn _outline" onclick="cancelQdbModal()">닫기</button>
            </div>
        </div>
    </div>
</div>
<link rel="stylesheet" href="/assets/css/all.min.css">
<style>
.cell-BizON {
	background-color: #FFF000 !important
}

.pop_box._sm {
	width: 62rem;
}

.pop_box.toast {
  position: fixed !important;
  z-index: 99999 !important;
}
.form_label {
    justify-content: center;
}

</style>
 <script src="/assets/js/construction/construction.js"></script>
<script>
    let modalActivityId = null; // 부모페이지에서 데이터 저장
    let modalTodayBohal = null; // 부모페이지에서 데이터 저장
    let modalCntrctNo = null;   // 부모페이지에서 데이터 저장

    // ===== 1) TUI Grid 초기화 =====
    const cbsGrid = new tui.Grid({
        el: document.getElementById('cbsGrid'),
        bodyHeight: 360,
        scrollX: true,
        scrollY: true,
        rowHeaders: [],
        columnOptions: { resizable: true },
        columns: [
            { header:'코드',   name:'rsce_cd',     width:160, align:'center' },
            { header:'품명',   name:'dtl_cnstty_nm',   minWidth:160 },
            { header:'규격',   name:'spec_nm',        width:140 },
            { header:'단위',   name:'unit',        width:80, align:'center' },
            { header:'수량',   name:'rsce_qty',   width:110, align:'right' },
            { header:'금일수량', name:'work_qty', width:110, align:'right' },
            {
                header: '금일누계',
                name: 'prev_work_qty',
                width: 110,
                align: 'right',
                formatter: ({ row }) => {
                    const workQty = Number(row.work_qty) || 0;
                    const prevWorkQty = Number(row.prev_work_qty) || 0;
                    return (workQty + prevWorkQty).toFixed(2);
                }
            },
            {
                header: '잔여',
                name: 'remndr_qty',
                width: 110,
                align: 'right',
                formatter: ({ row }) => {
                    const workQty = Number(row.work_qty) || 0;
                    const prevWorkQty = Number(row.prev_work_qty) || 0;
                    const rsceQty = Number(row.rsce_qty) || 0;
                    const remndr = rsceQty - (workQty + prevWorkQty);
                    return remndr < 0 ? 0 : remndr.toFixed(2);
                }
            },
        ],
        data: []
    });


    function cancelQdbModal() {
        document.getElementById('qdbModal').style.display = 'none';
        document.body.style.overflow = 'unset';
    }


    // 모달 오픈 시 부모로부터 값 전달
    function initQdbData(param) {
        modalActivityId = param.activityId;
        modalTodayBohal = param.todayBohal;
        modalCntrctNo = param.cntrctNo;

        loadQdbData(param.searchText || '');
    }

    function loadQdbData(searchText) {
        const param = {
            cntrctNo: modalCntrctNo,
            activityId: modalActivityId,
            todayBohal: modalTodayBohal,
            searchText: searchText || ''
        }
        gaiaCommon.post(
            BASEPATH + 'dailyreport/qdb-list',
            param,
            function (response) {
                const details = (response && response.details) || {};
                qdbData = details.qdbList || [];

                cbsGrid.resetData(qdbData);
                if (cbsGrid.refreshLayout) cbsGrid.refreshLayout();
            },
            function (error) {
                console.error(error);
                gaiaCommon.customAlert("{{ message('msg.060') }}");
            }
        );
    }

    // 검색 버튼/엔터
    $("#searchQdbText").on("keyup", function (key) {
        if (key.keyCode == 13) {
        setTimeout(() => {
            const searchText = $("#searchQdbText").val();
            loadQdbData(searchText); // 기존 전역변수 + 검색어로 다시 호출
        }, 100);
        }
    });

    $(".icon_btn.search").on("click", function(e) {
        setTimeout(() => {
        }, 100);
    });

    $(document).ready(()=>{
        setTimeout(() => {
        }, 100);
    });
</script>
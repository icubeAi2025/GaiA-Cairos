    {% extends 'layout/base_content' %}
        {% block content %}
    <section class="contents_wrap g-row">
        <article class="conts g-row">
            <div class="group">
                <div class="conts_grid">
                    <div class="btn_area s_default">
                        {{ btnHtml | raw }}
                        <button type="button" class="btn _outline" id="cancel">{{ message("btn.007") }}</button>
                    </div>
                </div>
            </div>

            <!-- Activity Î™©Î°ù -->
            <div class="group" id="inputChgTodayForm">
                <div class="conts_grid">
                    <h4 class="conts_s-tit">Activity {{ message("item.com.066") }}</h4>
                    <div class="search_wrap">
                        <!-- S: search wrap ---------------------------------------------- -->
                        <input type="date" id="sDate" class="date w-md">
                        <span class="_tilde">~</span>
                        <input type="date" id="eDate" class="date w-md">

                        <!-- searchbox -->
                        <div class="searchbox_wrap">
                            <input type="text" id="searchText" placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                            <button type="submit" class="icon_btn search">
                                <i class="ic ic-search"></i>
                                <span class="blind">Í≤ÄÏÉâ</span>
                            </button>
                        </div>
                    </div>
                    <!-- // E: search wrap ---------------------------------------------- -->
                    <div class="grid" id="activityGrid"></div>
                </div>
            </div>

            <!-- Í∏àÏùº Ïã§Ï†Å -->
            <div class="group">
                <div class="s_conts">
                    <span class="tree_route">{{ message("item.construction.056") }}</span>
                    <div class="conts_grid">
                        <h4 class="conts_s-tit">Í∏àÏùº Ïã§Ï†Å</h4>
                        <!-- Í∏àÏùº Ïï°Ìã∞ÎπÑÌã∞ -->
                        <div class="grid" id="todayGrid"></div>
                    </div>

                    <!-- Ïù∏Î†• -->
                    <div class="conts_grid" style="padding-top: 10px">
                        <span class="conts_s-tit" >* Ïù∏Î†•</span>
                        <div class="tagbar" id="laborTags"></div>
                        <div class="searchbox_wrap" style="width: 300px;">
                            <input type="text" id="laborSearchText" placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                            <button type="submit" class="icon_btn search">
                                <i class="ic ic-search"></i>
                                <span class="blind">Í≤ÄÏÉâ</span>
                            </button>
                        </div>
                        <div  class="conts_grid" style="display: flex; gap: 20px;">
                            <div class="grid" id="leftLaborGrid" style="flex: 1;"></div>
                            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; getCheckedRows">
                                <button style="display:none; id="btnAddLabor" type="button" class="btn btn-primary">‚Æï </button>
                                <button style="display:none; id="btnRemoveLabor" type="button" class="btn btn-secondary">‚¨Ö </button>
                            </div>
                            <div class="grid" id="rightLaborGrid" style="flex: 1;"></div>
                        </div>
                    </div>

                    <!-- ÏûêÏû¨ -->
                    <div class="conts_grid" style="padding-top: 5px">
                        <span class="conts_s-tit">* ÏûêÏû¨</span>
                        <div class="tagbar" id="materialTags"></div>
                        <div class="search_wrap">
                            <span class="selectbox">
                                <select id="matSupply" >
                                    <option>Ï†ÑÏ≤¥</option>
                                    <option>Í¥ÄÍ∏â</option>
                                    <option>ÏÇ¨Í∏â</option>
                                </select>
                            </span>
                            <div class="searchbox_wrap" style="width: 300px;">
                                <input type="text" id="materialSearchText" placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                                <button type="submit" class="icon_btn search">
                                    <i class="ic ic-search"></i>
                                    <span class="blind">Í≤ÄÏÉâ</span>
                                </button>
                            </div>
                        </div>
                        <div  class="conts_grid" style="display: flex; gap: 20px;">
                            <div class="grid" id="leftMaterialGrid" style="flex: 1;"></div>
                            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; getCheckedRows">
                                <button style="display:none; id="btnAddMaterial" type="button" class="btn btn-primary">‚Æï </button>
                                <button style="display:none; id="btnRemoveMaterial" type="button" class="btn btn-secondary">‚¨Ö </button>
                            </div>
                            <div class="grid" id="rightMaterialGrid" style="flex: 1;"></div>
                        </div>
                    </div>

                    <!-- Ïû•ÎπÑ -->
                    <div class="conts_grid" style="padding-top: 5px">
                        <span class="conts_s-tit">* Ïû•ÎπÑ</span>
                        <div class="tagbar" id="expensesTags"></div>
                        <div class="searchbox_wrap" style="width: 300px;">
                            <input type="text" id="expensesSearchText" placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                            <button type="submit" class="icon_btn search">
                                <i class="ic ic-search"></i>
                                <span class="blind">Í≤ÄÏÉâ</span>
                            </button>
                        </div>
                        <div  class="conts_grid" style="display: flex; gap: 20px;">
                            <div class="grid" id="leftExpensesGrid" style="flex: 1;"></div>
                            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; getCheckedRows">
                                <button style="display:none; id="btnAddExpenses" type="button" class="btn btn-primary">‚Æï </button>
                                <button style="display:none; id="btnRemoveExpenses" type="button" class="btn btn-secondary">‚¨Ö </button>
                            </div>
                            <div class="grid" id="rightExpensesGrid" style="flex: 1;"></div>
                        </div>
                    </div>
                </div>
            </div>

        </article>
    </section>
    {% include "page/construction/dailyreport/dailyreport_qdb" %}
            {% include 'sub/grid' %}
    <link rel="stylesheet" href="/assets/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/content.css" />
{% endblock content %}
    {% block footer_script %}
    <script src="/assets/js/construction/construction.js"></script>
    <style>
        #activityGrid .tui-grid-cell[data-column-name="actions_add"]{
          text-align:center;
          overflow:visible;
          padding:0;
        }

        /* Ï†ÑÏó≠ float/right Î¨¥Î†•Ìôî + Í∞ÄÏö¥Îç∞ Î∞∞ÏπòÏö© inline-flex */
        #activityGrid .tui-grid-cell[data-column-name="actions_add"] .icon_btn.more{
          float:none !important;
          transform:none !important;
          position:static !important;
          display:inline-flex;
          align-items:center;
          justify-content:center;
          margin:0;
          cursor: pointer;
        }
        .more::after {
            content: none;
        }
        .selectbox {
            width:100px;
            position:relative;
            margin-right: 5px;
        }
    </style>
    <script src="/assets/js/construction/construction.js"></script>
    <script src="/assets/js/grid.js"></script>
    <script>
        var urlParams = new URLSearchParams(location.search);
        var cntrctNo = urlParams.get('cntrctNo');
        var rId = urlParams.get('rId');
        var drDt = urlParams.get('drDt');

        // ÏàúÏàò number Î¶¨ÌÑ¥
        function N(v){ if(v==null||v==='') return 0; const n=Number(String(v).replace(/,/g,'')); return isFinite(n)?n:0; }


        // ===== Activity Grid =====
        const activityGrid = new tui.Grid({
            el: document.getElementById('activityGrid'),
            bodyHeight: 250,
            scrollX: true,
            scrollY: true,
            rowHeaders: [],
            columnOptions: { resizable: true },
            header: {
                height: 80,
                complexColumns: [
                    {
                        header: 'Í≥ÑÌöç',
                        name: 'plan',
                        childNames: ['plan_start', 'plan_finish']
                    }
                ],
            },
            columns: [
                { header: 'WBS', name: 'path_nm', align:'center' },
                { header: 'Activity ID', name: 'activity_id', width: 365, align:'center' },
                { header: 'Activity Î™Ö', name: 'activity_nm', width: 365, align:'left' },
                { header: 'Í≥ÑÌöç Í∏àÏï°', name: 'expt_cost', width: 365, align:'right' },
                { header: 'Í≥ÑÌöç ÏãúÏûëÏùº', name: 'plan_start', width: 180, align:'center' },
                { header: 'Í≥ÑÌöç Ï¢ÖÎ£åÏùº', name: 'plan_finish', width: 180, align:'center' },
                { header: 'actual_bgn_date', name: 'actual_bgn_date', hidden: true },
                { header: 'actual_end_date', name: 'actual_end_date', hidden: true },
                { header: 'ori_total_progress', name: 'ori_total_progress', hidden: true }
            ],
            data: []
        });

        // ===== Today Grid (complex header) =====
        class StatusStarRenderer {
            constructor(props) {
                this.el = document.createElement('div');
                this.el.style.fontSize = '20px';
                this.el.style.textAlign = 'center';
                this.el.style.userSelect = 'none';
                this.el.style.pointerEvents = 'none'; // ÌÅ¥Î¶≠ Ï∞®Îã®

                this.render(props);
            }

            getElement() {
                return this.el;
            }

            render(props) {
                const value = props.value === true;
                this.el.style.color = value ? '#333' : '#ccc';
                this.el.textContent = value ? '‚òÖ' : '‚òÜ';
            }
        }

        const todayGrid = new tui.Grid({
            el: document.getElementById('todayGrid'),
            bodyHeight: 250,
            scrollX: true,
            scrollY: true,
            rowHeaders: [],
            columnOptions: { resizable: true },
            rowHeaders: [],
            header: {
                height: 80,
                complexColumns: [
                    { header: 'Í≥ÑÌöç', name: 'plan', childNames: ['plan_start', 'plan_finish', 'plan_reqre_daynum'] },
                    { header: 'Í∏àÏùºÏã§Ìñâ', name: 'actual', childNames: ['actual_bgn_date', 'actual_end_date', 'actual_reqre_daynum'] },
                    { header: 'ÏÉÅÌÉú', name: 'status', childNames: ['bgn', 'ing', 'end'] }
                ],
            },
            columns: [
                { header:'WBS', name:'path_nm' , width: 140,},
                {
                    header: 'Activity ID',
                    name: 'activity_id',
                    width: 120,
                    align: 'center',
                    renderer: {
                        type: window.IconRenderer,
                        options: [
                            { type: 'eyes',   success: (rowData) => openQdbModal(rowData) }
                        ]
                    }
                },
                { header:'Activity Î™Ö', name:'activity_nm', width:200 },
                { header:'ÏãúÏûëÏùº', name:'plan_start',align:'center', width: 100, },
                { header:'Ï¢ÖÎ£åÏùº', name:'plan_finish',align:'center', width: 100, },
                { header:'ÏÜåÏöîÏùºÏàò', name:'plan_reqre_daynum',align:'center', },
                {
                    header: 'ÏãúÏûëÏùº',
                    name: 'actual_bgn_date',
                    align: 'center',
                    width: 100,
                    formatter: ({ row }) => {
                        // bgn ÎòêÎäî ing, end Ï§ë ÌïòÎÇòÎùºÎèÑ trueÎ©¥ ÎÇ†Ïßú ÌëúÏãú
                        if (row.bgn || row.ing || row.end) {
                          return row.actual_bgn_date || drDt;
                        }
                        // Î™®Îì† ÏÉÅÌÉú falseÎ©¥ ÎπàÍ∞í
                        return '';
                      }
                },
                { header:'Ï¢ÖÎ£åÏùº', name:'actual_end_date',align:'center', width: 100,},
                { header:'ÏÜåÏöîÏùºÏàò', name:'actual_reqre_daynum',align:'center',  },
                { header:'ÏãúÏûë', name:'bgn', align:'center', renderer:{ type: StatusStarRenderer } },
                { header:'ÏßÑÌñâ', name:'ing', align:'center', renderer:{ type: StatusStarRenderer } },
                { header:'Ï¢ÖÎ£å', name:'end', align:'center', renderer:{ type: StatusStarRenderer } },
                {
                    header: 'Î≥¥Ìï†(%)',
                    name: 'today_bohal',
                    width: 150,
                    align: 'center',
                },
                {
                    header: 'ÏßÑÌñâÎ•†(%)',
                    name: 'total_progress',
                    align: 'right',
                    formatter: ({ row }) => {
                        const todayBohal = parseFloat(row.today_bohal || 0);
                        const totalProgress = parseFloat(row.total_progress || 0);
                        const total = todayBohal + totalProgress;
                        return total.toFixed(2);
                    }
                },
                { header: 'ori_total_progress', name: 'ori_total_progress', hidden: true },
                { header: 'expt_cost', name: 'expt_cost', hidden: true }
            ],
            data: []
        });

        // ÏÇ≠Ï†ú Î≤ÑÌäº
        $('#deleteActivity').on('click', function () {
            const checkedRows = todayGrid.getCheckedRows();

            if (checkedRows.length === 0) {
                gaiaCommon.customAlert('ÏÇ≠Ï†úÌï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            checkedRows.forEach(row => {
                const exists = activityGrid.getData().some(r => r.activity_id === row.activity_id);
                if (!exists) {
                    activityGrid.appendRow({
                    path_nm: row.path_nm,
                    activity_id: row.activity_id,
                    activity_nm: row.activity_nm,
                    expt_cost: row.expt_cost || 0,
                    plan_start: row.plan_start,
                    plan_finish: row.plan_finish,
                    plan_reqre_daynum: row.plan_reqre_daynum,
                    actual_bgn_date: row.actual_bgn_date,
                    actual_end_date: row.actual_end_date,
                    ori_total_progress: row.ori_total_progress || 0});
                }

                // todayGridÏóêÏÑú ÏÇ≠Ï†ú
                todayGrid.removeRow(row.rowKey);
            });

            // ÏµúÏã† todayGrid Í∏∞Ï§Ä ÏûêÏõê Ïû¨Ï°∞Ìöå
            const todayData = todayGrid.getData();
            if (todayData && todayData.length > 0) {
                initResourceData(todayData);
            } else {
                resetResourceList();
            }

            gaiaCommon.customAlert('ÏÑ†ÌÉùÎêú Ìï≠Î™©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        });

        // Ï†ÅÏö© Î≤ÑÌäº
        $('#applyActivity').on('click', function () {
            const applyType = $('#applyType').val(); // start or end
            const checkedRows = todayGrid.getCheckedRows();

            if (checkedRows.length === 0) {
                gaiaCommon.customAlert('Ï†ÅÏö©Ìï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            checkedRows.forEach(row => {
                const rowKey = row.rowKey;
                const data = todayGrid.getRow(rowKey);
                if (!data) return;

                // Í∏∞Î≥∏ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                todayGrid.setValue(rowKey, 'bgn', false, false);
                todayGrid.setValue(rowKey, 'ing', false, false);
                todayGrid.setValue(rowKey, 'end', false, false);

                if (applyType === 'start') {
                    // Í∏àÏùº ÏãúÏûë Ï≤òÎ¶¨
                    todayGrid.setValue(rowKey, 'actual_bgn_date', drDt, false);
                    todayGrid.setValue(rowKey, 'bgn', true, false);
                    todayGrid.setValue(rowKey, 'actual_end_date', '', false);
                } else if (applyType === 'end') {
                    // Í∏àÏùº Ï¢ÖÎ£å Ï≤òÎ¶¨
                    todayGrid.setValue(rowKey, 'actual_end_date', drDt, false);
                    todayGrid.setValue(rowKey, 'end', true, false);

                    // ÏãúÏûëÏùº ÏóÜÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú Ïò§ÎäòÎ°ú ÏÑ∏ÌåÖ
                    const hasBgn = !!data.actual_bgn_date;
                    if (!hasBgn) {
                        todayGrid.setValue(rowKey, 'actual_bgn_date', drDt, false);
                    }
                    todayGrid.setValue(rowKey, 'bgn', false, false);
                }
            });
            todayGrid.refreshLayout();
        });

        // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏÑ∏ÌåÖ Î°úÏßÅ ÏòàÏãú
        // ÏãúÏûë: Í≥ÑÌöçÏãúÏûë(plan) Ï°¥Ïû¨, Í∏àÏùºÏãúÏûë(actual) ÎØ∏Ï°¥Ïû¨
        // ÏßÑÌñâ: Í∏àÏùºÏãúÏûë Ï°¥Ïû¨, Í∏àÏùºÏ¢ÖÎ£å ÎØ∏Ï°¥Ïû¨
        // Ï¢ÖÎ£å: Í∏àÏùºÏ¢ÖÎ£å Ï°¥Ïû¨
        function setStatusStars(data) {
            return data.map(row => {
                const hasPlanStart = !!row.plan_start;
                const hasActualBgn = !!row.actual_bgn_date;
                const hasActualEnd = !!row.actual_end_date;

                let bgn = false, ing = false, end = false;

                // Í≥ÑÌöçÎßå ÏûàÍ≥†, ÏïÑÏßÅ ÏãúÏûë ÏïàÌñàÏùÑ Îïå
                if (hasPlanStart && !hasActualBgn) {
                    bgn = true;
                    ing = false;
                    end = false;
                }
                // ÏßÑÌñâ: ÏãúÏûëÏùº ÏûàÍ≥†, Ï¢ÖÎ£åÏùº ÏóÜÏùÑ Îïå
                else if (hasActualBgn && !hasActualEnd) {
                    bgn = false;
                    ing = true;
                    end = false;
                }
                // Ï¢ÖÎ£å: actual_end_date Í∞Ä ÏûàÏúºÎ©¥ Î¨¥Ï°∞Í±¥ Ï¢ÖÎ£å
                else if (hasActualEnd) {
                    bgn = false;
                    ing = false;
                    end = true;
                }
                return { ...row, bgn, ing, end };
            });
        }

        // QDB Ï°∞Ìöå ÌåùÏóÖ Ïò§Ìîà
        function openQdbModal(rowData) {
            document.getElementById('qdbModal').style.display = 'block';

            const activityId = rowData.activity_id;
            const todayBohal = rowData.today_bohal ?? 0;
            const wbs = rowData.path_nm ?? '';
            const activityNm = rowData.activity_nm ?? '';

            $('#wbs').text(wbs);
            $('#activityNm').text(activityNm);
            $('#bohal span, #bohal').text(todayBohal);

            initQdbData({
                cntrctNo: cntrctNo,
                activityId: activityId,
                todayBohal: todayBohal,
                searchText: ''
            });
        }
        // Î≥¥Ìï† ÏûÖÎ†• ÌåùÏóÖÏ∞Ω Ïò§Ìîà
        function openBohalModal(rowKey, pillEl) {
            const currentVal = todayGrid.getValue(rowKey, 'bohalRate') ?? 0;

            gaiaCommon.customBohalEditConfirm(
                'Î≥¥Ìï†Î•† ÏàòÏ†ï',
                'Î≥¥Ìï†(%)',
                function (val, isAll) {
                    if (isAll) {
                        const data = todayGrid.getData();
                        data.forEach(row => todayGrid.setValue(row.rowKey, 'bohalRate', val));
                    } else {
                        todayGrid.setValue(rowKey, 'today_bohal', val);
                    }
                    if (pillEl) pillEl.textContent = val;

                    // Î≥ÄÍ≤Ω ÌõÑ ÎàÑÏ†Å ÏßÑÌñâÎ•† Îã§Ïãú Í≥ÑÏÇ∞
                    if (typeof callback === 'function') callback();
                },
                function () {
                    console.log('Î≥¥Ìï†Î•† ÏûÖÎ†• Ï∑®ÏÜå');
                }
            );
            $('#bohalInput').val(currentVal);
        }

        // Î≥¥Ìï† ÏàòÏ†ïÌï† Í≤ΩÏö∞ ÏßÑÌñâÎ•† Í∞±Ïã†
        function updateTotalProgress() {
            const data = todayGrid.getData();

            // Ï†ÑÏ≤¥ ÎàÑÏ†Å Î≥¥Ìï†Î•† Í≥ÑÏÇ∞
            let total = 0;
            data.forEach(row => {
                const val = parseFloat(row.today_bohal || 0);
                total += isNaN(val) ? 0 : val;
            });

            // Ï†ÑÏ≤¥ Ìï©Í≥ÑÎ•º Í∞Å ÌñâÏùò total_progressÏóê ÌëúÏãú
            data.forEach(row => {
                todayGrid.setValue(row.rowKey, 'total_progress', total.toFixed(2));
            });
        }

        function resetResourceList() {
            leftLaborGrid.resetData([]);
            leftMaterialGrid.resetData([]);
            leftExpensesGrid.resetData([]);

            // Î†àÏù¥ÏïÑÏõÉ Í∞±Ïã†
            if (leftLaborGrid.refreshLayout) leftLaborGrid.refreshLayout();
            if (leftMaterialGrid.refreshLayout) leftMaterialGrid.refreshLayout();
            if (leftExpensesGrid.refreshLayout) leftExpensesGrid.refreshLayout();
        }

        // ===== Labor Grid =====
        const laborColumns = [
            { header: 'ÎÖ∏Î¨¥ÏΩîÎìú', name: 'rsce_cd', align: 'center', width: 120 },
            { header: 'Ïù∏Î†•Î™Ö', name: 'rsce_nm', align: 'left' },
            { header: 'Îã®ÏúÑ', name: 'unit', align: 'center', width: 80 },
            { header: 'Ï¥ùÏàòÎüâ', name: 'total_qty', align: 'right' },
            { header: 'Í∏àÏùºÏàòÎüâ', name: 'actual_qty', align: 'right' },
            {
                header: 'Í∏àÏùºÎàÑÍ≥Ñ',
                name: 'acmtl_qty',
                align: 'right',
                formatter: ({ row }) =>
                    (Number(row.ori_qty || 0) + Number(row.actual_qty || 0)).toFixed(2)
            },
            { header: 'ÏûîÏó¨', name: 'remndr_qty', align: 'right', },
            { header: 'rsce_tp_cd', name: 'rsce_tp_cd', hidden: true },
            { header: 'cntrct_chg_id', name: 'cntrct_chg_id', hidden: true },
            { header: 'manual_yn', name: 'manual_yn', hidden: true },
            { header: 'rsce_sno', name: 'rsce_sno', hidden: true },
            { header: 'ori_qty', name: 'ori_qty', hidden: true }
        ];

        // Ï¢åÏ∏°(Ï†ÑÏ≤¥ Î¶¨Ïä§Ìä∏) Í∑∏Î¶¨Îìú
        const leftLaborGrid = new tui.Grid({
            el: document.getElementById('leftLaborGrid'),
            bodyHeight: 250,
            columns: laborColumns,
            data: [],
            scrollX: true,
            scrollY: true,
            columnOptions: { resizable: true },
        });

        // Ïö∞Ï∏°(ÏÑ†ÌÉùÎêú Î¶¨Ïä§Ìä∏) Í∑∏Î¶¨Îìú
        const rightLaborColumns = makeEditableColumns(laborColumns);
        const rightLaborGrid = new tui.Grid({
            el: document.getElementById('rightLaborGrid'),
            bodyHeight: 250,
            columns: rightLaborColumns,
            data: [],
            scrollX: true,
            scrollY: true,
            columnOptions: { resizable: true },
        });
        bindQuantityChangeHandler(rightLaborGrid);


        // ===== Material Grid =====
        const materialColumns = [
            {
                header: 'ÏûêÏû¨Ï¢ÖÎ•ò',
                name: 'govsply_mtrl_yn',
                align: 'center',
                width: 120,
                formatter: ({ row }) => {
                    const val = row.govsply_mtrl_yn;
                    if (val === 'Y') return 'Í¥ÄÍ∏âÏûêÏû¨';
                    if (val === 'N') return 'ÏÇ¨Í∏âÏûêÏû¨';
                    return '';
                }

            },
            { header: 'ÏûêÏû¨ÏΩîÎìú', name: 'rsce_cd', align: 'center' },
            { header: 'ÌíàÎ™Ö', name: 'rsce_nm', align: 'center', width: 80 },
            { header: 'Í∑úÍ≤©', name: 'spec_nm', align: 'right' },
            { header: 'Îã®ÏúÑ', name: 'unit', align: 'right' },
            { header: 'Ï¥ùÏàòÎüâ', name: 'total_qty', align: 'right' },
            { header: 'Í∏àÏùºÏàòÎüâ', name: 'actual_qty', align: 'right' },
            {
                header: 'Í∏àÏùºÎàÑÍ≥Ñ',
                name: 'acmtl_qty',
                align: 'right',
                formatter: ({ row }) =>
                    (Number(row.ori_qty || 0) + Number(row.actual_qty || 0)).toFixed(2)
            },
            { header: 'ÏûîÏó¨', name: 'remndr_qty', align: 'right' },
            { header: 'rsce_tp_cd', name: 'rsce_tp_cd', hidden: true },
            { header: 'cntrct_chg_id', name: 'cntrct_chg_id', hidden: true },
            { header: 'manual_yn', name: 'manual_yn', hidden: true },
            { header: 'rsce_sno', name: 'rsce_sno', hidden: true },
            { header: 'ori_qty', name: 'ori_qty', hidden: true }
        ];

        // Ï¢åÏ∏°(Ï†ÑÏ≤¥ Î¶¨Ïä§Ìä∏) Í∑∏Î¶¨Îìú
        const leftMaterialGrid = new tui.Grid({
            el: document.getElementById('leftMaterialGrid'),
            bodyHeight: 250,
            columns: materialColumns,
            data: [],
            scrollX: true,
            scrollY: true,
            columnOptions: { resizable: true },
        });

        // Ïö∞Ï∏°(ÏÑ†ÌÉùÎêú Î¶¨Ïä§Ìä∏) Í∑∏Î¶¨Îìú
        const rightMaterialColumns = makeEditableColumns(materialColumns);
        const rightMaterialGrid = new tui.Grid({
            el: document.getElementById('rightMaterialGrid'),
            bodyHeight: 250,
            columns: rightMaterialColumns,
            data: [],
            scrollX: true,
            scrollY: true,
            columnOptions: { resizable: true },
        });
        bindQuantityChangeHandler(rightMaterialGrid);


        // ===== Expenses Grid =====
        const expensesColumns = [
            { header: 'Ïû•ÎπÑÏΩîÎìú', name: 'rsce_cd', align: 'center', width: 120},
            { header: 'Ïû•ÎπÑÎ™Ö', name: 'rsce_nm', align: 'center', },
            { header: 'Í∑úÍ≤©', name: 'spec_nm', align: 'right', width: 80 },
            { header: 'Îã®ÏúÑ', name: 'unit', align: 'center',},
            { header: 'Ï¥ùÏàòÎüâ', name: 'total_qty', align: 'right',},
            { header: 'Í∏àÏùºÏàòÎüâ', name: 'actual_qty', align: 'right',},
            {
                header: 'Í∏àÏùºÎàÑÍ≥Ñ',
                name: 'acmtl_qty',
                align: 'right',
                width: 150,
                formatter: ({ row }) =>
                    (Number(row.ori_qty || 0) + Number(row.actual_qty || 0)).toFixed(2)
            },
            { header: 'ÏûîÏó¨', name: 'remndr_qty', align: 'right', },
            { header: 'rsce_tp_cd', name: 'rsce_tp_cd', hidden: true },
            { header: 'cntrct_chg_id', name: 'cntrct_chg_id', hidden: true },
            { header: 'manual_yn', name: 'manual_yn', hidden: true },
            { header: 'rsce_sno', name: 'rsce_sno', hidden: true },
            { header: 'ori_qty', name: 'ori_qty', hidden: true }
        ];

        // Ï¢åÏ∏°(Ï†ÑÏ≤¥ Î¶¨Ïä§Ìä∏) Í∑∏Î¶¨Îìú
        const leftExpensesGrid = new tui.Grid({
            el: document.getElementById('leftExpensesGrid'),
            bodyHeight: 250,
            columns: expensesColumns,
            data: [],
            scrollX: true,
            scrollY: true,
            columnOptions: { resizable: true },
        });

        // Ïö∞Ï∏°(ÏÑ†ÌÉùÎêú Î¶¨Ïä§Ìä∏) Í∑∏Î¶¨Îìú
        const rightExpensesColumns = makeEditableColumns(expensesColumns);
        const rightExpensesGrid = new tui.Grid({
            el: document.getElementById('rightExpensesGrid'),
            bodyHeight: 250,
            columns: rightExpensesColumns,
            data: [],
            scrollX: true,
            scrollY: true,
            columnOptions: { resizable: true },
        });
        bindQuantityChangeHandler(rightExpensesGrid);


        /**
         * editable Ïª¨ÎüºÏùÑ Î≥µÏ†úÌï¥ Î∞òÌôò
         * @param {Array} columns - ÏõêÎ≥∏ Ïª¨Îüº Î∞∞Ïó¥
         * @param {string} editableName - Ìé∏Ïßë Í∞ÄÎä•Ìïú Ïª¨ÎüºÎ™Ö (Ïòà: 'actual_qty')
         */
        function makeEditableColumns(columns, editableName = 'actual_qty') {
          return columns.map(col => {
            if (col.name === editableName) {
              return {
                ...col,
                editor: {
                  type: 'text',
                  options: { inputType: 'number' }
                },
                validation: {
                  dataType: 'number',
                  required: true,
                  validatorFn: (value) => !isNaN(value)
                }
              };
            }
            return { ...col, editable: false };
          });
        }

        /**
         * Ïà´Ïûê Î≥ÄÍ≤Ω Ïãú ÏûîÏó¨(remndr_qty), ÎàÑÍ≥Ñ(acmtl_qty) ÏûêÎèô Í≥ÑÏÇ∞
         * @param {tui.Grid} grid - ÎåÄÏÉÅ Í∑∏Î¶¨Îìú Í∞ùÏ≤¥
         */
        function bindQuantityChangeHandler(grid) {
          grid.on('afterChange', (ev) => {
            ev.changes.forEach(change => {
              const { rowKey, columnName, value } = change;
              if (columnName === 'actual_qty') {
                const row = grid.getRow(rowKey);
                const oriQty = Number(row.ori_qty || 0);
                const totalQty = Number(row.total_qty || 0);
                const actualQty = Number(value || 0);

                // ÏûîÏó¨(remndr_qty) = total_qty - (ori_qty + actual_qty)
                const remndrQty = totalQty - (oriQty + actualQty);

                grid.setValue(rowKey, 'remndr_qty', remndrQty.toFixed(2), false);
              }
            });
          });
        }



        function initData() {
            const param = {
                cntrctNo: cntrctNo,
                dailyReportId: rId,
                workDtType: 'TD',
                planStart: $("#sDate").val(),
                planFinish: $("#eDate").val(),
                searchText: $("#searchText").val()
            }
            gaiaCommon.post(
                BASEPATH + 'dailyreport/dailyreport-chg',
                param,
                function (response) {
                    const details = (response && response.details) || {};
                    let activityData = details.prActivityList || [];
                    let todayActivityData = details.todayDailyReportActivityList || [];

                    // activityGrid Îç∞Ïù¥ÌÑ∞ Ï§ë todayGridÏóê ÏóÜÎäî Ìï≠Î™©Îßå ÌïÑÌÑ∞ÎßÅ
                    const todayIds = new Set(todayActivityData.map(item => item.activity_id));
                    const filteredActivityData = activityData.filter(
                        item => !todayIds.has(item.activity_id)
                    );

                    // Ïï°Ìã∞ÎπÑÌã∞ Î™©Î°ù
                    activityGrid.resetData(filteredActivityData);
                    refreshGrid(activityGrid);

                    // Í∏àÏùº Ïï°Ìã∞ÎπÑÌã∞ Î™©Î°ù
                    // ‚òÖ ÏÉÅÌÉúÎ≥Ñ Î≥Ñ ÏÑ∏ÌåÖ
                    const dataWithStars = setStatusStars(todayActivityData);
                    todayGrid.resetData(dataWithStars);
                    refreshGrid(todayGrid);

                    initResourceData(todayActivityData);

                },
                function (error) {
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                }
            );
        }

        // ÏûêÏõê Îç∞Ïù¥ÌÑ∞ ÏÑ∏ÌåÖ
        function initResourceData(todayActivityData) {
            // activity_id & today_bohal ÏåçÎßå Ï∂îÏ∂úÌï¥ÏÑú activityIdAndTodayBohal Î∞∞Ïó¥ ÏÉùÏÑ±
            const activityIdAndTodayBohal = (todayActivityData || []).map(item => ({
                activityId: item.activity_id,
                todayBohal: item.today_bohal
            }));

            const param = {
                cntrctNo: cntrctNo,
                dailyReportId: rId,
                activityIdAndTodayBohal: activityIdAndTodayBohal
            };
            gaiaCommon.post(
                BASEPATH + 'dailyreport/dailyreport-today-resource',
                param,
                function (response) {
                    const details = (response && response.details) || {};
                    let activityResData = details.todayResourceList || [];
                    let todayResourceData = details.todayDailyReportResourceList || [];

                    // rsce_tp_cd ÏïûÍ∏ÄÏûê Í∏∞Ï§Ä Î∂ÑÎ•ò
                    const laborList = [];
                    const materialList = [];
                    const expensesList = [];
                    const todayLaborList = [];
                    const todayMaterialList = [];
                    const todayExpensesList = [];

                    // Ïò§Î•∏Ï™Ω Í∑∏Î¶¨Îìú ÏûêÏõê Î™©Î°ù Î∂ÑÎ•ò (Í∏∞Ï§Ä)
                    todayResourceData.forEach(item => {
                        const type = (item.rsce_tp_cd || '').substring(0, 1);
                        if (type === 'L') todayLaborList.push(item);
                        else if (type === 'M') todayMaterialList.push(item);
                        else if (type === 'E') todayExpensesList.push(item);
                    });

                    // Ïò§Î•∏Ï™Ω Í∑∏Î¶¨Îìú Í∏∞Ï§ÄÏúºÎ°ú Ï§ëÎ≥µ ÌïÑÌÑ∞ÎßÅÏö© Set ÏÉùÏÑ±
                    const todayLaborKeySet = new Set(todayLaborList.map(i => `${i.rsce_cd}_${i.govsply_mtrl_yn}`));
                    const todayMaterialKeySet = new Set(todayMaterialList.map(i => `${i.rsce_cd}_${i.govsply_mtrl_yn}`));
                    const todayExpensesKeySet = new Set(todayExpensesList.map(i => `${i.rsce_cd}_${i.govsply_mtrl_yn}`));

                    // ÏôºÏ™Ω Í∑∏Î¶¨Îìú ÏûêÏõê Î™©Î°ù Î∂ÑÎ•ò Î∞è Ï§ëÎ≥µ Ï†úÍ±∞
                    activityResData.forEach(item => {
                        const type = (item.rsce_tp_cd || '').substring(0, 1);
                        const key = `${item.rsce_cd}_${item.govsply_mtrl_yn || ''}`;
                        if (type === 'L' && !todayLaborKeySet.has(key)) {
                            laborList.push(item);
                        } else if (type === 'M' && !todayMaterialKeySet.has(key)) {
                            materialList.push(item);
                        } else if (type === 'E' && !todayExpensesKeySet.has(key)) {
                            expensesList.push(item);
                        }
                    });

                    // Ïù∏Î†•
                    leftLaborGrid.resetData(laborList);
                    rightLaborGrid.resetData(todayLaborList);
                    if (leftLaborGrid.refreshLayout) leftLaborGrid.refreshLayout();
                    if (rightLaborGrid.refreshLayout) rightLaborGrid.refreshLayout();
                    reportRefreshGrid(leftLaborGrid,);
                    reportRefreshGrid(rightLaborGrid);

                    // ÏûêÏû¨
                    leftMaterialGrid.resetData(materialList);
                    rightMaterialGrid.resetData(todayMaterialList);
                    if (leftMaterialGrid.refreshLayout) leftMaterialGrid.refreshLayout();
                    if (rightMaterialGrid.refreshLayout) rightMaterialGrid.refreshLayout();
                    reportRefreshGrid(leftMaterialGrid,);
                    reportRefreshGrid(rightMaterialGrid);

                    // Ïû•ÎπÑ
                    leftExpensesGrid.resetData(expensesList);
                    rightExpensesGrid.resetData(todayExpensesList);
                    if (leftExpensesGrid.refreshLayout) leftExpensesGrid.refreshLayout();
                    if (rightExpensesGrid.refreshLayout) rightExpensesGrid.refreshLayout();
                    reportRefreshGrid(leftExpensesGrid);
                    reportRefreshGrid(rightExpensesGrid);
                },
                function (error) {
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                }
            );
        }

        window.addEventListener('resize', () => {
          activityGrid.refreshLayout();
        });
        $("#cancel").click(function () {
            window.location.href = "/construction/dailyreport/detail"+`?rId=${rId}&pjtNo=${pjtInfo.pjtNo}&cntrctNo=${pjtInfo.cntrctNo}&_condition=init`;
            sessionStorage.setItem('cntrctNo', cntrctNo);
        });
        $("#edit").click(function () {
            window.location.href = "/construction/dailyreport-today-update?cntrctNo=" + cntrctNo + "&rId=" + rId+`&pjtNo=${pjtInfo.pjtNo}` + "&drDt=" + drDt;
            sessionStorage.setItem('cntrctNo', cntrctNo);
        });
        $(document).ready(()=>{
            gaia.create({
                $init: function ($params) {
                    gaiaPortal.navMenuInit('M0401', "{{ message('item.construction.901') }}" + " Í∏àÏùº Ïï°Ìã∞ÎπÑÌã∞ " + "{{ message('btn.003') }}");
                    $("#menuDepth").append('<li class=\"breadcrumb_item\" name=\"new_item\">{{ message("item.construction.901") }}  Í∏àÏùº Ïï°Ìã∞ÎπÑÌã∞ {{ message("btn.003") }}</li>');
                }
            });
            initData();
        });

        let reportRefreshGrid = function (...grids) {
            const _section = document.getElementById("content")

            if (!_section) return;

            let timer;
            const resizeObserver = new ResizeObserver(() => {
                clearTimeout(timer);

                timer = setTimeout(() => {
                    for (const grid of grids) {
                        if (!grid || !(grid instanceof tui.Grid)) continue;

                        const dataWidth = Number(elem.el.getAttribute("data-width"));

                        grid.el.setAttribute("data-width", dataWidth);

                        const newWidth = dataWidth;

                        // üî∏ 1. DOM width ÏßÅÏ†ë Î∞òÏòÅ (Ï¶âÏãú Î∞òÏùë)
                        grid.el.style.width = `${newWidth}px`;
                        grid.refreshLayout()
                    }
                }, 10);
            });

            resizeObserver.observe(_section);
        };
    </script>
{% endblock footer_script %}
{% extends 'layout/base_content' %} {% block head %}

{% endblock %} {% block content %}
<section class="contents_wrap g-col2 ty1">
    {% include "page/defecttracking/tool/common_tree" %}
    <article class="conts_area defect_conts">
        <div class="conts g-row">
            <div class="conts_grid">
                {% include "page/defecttracking/tool/common_select" %}
                <div class="conts_grid" id="page_contents">
                    <span class="tree_route" id="dfccy_phase_path">
                        {{ message('item.dfccy.016') }}
                    </span>
                    <div class="search_wrap">
                        <span class="selectbox">
                            <select name="dfccyType" id="selectbox_dfccy">
                                <!-- <option selected disabled value="">{{ message('item.dfccy.017') }}</option> -->
                            </select>
                        </span>
                        <span class="selectbox">
                            <select name="confirmStatus" id="selectbox_confirm">
                                <option selected disabled value="">{{ message('item.dfccy.049') }}</option>
                                <option value="all">{{ message('btn.038') }}</option>
                                <option value="qa">{{ message('item.dfccy.011') }}</option>
                                <option value="spvs">{{ message('item.dfccy.014') }}</option>
                                <option value="ing">{{ message('item.com.041') }}</option>
                                <option value="end">{{ message('item.dfccy.004') }}</option>
                            </select>
                        </span>
                        <!-- searchbox -->
                        <div class="searchbox_wrap defect_search">
                            <!-- 검색어 입력창 -->
                            <input type="text" id="search_text" placeholder="{{ message('item.dfccy.019') }},{{ message('item.com.060') }},{{ message('item.dfccy.020') }},{{ message('item.com.064') }}" onkeypress="if(event.keyCode == 13){page.search();}">
                            <!-- 상세검색 아이콘 -->
                            <button type="button" class="btn icon_btn filter" onclick="page.detailSearch.open();">
                                <i class="ic ic-setting-config"></i>
                                <span class="blind">{{ message('item.com.044') }}</span>
                            </button>
                            <!-- 일반검색 아이콘 -->
                            <button type="button" class="icon_btn search" onclick="page.search();">
                                <i class="ic ic-search"></i>
                                <span class="blind">검색</span>
                            </button>
                            <!-- 상세검색 검색창 ("lay_pop on"일때 보여짐) -->
                            <div class="lay_pop" data-name="search_detail">
                                <button type="button" class="lay_pop_close icon_btn" onclick="page.detailSearch.close();">
                                    <i class="ic ic-close"></i>
                                    <span class="blind">{{ message('item.com.037') }}</span>
                                </button>
                                <!-- 결함분류 -->
                                <div class="form_box ">
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dfccy.017') }}</div>
                                            <div class="form_data">
                                                <span class="selectbox">
                                                    <select name="detail_dfccyCd" id="detail_dfccyCd">
                                                        <!-- <option selected disabled value="">{{ message('item.dfccy.017') }}</option> -->
                                                    </select>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.com.064') }}</div>
                                            <div class="form_data">
                                                <input type="text" name="rgstrNm" id="rgstrNm" class="">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 내 작성 의견만 보기 -->
                                    <div class="row">
                                        <div class="col chkbox">
                                            <div class="form_label"></div>
                                            <div class="form_data detailSearch">
                                                <label class="form_check">
                                                    <input class="check_mark" type="checkbox" name="checkbox" id="detail_my_rplyYn" value="Y">
                                                    <span class="check_label">
                                                        {{ message('item.dfccy.021') }}
                                                    </span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 결함 ID -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dfccy.022') }}</div>
                                            <div class="form_data">
                                                <div class="item_group">
                                                    <!-- 숫자만 입력 -->
                                                    <input type="text" name="startDfccyNo" id="startDfccyNo" class="number maxlength" maxlength="10">
                                                    ~
                                                    <input type="text" name="endDfccyNo" id="endDfccyNo" class="number maxlength" maxlength="10">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Activity 명 -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.construction.052') }}</div>
                                            <div class="form_data">
                                                <input type="text" name="activityNm" id="activityNm" class="">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 답변 상태 -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dsgn.010') }}</div>
                                            <div class="form_data">
                                                <span class="selectbox">
                                                    <select name="detail_rplyCd" id="detail_rplyCd">
                                                        <option selected value="all">{{ message('btn.038') }}</option>
                                                        <option value="0201">{{ message('item.dfccy.024') }}</option>
                                                        <option value="0202">{{ message('item.dfccy.010') }}</option>
                                                        <option value="0203">{{ message('item.dsgn.003') }}</option>
                                                    </select>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- QA 결과 -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dfccy.050') }}</div>
                                            <div class="form_data">
                                                <div class="item_group selectbox">
                                                    <span class="selectbox">
                                                        <select name="detail_qa_status" id="detail_qa_status">
                                                            <option selected value="all">{{ message('btn.038') }}</option>
                                                            <option value="ing">{{ message('item.com.041') }}</option>
                                                            <option value="ok">{{ message('btn.004') }}</option>
                                                            <option value="end">{{ message('item.dfccy.004') }}</option>
                                                        </select>
                                                    </span>
                                                    <span class="selectbox">
                                                        <select name="detail_qaCd" id="detail_qaCd">
                                                            <option selected value="all">{{ message('btn.038') }}</option>
                                                            <option value="0301">{{ message('item.dfccy.012') }}</option>
                                                            <option value="0302">{{ message('item.dfccy.013') }}</option>
                                                            <option value="0303">{{ message('item.dfccy.004') }}</option>
                                                        </select>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 관리관결과 -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dfccy.051') }}</div>
                                            <div class="form_data">
                                                <div class="item_group selectbox">
                                                    <span class="selectbox">
                                                        <select name="detail_spvs_status" id="detail_spvs_status" style="min-width: 90px;">
                                                            <option selected value="all">{{ message('btn.038') }}</option>
                                                            <option value="ing">{{ message('item.com.041') }}</option>
                                                            <option value="ok">{{ message('btn.004') }}</option>
                                                            <option value="end">{{ message('item.dfccy.004') }}</option>
                                                        </select>
                                                    </span>
                                                    <span class="selectbox">
                                                        <select name="detail_spvsCd" id="detail_spvsCd">
                                                            <option selected value="all">{{ message('btn.038') }}</option>
                                                            <option value="0401">{{ message('item.dfccy.012') }}</option>
                                                            <option value="0402">{{ message('item.dfccy.013') }}</option>
                                                            <option value="0403">{{ message('item.dfccy.004') }}</option>
                                                        </select>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 최근입력기간 -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dsgn.013') }}</div>
                                            <div class="form_data">
                                                <div class="item_group">
                                                    <!-- 직접선택시 input type="date"를 "text"로 변경 -->
                                                    <input type="date" name="startRgstDt" id="startRgstDt" class="date" data-date-format="DD/MM/YYYY" onchange="page.detailSearch.setMinDate('startRgstDt', 'endRgstDt')">
                                                    ~
                                                    <input type="date" name="endRgstDt" id="endRgstDt" class="date" data-date-format="DD/MM/YYYY">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 중요 -->
                                    <div class="row">
                                        <div class="col chkbox">
                                            <div class="form_label"></div>
                                            <div class="form_data detailSearch">
                                                <label class="form_check">
                                                    <input class="check_mark" type="checkbox" name="checkbox" id="priorityCheck" value="Y">
                                                    <span class="check_label">
													{{ message('item.dfccy.083') }}
												</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 생명/보건/안전 관련 -->
                                    <div class="row">
                                        <div class="col chkbox">
                                            <div class="form_label"></div>
                                            <div class="form_data detailSearch">
                                                <label class="form_check">
                                                    <input class="check_mark" type="checkbox" name="checkbox" id="crtcIsueYn" value="Y">
                                                    <span class="check_label">
                                                        {{ message('item.dfccy.026') }}
                                                    </span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 첨부 파일 있음 -->
                                    <div class="row">
                                        <div class="col chkbox">
                                            <div class="form_label"></div>
                                            <div class="form_data detailSearch">
                                                <label class="form_check">
                                                    <input class="check_mark" type="checkbox" name="checkbox" id="atachYn" value="Y">
                                                    <span class="check_label">
                                                        {{ message('item.dfccy.027') }}
                                                    </span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div class="btn_group _fill s_small jc_e">
                                    <button type="button" class="btn" onclick="page.detailSearch.setSearch()">{{message('btn.014') }}</button>
                                    <button type="button" class="btn" onclick="page.detailSearch.reset();">{{message('btn.024')}}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- // E: search wrap ---------------------------------------------- -->

                    <!-- S: 상세검색에서 선택된 항목 표시 -->
                    <p class="selected_list"></p>
                    <!-- E: 상세검색에서 선택된 항목 표시 -->

                    <div class="toolbar dfccy_btn">
                        <div class="btn_area s_default _outline" style="height: 40px;">
                            {{ btnHtml | raw }}
                            <div class="slick_nav" style="top: unset;right: 28px;">
                                <span class="folder_doc">
                                    <i class="ic ic-note"></i>
                                    <span class="tooltip">파일개수</span>
                                    <b class="num" id="list_cnt">0</b>
                                </span>
                                <div class="slick_paging">
                                    <!-- <b class="page">1</b> / 2 -->
                                </div>
                                <div class="btn_area slick_indigator" style="margin-top: unset;">
                                    <div class="btn_group _outline">
                                        <button type="button" class="btn icon_btn prev">
                                            <span class="blind">이전</span>
                                        </button>
                                        <button type="button" class="btn icon_btn next">
                                            <span class="blind">다음</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="gridContainer defect_grid">
                        <div id="grid">
                            <table class="table ta_c" style="table-layout: fixed">
                                <colgroup>
                                    <col width="100px">
                                    <col width="130px">
                                    <col width="7%">
                                    <col width="10%">
                                    <col>
                                    <col width="7%">
                                    <col>
                                    <col width="7%">
                                    <col width="7%">
                                    <col width="7%">
                                    <col width="7%">
                                    <col width="7%">
                                </colgroup>
                                <thead>
                                <tr>
                                    <th rowspan="2">
                                        <label class="form_check" style="display: block;">
                                            <input type="checkbox" id="checkAll" class="check_mark">
                                            <span class="check_label blind">{{message('item.com.005')}}</span>
                                        </label>
                                    </th>
                                    <th rowspan="2" style="width: 130px">ID</th>
                                    <th rowspan="2">{{message('item.com.064')}}</th>
                                    <th rowspan="2">결함등록일</th>
                                    <th rowspan="2" class="resizable">{{message('item.app.001')}} <div class="resizer"></div></th>
                                    <th rowspan="2">{{message('item.dfccy.017')}}</th>
                                    <th rowspan="2">{{message('item.construction.052')}}</th>
                                    <th colspan="2">{{message('item.dfccy.011')}}</th>
                                    <th colspan="2">{{message('item.dfccy.014')}}</th>
                                    <th rowspan="2">{{ message('item.dfccy.072') }}</th>
                                </tr>
                                <tr>
                                    <th width="7%">{{message('item.dfccy.030')}}</th>
                                    <th width="7%">{{message('item.dfccy.031')}}</th>
                                    <th width="7%">{{message('item.dfccy.030')}}</th>
                                    <th width="7%">{{message('item.dfccy.031')}}</th>
                                </tr>
                                </thead>
                                <tbody class="ty_list" id="dfccyList">
                                </tbody>
                            </table>
                        </div>
                        <div id="popup">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </article>

    <!-- 변경이력 모달 -->
    <div class="modal" id="historyModal">
        <div class="pop_box _sm">
            <div class="pop_header">
                <h5 class="pop_tit"><span id="histoyType"></span> {{message('item.dfccy.055')}}</h5>
                <div class="btn_area">
                    <button type="button" class="icon_btn pop_close" onclick="page.historyModal.close();">
                        <i class="ic ic-close"></i>
                        <span class="blind">창닫기</span>
                    </button>
                </div>
            </div>
            <div class="pop_body">
                <table class="table ta_c">
                    <thead>
                    <tr>
                        <th width="15%">{{message('item.dfccy.056')}}</th>
                        <th width="25%">{{message('btn.010')}}</th>
                        <th width="30%">{{message('item.com.064')}}</th>
                        <th width="30%">{{message('item.com.063')}}</th>
                    </tr>
                    </thead>
                    <tbody class="ty_list" id="historyList">
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</section>
{% endblock content %} {% block footer_script %}

<script>
    const dfccyPhaseCd = "0103";    // 구분: 결함사항
    let urlParams = new URLSearchParams(window.location.search);
    var dfccyPhaseNo = urlParams.get("dfccyPhaseNo") ?? null;
    var searchForm = {};
    var currentPage = 1;
    var itemsPerPage = 10;
    var currentDfccyNo = null;
    var isQa = '{{isQa}}' === 'true' ? true : false;
    var isSpvs = '{{isSpvs}}' === 'true' ? true : false;
    let isDelAuth = '{{ isDelAuth }}' === 'true' ? true : false;

    var page = {
        init(curPage) {
            $('#page_contents').show();

            if(isEnd) {
                $("#deleteBtn").hide();
                $("#finishQaBtn").hide();
                $("#finishSvBtn").hide();
            } else {
                $("#deleteBtn").show();
                $("#finishQaBtn").show();
                $("#finishSvBtn").show();
            }

            currentDfccyNo = null;

            if(!curPage) currentPage = 1;

            this.inputForm.close();
            $(".check_mark").prop("checked", false);

            // page.resetSelectbox();

            // page.detailSearch.reset();
            // $('.selected_list').removeClass('on');
            // $('.selected_list').empty();

            let urlParam = new URLSearchParams(window.location.search);
            let qaCd = urlParam.get("detail_qa_status");
            let spvsCd = urlParam.get("detail_spvsCd");
            let dfccyCd = urlParam.get("dfccyCd");
            let rgstrNm = urlParam.get("rgstrNm");

            if(qaCd || spvsCd || dfccyCd || rgstrNm) {
                if(qaCd) $("select[name='detail_qaCd']").val(qaCd);
                if(spvsCd) $("select[name='detail_spvsCd']").val(spvsCd);
                if(dfccyCd) $("select[name='detail_dfccyCd']").val(dfccyCd);
                if(rgstrNm) $("#rgstrNm").val(rgstrNm);
                history.replaceState(null, null, window.location.pathname+`?pjtNo=${pjtNo}&cntrctNo=${cntrctNo}`);
                page.detailSearch.setSearch();
            } else {
                page.read(currentPage);
            }

            gaia.loaded = true;
        },
        inputForm: {
            toggle(dfccyNo) {
                if (currentDfccyNo === dfccyNo) {
                    this.close(dfccyNo);
                } else {
                    this.open(dfccyNo)
                }
            },
            open(dfccyNo) {
                gaiaCommon.checkAuth("DT_CONFIRM_CU", () => {
                    $('.gridContainer').addClass('active');
                    $(`#tr_${dfccyNo}`).next('.more_info').addClass('open');
                    $("#popup").load(`/defectTracking/verificationForm?pjtNo=${pjtNo}&cntrctNo=${cntrctNo}`);
                    currentDfccyNo = dfccyNo;
                });
            },
            close(dfccyNo) {
                $('.gridContainer').removeClass('active');
                $("#popup").empty();
                currentDfccyNo = null;
                $(`#tr_${dfccyNo}`).removeClass("selected-row");
                $(`#tr_${dfccyNo}`).next(".more_info").removeClass("open");
            }
        },
        historyModal: {
            open(cnfrmDiv){
                let type = cnfrmDiv === '01' ? "QA" : "{{message('item.dfccy.071')}}"
                $('#histoyType').text(type);
                $('#historyModal').addClass('open');
                $('#historyList').children().empty();
                let params = {
                    dfccyNo: currentDfccyNo,
                    cnfrmDiv: cnfrmDiv
                }
                $.ajax({
                    url: `/api/defecttracking/verification/history`,
                    method: 'POST',
                    dataType: 'json',
                    contentType: 'application/json; charset-utf-8',
                    data: JSON.stringify(params),
                    success: function (data) {
                        let list = data.details.historyList;
                        if(list && list.length > 0) {
                            list.forEach(row => {
                                $('#historyList').append(
                                    `<tr>
                                        <td>${row.rnum}</td>
                                        <td>${row.cnfrm_cd_nm}</td>
                                        <td>${row.rgstr_nm}</td>
                                        <td>${row.rgst_dt}</td>
                                    </tr>`
                                );
                            })
                        } else {
                            $('#historyList').append(
                                `<tr>
                                    <td colspan="4">{{message('msg.dfccy.009')}}</td>
                                </tr>`
                            );
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(status, error);
                        gaiaCommon.customAlert("{{ message('msg.060') }}");
                    }
                })

            },
            close(){
                $('#historyModal').removeClass('open');
            }
        },
        detailSearch: {
            open(){
                $("[data-name='search_detail']").addClass("on");
                this.reset();
            },
            close(){
                $("[data-name='search_detail']").removeClass("on");
            },
            reset(){
                // `lay_pop` 클래스 하위의 모든 입력 요소 선택
                const layPopElements = document.querySelector(".lay_pop");

                if (layPopElements) {
                    // 모든 input 요소 초기화
                    layPopElements.querySelectorAll("input").forEach(input => {
                        if (input.type === "checkbox" || input.type === "radio") {
                            input.checked = false; // 체크박스 및 라디오 버튼 초기화
                        } else {
                            input.value = ""; // 일반 입력 필드 초기화
                        }
                    });

                    // 모든 select 요소 초기화
                    layPopElements.querySelectorAll("select").forEach(select => {
                        select.selectedIndex = 0; // 첫 번째 옵션으로 설정
                    });

                    // 상세 검색 데이터 초기화
                    Object.keys(searchForm).forEach(key => {
                        searchForm[key] = null;
                    });
                }
            },
            setMinDate(startDtId, endDtId) {
                var startDate = new Date($(`#${startDtId}`).val());
                startDate.setDate(startDate.getDate() + 1);
                var minEndDate = startDate.toISOString().split('T')[0];
                $(`#${endDtId}`).attr('min', minEndDate);
            },
            setSearch(){
                $('.selected_list').addClass('on');
                $('.selected_list').empty();

                page.resetSelectbox();

                const dfccyCd = $("select[name='detail_dfccyCd']").val();
                const rgstrNm = $("#rgstrNm").val();
                const myRplyYn = $("input[id='detail_my_rplyYn']:checked").val();
                const startDfccyNo = $('#startDfccyNo').val();
                const endDfccyNo = $('#endDfccyNo').val();
                const activityNm = $('#activityNm').val();
                const rplyCd = $("select[name='detail_rplyCd']").val();
                const qaStatus = $("select[name='detail_qa_status']").val();
                const qaCd = $("select[name='detail_qaCd']").val();
                const spvsStatus = $("select[name='detail_spvs_status']").val();
                const spvsCd = $("select[name='detail_spvsCd']").val();
                let startRgstDt = $('#startRgstDt').val();
                let endRgstDt = $('#endRgstDt').val();
                const priorityCheck = $("input[id='priorityCheck']:checked").val();
                const crtcIsueYn = $("input[id='crtcIsueYn']:checked").val();
                const atachYn = $("input[id='atachYn']:checked").val();

                searchForm = {
                    dfccyCd: dfccyCd && dfccyCd !== "all" ? dfccyCd : null,
                    rgstrNm: rgstrNm ?? null,
                    myRplyYn: myRplyYn ?? null,
                    startDfccyNo: startDfccyNo || null,
                    endDfccyNo: endDfccyNo || null,
                    activityNm: activityNm || null,
                    rplyCd: rplyCd && rplyCd !== "all" ? rplyCd : null,
                    qaStatus: qaStatus && qaStatus !== "all" ? qaStatus : null,
                    qaCd: qaCd && qaCd !== "all" ? qaCd : null,
                    spvsStatus: spvsStatus && spvsStatus !== "all" ? spvsStatus : null,
                    spvsCd: spvsCd && spvsCd !== "all" ? spvsCd : null,
                    startRgstDt: startRgstDt ?? null,
                    endRgstDt: endRgstDt ?? null,
                    priorityCheck: priorityCheck ?? null,
                    crtcIsueYn: crtcIsueYn ?? null,
                    atachYn: atachYn ?? null
                }

                // 결함 분류
                if (dfccyCd && dfccyCd !== "all") {
                    $('select[id="dfccyCd"]').val(dfccyCd); // 그리드 결함 구분 값 설정.

                    let dfccyCdText = $("#detail_dfccyCd option:selected").text();
                    let keywordHtml = `
					<span class="selected_item detailDfCd">
						<span class="item dfCd">${dfccyCdText}</span>
						<input type="hidden" name="detail_dfccyCd" data-name="dfccyCd" value="${dfccyCd}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailDfCd')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                    $('.selected_list').append(keywordHtml);
                }

                // 작성자
                if (rgstrNm) {
                    let keywordHtml = `
					<span class="selected_item detailRgstr">
						<span class="item rgstr">${rgstrNm}</span>
						<input type="hidden" name="detail_rgstr" data-name="rgstrNm" value="${rgstrNm}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailRgstr')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                    $('.selected_list').append(keywordHtml);
                }

                // 결함번호 범위
                if (startDfccyNo || endDfccyNo) {
                    let combinedValue = `${startDfccyNo} ~ ${endDfccyNo}`;
                    let keywordHtml = `
					<span class="selected_item detailDfId">
						<span class="item dfId">${combinedValue}</span>
						<input type="hidden" name="startDfccyNo" data-name="startDfccyNo" value="${startDfccyNo}">
						<input type="hidden" name="endDfccyNo" data-name="endDfccyNo" value="${endDfccyNo}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailDfId')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                    $('.selected_list').append(keywordHtml);
                }

                // Activity 이름
                if (activityNm) {
                    let keywordHtml = `
					<span class="selected_item detailNm">
						<span class="item acNm">${activityNm}</span>
						<input type="hidden" name="activityNm" data-name="activityNm" value="${activityNm}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailNm')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                    $('.selected_list').append(keywordHtml);
                }

                // 답변 상태
                if (rplyCd) {
                    if(rplyCd !== "all"){
                        let rplyCdText = $("#detail_rplyCd option:selected").text();
                        // let combinedValue = `${rplyStatusText} | ${rplyCdText}`;
                        let keywordHtml = `
						<span class="selected_item detailRply">
							<span class="item rply">${rplyCdText}</span>
							<input type="hidden" name="detail_rplyCd" data-name="rplyCd" value="${rplyCd}">
							<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailRply')">
								<i class="ic ic-close"></i>
								<span class="blind">{{ message('btn.002') }}</span>
							</button>
						</span>
					`;
                        $('.selected_list').append(keywordHtml);
                    }
                }

                // QA 결과
                if (qaStatus && qaCd) {
                    if(qaStatus !== "all" || qaCd !== "all"){
                        let qaStatusText = $("#detail_qa_status option:selected").text();
                        let qaCdText = $("#detail_qaCd option:selected").text();
                        let combinedValue = `${qaStatusText} | ${qaCdText}`;
                        let keywordHtml = `
						<span class="selected_item detailQa">
							<span class="item qa">${combinedValue}</span>
							<input type="hidden" name="detail_qa_status" data-name="qaStatus" value="${qaStatus}">
							<input type="hidden" name="detail_qaCd" data-name="qaCd" value="${qaCd}">
							<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailQa')">
								<i class="ic ic-close"></i>
								<span class="blind">{{ message('btn.002') }}</span>
							</button>
						</span>
					`;
                        $('.selected_list').append(keywordHtml);
                    }
                }

                // 관리관 결과
                if (spvsStatus && spvsCd) {
                    if(spvsStatus !== "all" || spvsCd !== "all"){
                        let spvsStatusText = $("#detail_spvs_status option:selected").text();
                        let spvsCdText = $("#detail_spvsCd option:selected").text();
                        let combinedValue = `${spvsStatusText} | ${spvsCdText}`;
                        let keywordHtml = `
						<span class="selected_item detailSpvs">
							<span class="item spvs">${combinedValue}</span>
							<input type="hidden" name="detail_spvs_status" data-name="spvsStatus" value="${spvsStatus}">
							<input type="hidden" name="detail_spvsCd" data-name="spvsCd" value="${spvsCd}">
							<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailSpvs')">
								<i class="ic ic-close"></i>
								<span class="blind">{{ message('btn.002') }}</span>
							</button>
						</span>
					`;
                        $('.selected_list').append(keywordHtml);
                    }
                }

                // 날짜 범위
                if (startRgstDt || endRgstDt) {
                    let combinedValue = `${startRgstDt} ~ ${endRgstDt}`;
                    let keywordHtml = `
					<span class="selected_item detailRgstDt">
						<span class="item rgstDt">${combinedValue}</span>
						<input type="hidden" name="startRgstDt" data-name="startRgstDt" value="${startRgstDt}">
						<input type="hidden" name="endRgstDt" data-name="endRgstDt" value="${endRgstDt}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailRgstDt')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                    $('.selected_list').append(keywordHtml);
                }

                // 첨부 파일
                if (atachYn) {
                    let keywordHtml = `
					<span class="selected_item detailAtachYn">
						<span class="item ">{{ message('item.com.062') }} O</span>
						<input type="hidden" name="atachYn" data-name="atachYn" value="${atachYn}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailAtachYn')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                    $('.selected_list').append(keywordHtml);
                }

                // 중요
                if (priorityCheck) {
                    let keywordHtml = `
                        <span class="selected_item detailPriorityCheck">
                            <span class="item ">{{ message('item.dfccy.083') }} O</span>
                            <input type="hidden" name="priorityCheck" data-name="priorityCheck" value="${priorityCheck}">
                            <button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailPriorityCheck')">
                                <i class="ic ic-close"></i>
                                <span class="blind">{{ message('btn.002') }}</span>
                            </button>
                        </span>
                    `;
                    $('.selected_list').append(keywordHtml);
                }

                // 생명/보건/안전
                if (crtcIsueYn) {
                    let keywordHtml = `
					<span class="selected_item detailCrtcIsueYn">
						<span class="item ">{{ message('item.dfccy.037') }} O</span>
						<input type="hidden" name="crtcIsueYn" data-name="crtcIsueYn" value="${crtcIsueYn}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailCrtcIsueYn')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                    $('.selected_list').append(keywordHtml);
                }

                // 내 의견
                if (myRplyYn) {
                    let keywordHtml = `
					<span class="selected_item detailMyRplyYn">
						<span class="item ">{{ message('item.dfccy.007') }} O</span>
						<input type="hidden" name="detail_my_rplyYn" data-name="myRplyYn" value="${myRplyYn}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailMyRplyYn')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                    $('.selected_list').append(keywordHtml);
                }

                // 선택된 검색 필터가 없으면 selected_list를 비활성화
                if ($('.selected_list').children().length === 0) {
                    $('.selected_list').removeClass('on');
                }
                page.detailSearch.close();
                page.inputForm.close();
                currentPage = 1;
                page.read(currentPage);
            },
            delete(keyword){
                let selectedItem = $(`.${keyword}`).closest('.selected_item');
                let hiddenInputs = selectedItem.find('input[type="hidden"]');
                hiddenInputs.each((index, input) => {
                    let key = $(input).attr('data-name');
                    searchForm[key] = null;
                });

                selectedItem.remove();

                if ($('.selected_list').children().length === 0) {
                    $('.selected_list').removeClass('on');
                }

                currentPage = 1;
                page.read(currentPage);
            }
        },
        getDfccySelectbox(){
            $('#selectbox_dfccy').empty().append(`<option selected disabled value="">{{ message('item.dfccy.017') }}</option>`);
            $('#detail_dfccyCd').empty().append(`<option selected disabled value="">{{ message('item.dfccy.017') }}</option>`);

            $.ajax({
                url: "/api/defecttracking/verification/dfccy-selectbox",
                method: "GET",
                success: function (data) {
                    let dfccyCdList = data.details.dfccySelectbox;
                    $.each(dfccyCdList, function (index, obj) {
                        $('#selectbox_dfccy').append(`<option value="${obj.cmn_cd}">${obj.cmn_cd_nm_krn}</option>`);
                        $('#detail_dfccyCd').append(`<option value="${obj.cmn_cd}">${obj.cmn_cd_nm_krn}</option>`);
                    })
                },
                error: function (xhr, status, error) {
                    console.error(status, error);
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                }
            });
        },
        resetSelectbox(){
            $('#search_text').val('');
            $('#selectbox_confirm').val('');
            $('#selectbox_dfccy').val('');
        },
        search(){
            let dfccyCd = $('#selectbox_dfccy').val();
            let confirmStatus = $('#selectbox_confirm').val();
            let keyword = $('#search_text').val();

            searchForm = {}

            searchForm = {
                dfccyCd: dfccyCd,
                confirmStatus: confirmStatus,
                keyword: keyword
            }
            currentPage = 1;
            page.read(currentPage);
        },
        read(curPage, curDfccyNo){
            let params = {
                page: curPage,
                size: itemsPerPage,
                dfccyPhaseNo: dfccyPhaseNo,
                cntrctNo: $("#cntrctNo").val(),
                dfccyPhaseCd: dfccyPhaseCd,
                ...searchForm
            }
            $.ajax({
                url: '/api/defecttracking/verification/list',
                method: 'POST',
                dataType: 'json',
                contentType: 'application/json; charset-utf-8',
                data: JSON.stringify(params),
                success: function (data) {
                    let list = data.details.dfccyList;
                    let totalCount = data.details.totalCount;
                    let totalPages = Math.ceil(totalCount / itemsPerPage);

                    // 페이지네이션 업데이트
                    page.updatePagination(curPage, totalPages);

                    $('#list_cnt').text(totalCount);

                    if(list && list.length > 0) {
                        $('#dfccyList').empty();

                        list.forEach((dfccyList, index) => {
                            // null이면 빈 문자열로 대체
                            var dfccyNo = dfccyList.dfccy_no ?? "";
                            var rgstrNm = dfccyList.rgstr_nm ?? "";
                            var title = dfccyList.title ?? "";
                            var dfccyCdNm = dfccyList.dfccy_cd_krn ?? "";
                            var activityIds = dfccyList.activity_nms ?? "";
                            var qaStatus = dfccyList.qa_status ? page.convert(dfccyList.qa_status) : "";
                            var qaResult = dfccyList.qa_cd_nm ?? "";
                            var spvsStatus = dfccyList.spvs_status ? page.convert(dfccyList.spvs_status) : "";
                            var spvsResult = dfccyList.spvs_cd_nm ?? "";
                            var rplyStatus = dfccyList.rply_cd_nm ?? "";
                            var rplyNm = dfccyList.rply_nm ?? "";
                            var rplyCntnts = dfccyList.rply_cntnts ?? "";
                            var rplyDt = dfccyList.rply_dt ?? "";
                            var dfccyLct = dfccyList.dfccy_lct ?? "";
                            var dfccyCntnts = dfccyList.dfccy_cntnts ?? "";
                            var rgstDt = dfccyList.rgst_dt ?? "";
                            var crtcIsueYn = dfccyList.crtc_isue_yn ?? "";
                            var priorityCheck = dfccyList.priority_check ?? "";
                            var edCdNm = dfccyList.ed_cd ? dfccyList.ed_cd === '0501' ? "{{ message('item.dfccy.012') }}" : "{{ message('item.dfccy.015') }}" : "";

                            // 결함 첨부파일
                            var dfccyFiles = dfccyList.dfccyFiles;
                            let dfccyFileHtml = "";
                            if (dfccyFiles && dfccyFiles.length > 0) {
                                dfccyFileHtml = page.makeFileHtml(dfccyFiles);
                            }

                            // 답변 첨부파일
                            var replyFiles = dfccyList.replyFiles;
                            let replyFileHtml = "";
                            if (replyFiles && replyFiles.length > 0) {
                                replyFileHtml = page.makeFileHtml(replyFiles);
                            }

                            var dfccyList = `
                                <tr class="dfccy-row" id="tr_${dfccyNo}">
                                    <td>
                                        <div class="item_group">
                                            <label class="form_check">
                                                <input class="chk_list check_mark" type="checkbox" name="select_check">
                                                <span class="check_label blind">선택</span>
                                            </label>
                                            ${isDelAuth && !isEnd ? `<button type="button" class="icon_btn" onclick="page.delete(this)">
                                                                        <i class="ic ic-delete"></i>
                                                                        <span class="blind">삭제</span>
                                                                    </button>` : ""}
                                        </div>
                                    </td>
                                    <td>
                                        <a><span>${dfccyNo}</span></a>
                                        <button type="button" class="icon_btn detail-btn" style="display:none;">
                                            <i class="ic ic-sent-to-back"></i>
                                            <span class="blind">상세정보</span>
                                        </button>
                                    </td>
                                    <td data-dfccy-no=${dfccyNo}>${rgstrNm}</td>
                                    <td data-dfccy-no=${dfccyNo}>${rgstDt.slice(0, 10)}</td>
                                    <td data-dfccy-no=${dfccyNo} style="text-align: left;" ${priorityCheck === 'Y' ? 'class="dfccy_priority"' : ''}>${title}</td>
                                    <td data-dfccy-no=${dfccyNo}>${dfccyCdNm}</td>
                                    <td>
                                        <div class="dfccy_activity">
                                            <a href="javascript:void(0);" onclick="page.activityOpen(${dfccyNo})" class="activity_link">${activityIds}</a>
                                        </div>
                                        <button type="button" class="icon_btn act-btn" onclick="page.activityOpen(${dfccyNo})" style="display:none;">
                                            <i class="ic ic-sent-to-back"></i>
                                            <span class="blind">{{message('item.dfccy.033')}}</span>
                                        </button>
                                    </td>
                                    <td data-dfccy-no=${dfccyNo}>${qaStatus}</td>
                                    <td data-dfccy-no=${dfccyNo}>${qaResult}</td>
                                    <td data-dfccy-no=${dfccyNo}>${spvsStatus}</td>
                                    <td data-dfccy-no=${dfccyNo}>${spvsResult}</td>
                                    <td data-dfccy-no="${dfccyNo}">${edCdNm}</td>
                                    <input type="hidden" data-ed-cd=${dfccyList.ed_cd}></input>
                                    <input type="hidden" data-qa-cd=${dfccyList.qa_cd}></input>
                                    <input type="hidden" data-spvs-cd=${dfccyList.spvs_cd}></input>
                                </tr>
                                <tr class="more_info">
                                    <td colspan="12" class="ta_l" style="position: relative;">
                                        <dl class="more_data">
                                            <button type="button" class="lay_pop_close icon_btn" style="position: absolute;">
                                                <i class="ic ic-close"></i>
                                                <span class="blind">{{ message('item.com.037') }}</span>
                                            </button>
                                            <dt>{{ message('item.dfccy.083') }}</dt>
                                            <dd> <input class="check_mark" type="checkbox" name="" id="" ${priorityCheck === 'Y' ? 'checked' : ''} disabled>
                                            </dd>
                                            <dt>{{message('item.dfccy.026')}}</dt>
                                            <dd> <input class="check_mark " type="checkbox" name="checkboxgroup" ${crtcIsueYn === 'Y' ? 'checked' : ''} disabled>
                                            </dd>
                                            <dt>{{message('item.dfccy.034')}}</dt>
                                            <dd>${dfccyLct}</dd>
                                            <dt>{{message('item.dfccy.035')}}</dt>
                                            <dd><pre>${gaiaCommon.safeText(gaiaCommon.decodeSafeText(dfccyCntnts))}</pre></dd>
                                            <dt>{{message('item.com.063')}}</dt>
                                            <dd>${rgstDt}</dd>
                                            <dt>{{message('item.com.062')}}</dt>
                                            <dd>
                                                <div class="attach_area">
                                                    <p class="data_info ${dfccyFiles && dfccyFiles.length > 0 ? 'hide' : ''}">
                                                        {{message('msg.029')}} </p>
                                                    <div class="attach_list ${dfccyFiles && dfccyFiles.length > 0 ? '' : 'hide'}" style="width: 100%;">
                                                        <ul class="file_header">
                                                            <li class="header_item">
                                                                <div class="icon_btn">
                                                                    <i class="ic ic-folder-open" id="fileIcon"></i>
                                                                    <span class="blind">{{message('item.com.020')}}</span>
                                                                </div>
                                                                <span class="f_name">{{message('item.com.020')}}</span>
                                                            </li>
                                                        </ul>
                                                        ${dfccyFileHtml}
                                                    </div>
                                                </div>
                                            </dd>
                                            <h2>{{message('item.dfccy.008')}}</h2>
                                            <hr />
                                        </dl>
                                        <dl class="more_data">
                                            <div>
                                                <span class="name_color">${rplyNm}</span>
                                                <span>${rplyDt}</span>
                                            </div>
                                        </dl>
                                        <dl class="more_data">
                                            <dt>{{message('item.dfccy.039')}}</dt>
                                            <dd>${rplyStatus}</dd>
                                            <dt>{{message('item.dfccy.040')}}</dt>
                                            <dd><pre>${gaiaCommon.safeText(gaiaCommon.decodeSafeText(rplyCntnts))}</pre></dd>
                                            <dt>{{message('item.com.062')}}</dt>
                                            <dd>
                                                <div class="attach_area">
                                                    <p class="data_info ${replyFiles && replyFiles.length > 0 ? 'hide' : ''}">
                                                        {{message('msg.029')}} </p>
                                                    <div class="attach_list ${replyFiles && replyFiles.length > 0 ? '' : 'hide'}" style="width: 100%;">
                                                        <ul class="file_header">
                                                            <li class="header_item">
                                                                <div class="icon_btn">
                                                                    <i class="ic ic-folder-open" id="fileIcon"></i>
                                                                    <span class="blind">{{message('item.com.020')}}</span>
                                                                </div>
                                                                <span class="f_name">{{message('item.com.020')}}</span>
                                                            </li>
                                                        </ul>
                                                        ${replyFileHtml}
                                                    </div>
                                                </div>
                                            </dd>
                                        </dl>
                                    </td>
                                </tr>
                                `;
                            $("#dfccyList").append(dfccyList);
                        });

                        if(curDfccyNo) {
                            currentDfccyNo = curDfccyNo;
                            $(`#tr_${curDfccyNo}`).addClass('selected-row');
                            $(`#tr_${curDfccyNo}`).next('.more_info').addClass('open');

                            gaiaCommon.checkAuth("DT_CONFIRM_CU", () => {
                                $("#popup").load(`/defectTracking/verificationForm?pjtNo=${pjtNo}&cntrctNo=${cntrctNo}`);
                            });
                        }
                    } else {
                        $("#dfccyList").children().empty();
                        $("#dfccyList").append(`<tr>
                                                    <td colspan="12">
                                                        <div style="display: inline-block;">
                                                            <p class="data_info">
                                                                {{message('msg.091')}}
                                                            </p>
                                                        </div>
                                                    </td>
                                                </tr>`);
                    }
                },
                error: function (xhr, status, error) {
                    console.error(status, error);
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                }
            })
        },
        deleteAll(){
            let delDfccyList = [];
            // let goDelete = true;
            $('input:checkbox[name=select_check]:checked').each(function(){
                let dfccyNo = $(this).closest('tr').find("[data-dfccy-no]").data("dfccy-no");
                let edStatus = $(this).closest('tr').find("[data-ed-cd]").data("ed-cd");

                // 등록기간이 종료됐거나 종결처리 됐으면 삭제불가
                if(edStatus === '0502' || isEnd) {
                    return;
                }
                // if (edStatus === '0502') {
                    // gaiaCommon.customAlert("{{message('msg.dfccy.010')}}");
                    // goDelete = false;
                    // return;
                // }

                // if(isEnd) {
                    // gaiaCommon.customAlert("{{message('msg.dfccy.011')}}");
                    // goDelete = false;
                    // return;
                // }

                delDfccyList.push({dfccyNo: dfccyNo});
            })

            // if(!goDelete) {
            //     return
            // }

            let data = {
                delDfccyList: delDfccyList
            }

            gaiaCommon.customConfirm("{{message('item.dfccy.052')}}", "{{message('msg.dfccy.012')}}", "{{message('msg.dfccy.013')}}", function(){
                $.ajax({
                    url: '/api/defecttracking/verification/delete-list',
                    method: 'POST',
                    dataType: 'json',
                    contentType: 'application/json; charset-utf-8',
                    data: JSON.stringify(data),
                    success: function(result) {
                        gaiaCommon.customAlert("{{message('msg.006')}}", function(){
                            page.init(currentPage);
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error(status, error);
                        gaiaCommon.customAlert("{{ message('msg.monthlyreport.003') }}");
                    }
                })
            });
        },
        finishAll(auth){
            let finishList = [];
            // let goFinish = false;
            let type = auth === 'qa' ? 'QA' : "{{message('item.dfccy.071')}}";
            let urlType = auth === 'qa' ? 'qa' : 'spvs';
            let chkLength = $('input:checkbox[name=select_check]:checked').length;
            if(chkLength === 0) {
                gaiaCommon.customAlert("{{message('msg.021')}}");
                return
            }

            page.validate(auth);

            $('input:checkbox[name=select_check]:checked').each(function(){
                let dfccyNo = $(this).closest('tr').find("[data-dfccy-no]").data("dfccy-no");
                let edCd = $(this).closest('tr').find("[data-ed-cd]").data("ed-cd");
                let qaCd = $(this).closest('tr').find("[data-qa-cd]").data("qa-cd");
                let spvsCd = $(this).closest('tr').find("[data-spvs-cd]").data("spvs-cd");

                if(auth === 'qa' && qaCd === '0303') {
                    return;
                }

                if(auth === 'sp' && spvsCd === '0403') {
                    return;
                }

                if (edCd === '0502') {
                    return;
                }

                finishList.push({
                    dfccyNo: dfccyNo,
                    cntrctNo: cntrctNo,
                    cnfrmDiv: auth === 'qa' ? '01' : '02',
                    cnfrmCd: auth === 'qa' ? '0303' : '0403'
                });
                // goFinish = true;
            })

            // if(!goFinish) {
            //     return
            // }

            gaiaCommon.customConfirm(`${type} {{message('item.dfccy.004')}}`, "{{message('msg.dfccy.017')}}", "{{message('msg.dfccy.044')}}", function(){
                $.ajax({
                    url: `/api/defecttracking/verification/createHistory-${urlType}`,
                    method: 'POST',
                    dataType: 'json',
                    contentType: 'application/json; charset-utf-8',
                    data: JSON.stringify(finishList),
                    success: function(result) {
                        gaiaCommon.customAlert("{{message('msg.034')}}", function(){
                            page.init(currentPage);
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error(status, error);
                        gaiaCommon.customAlert("{{ message('msg.060') }}");
                    }
                })
            });
        },
        validate(auth){
            if(isEnd) {
                gaiaCommon.customAlert("{{message('msg.dfccy.004')}}");
                return
            }

            if((auth === 'qa' && !isQa) || (auth === 'sv' && !isSpvs)) {
                gaiaCommon.customAlert("{{message('msg.dfccy.018')}}");
                return false;
            }

            return true;
        },
        delete(btn){
            $(btn).closest('tr').find('input:checkbox[name=select_check]').prop('checked', true);
            page.deleteAll();
        },
        convert(string){
            switch(string) {
                case 'ing': return "{{ message('item.com.041') }}";
                case 'end': return "{{ message('item.dfccy.004') }}";
                case 'ok': return "{{ message('item.app.042') }}";
            }
        },
        makeFileHtml(fileList){
            let html = `<ul class="file_list">
                            ${fileList.map(file => {
                                const fileUrl = `/api/defecttraking/tool/defectTracking/${file.fileNo}/${file.sno}/file-download`;
                                return `<li class="list_item">
                                            <a class="icon_btn" href='javascript:page.download("${fileUrl}");'>
                                                <i class="ic ic-folder-open"></i>
                                                <span class="blind">${file.fileNm}</span>
                                            </a>
                                            <a class="f_name" href='javascript:page.download("${fileUrl}");'>
                                                ${file.fileNm}
                                            </a>
                                        </li>`;
                            }).join('')}
                        </ul>`;
            return html;
        },
        activityOpen: function (dfccyNo) {
            const width = 1000;
            const height = 450;
            let left = Math.ceil((window.screen.width - width) / 2);
            left += window.screenLeft; // 듀얼 모니터일 때
            const top = Math.ceil((window.screen.height - height) / 2);
            let cntrctNo = $("#cntrctNo").val()

            window.open(
                `/defectTracking/activity?cntrctNo=${cntrctNo}&dfccyNo=${dfccyNo}`,
                "activityDetailPopup",
                `width=${width},height=${height},left=${left},top=${top}`
            );

            return false;
        },
        updatePagination(currentPage, totalPages) {
            // 페이지 번호 업데이트
            $('.slick_paging').empty();
            $(".slick_paging").append(`<b class="page">${currentPage}</b> / ${totalPages}`);

            // "이전" 버튼 비활성화 여부
            if (currentPage === 1) {
                $('.btn.prev').prop('disabled', true);
            } else {
                $('.btn.prev').prop('disabled', false);
            }

            // "다음" 버튼 비활성화 여부
            if (currentPage === totalPages || totalPages === 0) {
                $('.btn.next').prop('disabled', true);
            } else {
                $('.btn.next').prop('disabled', false);
            }
        },
        // 첨부파일 다운로드
        download(url){
            if(url) {
                gaiaCommon.download(url, function(error){
                    if (error.status === 404) {
                        gaiaCommon.customAlert("{{ message('msg.doc.128') }}");
                    } else if (error.status === 400) {
                        gaiaCommon.customAlert("{{ message('msg.059') }}");
                    } else {
                        gaiaCommon.customAlert("{{ message('msg.doc.129') }}");
                    }
                })
            }
        },
        // 컬럼 리사이징
        columnResizing() {
            let isResizing = false;
            let startX;
            let startWidth;
            let $th;
            let maxWidth;

            $(document).on("mousedown", ".resizer", function (e) {
                isResizing = true;
                $th = $(this).closest("th");
                startX = e.pageX;
                startWidth = $th.outerWidth();

                // 컨테이너 기준
                const container = document.querySelector(".gridContainer");
                $('.gridContainer').css("width", container.clientWidth + "px");
                if (document.querySelector(".gridContainer.active")) {
                    maxWidth = container.clientWidth * 0.55;
                } else {
                    maxWidth = container.clientWidth;
                }
                e.preventDefault();
            });

            $(document).on("mousemove", function (e) {
                if (!isResizing) return;
                let newWidth = startWidth + (e.pageX - startX) - 55;
                $("#grid").css("maxWidth", maxWidth + "px");
                // 최소 너비 제한
                if (newWidth < 50) newWidth = 50;

                const container = document.querySelector(".gridContainer");
                const table = document.querySelector(".table ");
                if(container.clientWidth < table.clientWidth) $("#grid table").css("width", "max-content");
                $th.css("width", newWidth + "px");
                e.preventDefault();
            });

            $(document).on("mouseup", function () {
                if (isResizing) isResizing = false;
            });

            $(window).off("resize.gridResize");
            let timer = null;
            // resize 이벤트 감지->gridResize(이벤트네임 등록)
            $(window).on("resize.gridResize", function () {
                clearTimeout(timer);
                timer = setTimeout(function(){
                    $('.gridContainer').removeAttr("style");
                    $('#grid').removeAttr("style");
                }, 300);
            });
        }
    }

    // 전체선택
    $('#checkAll').on("change", function () {
        const isChecked = $(this).prop("checked");
        $("input[name='select_check']").prop("checked", isChecked);
    });

    // "이전" 버튼 클릭 이벤트
    $('.btn.prev').on('click', function () {
        if (currentPage > 1) {
            currentPage--;
            page.read(currentPage);
        }
    });

    // "다음" 버튼 클릭 이벤트
    $('.btn.next').on('click', function () {
        currentPage++;
        page.read(currentPage);
    });

    // 상세정보 버튼 클릭 이벤트
    $(document).on('click', '.detail-btn', function () {
        $(this).closest('tr').next('.more_info').toggleClass('open');
        event.stopPropagation();
    });

    // 닫기 버튼 클릭 이벤트
    $(document).on('click', '.lay_pop_close', function () {
        $(this).closest('.more_info').removeClass('open');
    });

    // 입력창 생성 이벤트
    $(document).on("click", "[data-dfccy-no]", function () {
        var dfccyNo = $(this).data("dfccy-no");
        $(".more_info").removeClass("open");
        $(".dfccy-row").removeClass("selected-row");
        $(this).closest(".dfccy-row").addClass("selected-row");
        page.inputForm.toggle(dfccyNo);
    });

    $(document).on("mouseenter", ".dfccy-row", function () {
        $(this).find(".act-btn").show();
        $(this).find(".detail-btn").show();
    });
    $(document).on("mouseleave", ".dfccy-row", function () {
        $(this).find(".act-btn").hide();
        $(this).find(".detail-btn").hide();
    });

    $(function(){
        gaia.create({
            $init: function ($params) {
                gaiaPortal.navMenuInit("M090104", "{{ message('item.dfccy.057') }}");
                page.getDfccySelectbox();
                page.columnResizing();
                select.init();
            }
        });
    })

</script>
{% endblock footer_script %}
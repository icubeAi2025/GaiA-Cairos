{% extends 'layout/base_content' %} {% block head %}

{% endblock %} {% block content %}
<section class="contents_wrap g-col2 ty1">
    {% include "page/defecttracking/tool/common_tree" %}
    <article class="conts_area defect_conts">
        <div class="conts g-row">
            <div class="conts_grid">
                {% include "page/defecttracking/tool/common_select" %}
                <span class="tree_route" id="dfccy_phase_path">
                    결함단계
                </span>
                <div class="search_wrap">
                    <span class="selectbox">
                            <select name="dfccyType" id="selectbox_dfccy">
                                <option selected disabled value="">{{ message('item.dfccy.017') }}</option>
                            </select>
                        </span>
                    <span class="selectbox">
                        <select id="rplyStatus">
                            <option selected disabled value="">{{ message('item.dfccy.018') }}</option>
                            <option value="all">{{ message('item.dfccy.006') }}</option>
                            <option value="ing">{{ message('item.dfccy.003') }}</option>
                            <option value="ok">{{ message('item.com.042') }}</option>
                            <option value="end">{{ message('item.dfccy.004') }}</option>
                        </select>
                    </span>
                    <!-- searchbox -->
                    <div class="searchbox_wrap defect_search">
                        <!-- 검색어 입력창 -->
                        <input type="text" id="searchText"
                               placeholder="{{ message('item.dfccy.019') }},{{ message('item.com.060') }},{{ message('item.dfccy.020') }},{{ message('item.com.064') }}"
                               onkeypress="if(event.keyCode == 13){page.search();}">
                        <!-- 상세검색 아이콘 -->
                        <button type="button" class="btn icon_btn filter" onclick="page.detailSearchOpen()">
                            <i class="ic ic-setting-config"></i>
                            <span class="blind">{{ message('item.com.044') }}</span>
                        </button>
                        <!-- 일반검색 아이콘 -->
                        <button type="button" class="icon_btn search" onclick="page.search()">
                            <i class="ic ic-search"></i>
                            <span class="blind">{{ message('item.com.014') }}</span>
                        </button>
                        <!-- 상세검색 검색창 ("lay_pop on"일때 보여짐) -->
                        <div class="lay_pop" data-name="search_detail">
                            <button type="button" class="lay_pop_close icon_btn" onclick="page.detailSearchClose()">
                                <i class="ic ic-close"></i>
                                <span class="blind">{{ message('item.com.037') }}</span>
                            </button>

                            <div class="form_box ">
                                <div class="row">
                                    <div class="col">
                                        <div class="form_label">{{ message('item.dfccy.017') }}</div>
                                        <div class="form_data">
                                                <span class="selectbox width_css">
                                                    <select name="detail_dfccyCd" id="detail_dfccyCd">
                                                        <option selected disabled value="">{{ message('item.dfccy.017') }}</option>
                                                    </select>
                                                </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="form_label">{{ message('item.com.064') }}</div>
                                        <div class="form_data">
                                            <input type="text" name="rgstr" id="detailRgstr" class="">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col chkbox">
                                        <div class="form_label"></div>
                                        <div class="form_data detailSearch">
                                            <label class="form_check">
                                                <input class="check_mark" type="checkbox" name="checkbox"
                                                       id="detailMyRplyYn" value="Y">
                                                <span class="check_label">
                                                    {{ message('item.dfccy.021') }}
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col">
                                        <div class="form_label">{{ message('item.dfccy.022') }}</div>
                                        <div class="form_data">
                                            <div class="item_group">
                                                <!-- 숫자만 입력 -->
                                                <input type="text" name="startDfccyNo" id="startDfccyNo" class="number">
                                                ~
                                                <input type="text" name="endDfccyNo" id="endDfccyNo" class="number">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col">
                                        <div class="form_label">{{ message('item.construction.052') }}</div>
                                        <div class="form_data">
                                            <input type="text" name="activityNm" id="activityNm" class="">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col">
                                        <div class="form_label">{{ message('item.dfccy.023') }}</div>
                                        <div class="form_data">
                                            <div class="item_group selectbox">
                                                <span class="selectbox">
                                                    <select name="detail_rply_status" id="detailRplyStatus">
                                                        <option selected value="all">{{ message('item.dfccy.006') }}
                                                        </option>
                                                        <option value="ing">{{ message('item.dfccy.003') }}</option>
                                                        <option value="ok">{{ message('item.com.042') }}</option>
                                                        <option value="end">{{ message('item.dfccy.004') }}</option>
                                                    </select>
                                                </span>
                                                <span class="selectbox">
                                                    <select name="detail_rplyCd" id="detailRplyCd">
                                                        <option selected value="all">{{ message('item.dfccy.006') }}
                                                        </option>
                                                        <option value="0201">{{ message('item.dfccy.024') }}</option>
                                                        <option value="0202">{{ message('item.dfccy.010') }}</option>
                                                        <option value="0203">{{ message('item.dsgn.003') }}</option>
                                                    </select>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col">
                                        <div class="form_label">{{ message('item.dfccy.025') }}</div>
                                        <div class="form_data">
                                            <div class="item_group">
                                                <!-- 직접선택시 input type="date"를 "text"로 변경 -->
                                                <input type="date" name="startRplyRecentDt" id="startRplyRecentDt"
                                                       class="date" data-date-format="DD/MM/YYYY"
                                                       onchange="page.setMinDate('startRplyRecentDt', 'endRplyRecentDt')">
                                                ~
                                                <input type="date" name="endRplyRecentDt" id="endRplyRecentDt"
                                                       class="date" data-date-format="DD/MM/YYYY">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col chkbox">
                                        <div class="form_label"></div>
                                        <div class="form_data detailSearch">
                                            <label class="form_check">
                                                <input class="check_mark" type="checkbox" name="checkbox" id="priorityCheck" value="Y">
                                                <span class="check_label">
													{{ message('item.dfccy.083') }}
												</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col chkbox">
                                        <div class="form_label"></div>
                                        <div class="form_data detailSearch">
                                            <label class="form_check">
                                                <input class="check_mark" type="checkbox" name="checkbox"
                                                       id="crtcIsueYn" value="Y">
                                                <span class="check_label">
                                                    {{ message('item.dfccy.026') }}
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col chkbox">
                                        <div class="form_label"></div>
                                        <div class="form_data detailSearch">
                                            <label class="form_check">
                                                <input class="check_mark" type="checkbox" name="checkbox" id="atachYn"
                                                       value="Y">
                                                <span class="check_label">
                                                    {{ message('item.dfccy.027') }}
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <div class="btn_group _fill s_small jc_e">
                                <button type="button" class="btn" onclick="page.detailSearch()">
                                    {{message('btn.014') }}
                                </button>
                                <button type="button" class="btn" onclick="page.detailSearchReset()">
                                    {{message('btn.024')}}
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
                <p class="selected_list">

                </p>
                <!-- // E: search wrap ---------------------------------------------- -->
                <div class="toolbar dfccy_btn">
                    <div class="btn_area s_default _outline" style="height: 40px;">
                        {{ btnHtml | raw }}
                        <div class="slick_nav" style="top: unset;right: 28px;">
                            <span class="folder_doc">
                                <i class="ic ic-note"></i>
                                <span class="tooltip">파일개수</span>
                                <b class="num" id="list_cnt">0</b>
                            </span>
                            <div class="slick_paging">
                                <!-- <b class="page">1</b> / 2 -->
                            </div>
                            <div class="btn_area slick_indigator">
                                <div class="btn_group _outline">
                                    <button type="button" class="btn icon_btn prev">
                                        <span class="blind">{{ message('btn.016') }}</span>
                                    </button>
                                    <button type="button" class="btn icon_btn next">
                                        <span class="blind">{{ message('btn.017') }}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="gridContainer defect_grid">
                    <div id="grid">
                        <table class="table ta_c" style="table-layout: fixed;">
                            <colgroup>
                                <col width="100px">
                                <col width="130px">
                                <col width="7%">
                                <col width="10%">
                                <col>
                                <col width="6%">
                                <col width="10%">
                                <col width="10%">
                                <col width="10%">
                                <col width="6%">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th rowspan="2">
                                        <label class="form_check" style="display: block;">
                                            <input type="checkbox" id="selectAllCheckbox" class="check_mark">
                                            <span class="check_label blind">{{ message('item.com.005') }}</span>
                                        </label>
                                    </th>
                                    <th rowspan="2" style="width: 130px">{{ message('item.dfccy.019') }}</th>
                                    <th rowspan="2">{{ message('item.com.064') }}</th>
                                    <th rowspan="2">결함등록일</th>
                                    <th rowspan="2" class="resizable">{{ message('item.com.060') }} <div class="resizer"></div></th>
                                    <th rowspan="2">{{ message('item.dfccy.017') }}</th>
                                    <th rowspan="2">{{ message('item.construction.052') }}</th>
                                    <th colspan="2">{{ message('item.dfccy.008') }}</th>
                                    <th rowspan="2">{{ message('item.dfccy.072') }}</th>
                                </tr>
                                <tr>
                                    <th width="10%">{{ message('item.dfccy.030') }}</th>
                                    <th width="10%">{{ message('item.dfccy.031') }}</th>
                                </tr>
                            </thead>
                            <tbody class="ty_list" id="dfccyList">
                            </tbody>
                        </table>
                    </div>

                    <div id="popup">
                    </div>
                </div>
            </div>
        </div>
    </article>
</section>
{% endblock content %} {% block footer_script %}
<script>
    const dfccyPhaseCd = "0102";    // 구분: 결함사항
    const params = new URLSearchParams(window.location.search);
    let dfccyPhaseNo = params.get("dfccyPhaseNo");
    let isDelAuth = "{{ isDelAuth }}" === "true" ? true : false;

    // 일반 검색용
    let dfccyCd = params.get("dfccyCd");;
    let searchText;
    let rplyStatus = params.get("rplyStatus");

    // 상세검색용
    let rgstr = params.get("rgstrNm") || params.get("rgstr")
    let myRplyYn;
    let startDfccyNo;
    let endDfccyNo;
    let activityNm;
    let rplyCd = params.get("rplyCd");
    let startRplyRecentDt;
    let endRplyRecentDt;
    let priorityCheck;
    let crtcIsueYn;
    let atachYn;


    //페이징
    var currentPage = 1;
    var itemsPerPage = 10;

    var page = {
        data: {},
        currentDfccyNo: null,
        currentReplySeq: null,
        init: function (curPage) {
            $(".search_wrap").show();
            $(".dfccy_btn").show();
            $(".gridContainer").show();

            if(isEnd) {
                $("#deleteBtn").hide();
                $("#confirmBtn").hide();
            } else {
                $("#deleteBtn").show();
                $("#confirmBtn").show();
            }

            this.inputPopupClose();
            $(".check_mark").prop("checked", false);

            if(!curPage) currentPage = 1;

            page.table(currentPage);

            const searchParams = [
                { param: rplyCd, selector: "#detailRplyCd" },
                { param: rplyStatus, selector: "#detailRplyStatus" },
                { param: dfccyCd, selector: "#detailDfccyCd" },
                { param: rgstr, selector: "#detailRgstr" }
            ];

            let hasDetailSearch = searchParams.some(({ param }) => param);

            searchParams.forEach(({ param, selector }) => {
                if (param) {
                    $(selector).val(param);
                }
            });
            if (hasDetailSearch) {
                history.replaceState(null, null, window.location.pathname+`?pjtNo=${pjtNo}&cntrctNo=${cntrctNo}`);
                this.detailSearch();
            }
        },

        delete: function (replySeq, dfccyNo) {
            let data = {
                ["responsesList"]: [{ replySeq, dfccyNo }]
            };

            $.ajax({
                url: `/api/defecttracking/responses/delete`,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (data) {
                    if (data.details.rplyY) {
                        gaiaCommon.customAlert("{{ message('msg.dfccy.001') }}");
                    } else {
                        gaiaCommon.customAlert("{{ message('msg.006') }}");
                        page.init(currentPage);
                    }
                },
                error: function (xhr, status, error) {
                    console.error(status, error);
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                },
            })
        },

        // 체크된 항목 삭제
        deleteList: function () {
            let selectedRows = [];

            $(".check_mark[name='checkboxList']:checked").each(function () {
                let $row = $(this).closest("tr.dfccy-row");
                let replySeq = $row.find("[data-reply-seq]").data("reply-seq");
                let dfccyNo = $row.find("[data-dfccy-no]").data("dfccy-no");

                if (replySeq) {
                    selectedRows.push({ replySeq, dfccyNo });
                }
            });

            if (selectedRows.length == 0) {
                gaiaCommon.customAlert("{{ message('msg.035') }}".replace('{0}', "{{ message('btn.002') }}"));
                return false;
            }

            let data = { ["responsesList"]: selectedRows };

            $.ajax({
                url: `/api/defecttracking/responses/delete`,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (data) {
                    // if (data.details.rplyY) {
                    //     gaiaCommon.customAlert("{{ message('msg.dfccy.001') }}");
                    //     page.init(currentPage);
                    // } else {
                        gaiaCommon.customAlert("{{ message('msg.006') }}");
                        page.init(currentPage);
                    // }
                },
                error: function (xhr, status, error) {
                    console.error(status, error);
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                },
            })
        },

        // 체크된 항목 확인처리
        confirmList: function () {
            let selectedRows = [];

            $(".check_mark[name='checkboxList']:checked").each(function () {
                let $row = $(this).closest("tr.dfccy-row");
                let replySeq = $row.find("[data-reply-seq]").data("reply-seq");
                let dfccyNo = $row.find("[data-dfccy-no]").data("dfccy-no");

                if (replySeq) {
                    selectedRows.push({ replySeq, dfccyNo });
                }
            });

            if (selectedRows.length == 0) {
                gaiaCommon.customAlert("{{ message('msg.dfccy.002') }}");
                return false;
            }

            let data = { ["responsesList"]: selectedRows };

            $.ajax({
                url: `/api/defecttracking/responses/confirm`,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (data) {
                    gaiaCommon.customAlert("{{ message('msg.dfccy.003') }}");
                    page.init(currentPage);
                },
                error: function (xhr, status, error) {
                    console.error(status, error);
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                },
            })
        },


        inputPopupToggle: function (replySeq, dfccyNo) {
            if (this.currentDfccyNo === dfccyNo) {
                this.inputPopupClose(replySeq, dfccyNo);
            } else {
                this.inputPopupOpen(replySeq, dfccyNo)
            }
            $('.d_list').slick('setPosition');
        },

        inputPopupOpen: function (replySeq, dfccyNo) {
            // 권한 검증 후 팝업 열기
            gaiaCommon.checkAuth("DT_RESPONSE_CU_01", () => {
                // 권한 있을 때 실행할 콜백
                $('.gridContainer').addClass('active');
                $(`#tr_${dfccyNo}`).next('.more_info').addClass('open');
                $("#popup").load(`/defectTracking/responsesForm?pjtNo=${pjtNo}&cntrctNo=${$("#cntrctNo").val()}&popup=true`);
                this.currentDfccyNo = dfccyNo;
                this.currentReplySeq = replySeq;
            });
        },

        inputPopupClose: function (replySeq, dfccyNo) {
            $('.gridContainer').removeClass('active');
            $("#popup").empty();
            this.currentDfccyNo = null;
            this.currentReplySeq = null;
            $(`#tr_${dfccyNo}`).removeClass("selected-row");
            $(`#tr_${dfccyNo}`).next(".more_info").removeClass("open");
        },

        activityOpen: function (dfccyNo) {
            const width = 1000;
            const height = 450;
            let left = Math.ceil((window.screen.width - width) / 2);
            left += window.screenLeft; // 듀얼 모니터일 때
            const top = Math.ceil((window.screen.height - height) / 2);
            let cntrctNo = $("#cntrctNo").val()

            window.open(
                `/defectTracking/activity?cntrctNo=${cntrctNo}&dfccyNo=${dfccyNo}`,
                "activityDetailPopup",
                `width=${width},height=${height},left=${left},top=${top}`
            );

            return false;
        },

        table: function (curPage, curDfccyNo) {
            $.ajax({
                url: `/api/defecttracking/responses/dfccyList`,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    page: curPage,
                    size: itemsPerPage,

                    pjtNo: pjtNo,
                    dfccyPhaseNo: dfccyPhaseNo,
                    cntrctNo: $("#cntrctNo").val(),
                    dfccyCd: dfccyCd,
                    keyword: searchText,
                    rplyStatus: rplyStatus,

                    rgstrNm: rgstr,
                    myRplyYn: myRplyYn,
                    startDfccyNo: startDfccyNo,
                    endDfccyNo: endDfccyNo,
                    activityNm: activityNm,
                    rplyStatus: rplyStatus,
                    rplyCd: rplyCd,
                    startRplyRecentDt: startRplyRecentDt,
                    endRplyRecentDt: endRplyRecentDt,
                    priorityCheck: priorityCheck,
                    crtcIsueYn: crtcIsueYn,
                    atachYn: atachYn,
                }),
                success: function (data) {
                    $('#dfccyList').empty();

                    let list = data.details.dfccyList;
                    let totalCount = data.details.totalCount;
                    let totalPages = Math.ceil(totalCount / itemsPerPage);

                    // 페이지네이션 업데이트
                    page.updatePagination(curPage, totalPages);

                    $('#list_cnt').text(totalCount);

                    if(list.length < 1) {
                        $("#dfccyList").children().empty();
                        $("#dfccyList").append(`<tr>
                                                    <td colspan="10">
                                                        <div style="display: inline-block;">
                                                            <p class="data_info">
                                                                {{message('msg.091')}}
                                                            </p>
                                                        </div>
                                                    </td>
                                                </tr>`);
                        return
                    }

                    list.forEach((dfccyList, index) => {
                        // null이면 빈 문자열로 대체
                        var replySeq = dfccyList.replySeq;
                        var dfccyNo = dfccyList.dfccyNo;
                        var rgstrNm = dfccyList.rgstrNm ?? "";
                        var title = dfccyList.title ?? "";
                        var dfccyCdNm = dfccyList.dfccyCdNm ?? "";
                        var activityIds = dfccyList.activityIds ?? "";
                        var rplyStatus = dfccyList.rplyStatus ?? "";
                        var rplyCdNm = dfccyList.rplyCdNm ?? "";
                        var dfccyLct = dfccyList.dfccyLct ?? "";
                        var dfccyCntnts = dfccyList.dfccyCntnts ?? "";
                        var rgstDt = dfccyList.rgstDt ?? "";
                        var crtcIsueYn = dfccyList.crtcIsueYn ?? "";
                        var priorityCheck = dfccyList.priorityCheck ?? "";
                        var edCdNm = dfccyList.edCdNm ?? "";
                        // 첨부파일 리스트
                        var fileList = dfccyList.files;

                        // 첨부파일 리스트 HTML 생성
                        let fileListHtml = "";
                        if (fileList && fileList.length > 0) {
                            fileListHtml = `<ul class="file_list">
                                                ${fileList.map(file => {
                                                    const fileUrl = `/api/defecttraking/tool/defectTracking/${file.fileNo}/${file.sno}/file-download`;
                                                    return `<li class="list_item">
                                                                <a class="icon_btn" href='javascript:page.download("${fileUrl}");'>
                                                                    <i class="ic ic-folder-open"></i>
                                                                    <span class="blind">${file.fileNm}</span>
                                                                </a>
                                                                <a class="f_name" href='javascript:page.download("${fileUrl}");'>
                                                                    ${file.fileNm}
                                                                </a>
                                                            </li>`;
                                                }).join('')}
                                            </ul>`;
                        }

                        var dfccyList = `
                                        <tr class="dfccy-row" id="tr_${dfccyNo}">
                                            <td>
                                                <div class="item_group">
                                                    <label class="form_check">
                                                        <input class="check_mark" type="checkbox" name="checkboxList">
                                                        <span class="check_label blind">{{ message('item.com.005') }}</span>
                                                    </label>
                                                    ${isDelAuth && !isEnd ? `<button type="button" class="icon_btn" onclick="page.delete('${replySeq}','${dfccyNo}')">
                                                                                <i class="ic ic-delete"></i>
                                                                                <span class="blind">{{ message('item.dfccy.032') }}</span>
                                                                            </button>` : ""}
                                                </div>
                                            </td>
                                            <td>
                                                <a><span>${dfccyNo}</span></a>
                                                <button type="button" class="icon_btn detail-btn" style="display:none;">
                                                    <i class="ic ic-sent-to-back"></i>
                                                    <span class="blind">{{ message('item.com.080') }}</span>
                                                </button>
                                            </td>
                                            <td data-dfccy-no="${dfccyNo}" data-reply-seq="${replySeq}">${rgstrNm}</td>
                                            <td data-dfccy-no="${dfccyNo}" data-reply-seq="${replySeq}">${rgstDt}</td>
                                            <td data-dfccy-no="${dfccyNo}" data-reply-seq="${replySeq}" style="text-align: left;" ${priorityCheck === 'Y' ? 'class="dfccy_priority"' : ''}>${title}</td>
                                            <td data-dfccy-no="${dfccyNo}" data-reply-seq="${replySeq}">${dfccyCdNm}</td>
                                            <td style="text-align: left; padding-right: 20px;">
                                                <a><span>${activityIds}</span></a>
                                                <button type="button" class="icon_btn act-btn" onclick="page.activityOpen(${dfccyNo})" style="display:none;">
                                                    <i class="ic ic-sent-to-back"></i>
                                                    <span class="blind">{{ message('item.dfccy.033') }}</span>
                                                </button>
                                            </td>
                                            <td data-dfccy-no="${dfccyNo}" data-reply-seq="${replySeq}">${rplyStatus}</td>
                                            <td data-dfccy-no="${dfccyNo}" data-reply-seq="${replySeq}">${rplyCdNm}</td>
                                            <td data-dfccy-no="${dfccyNo}" data-reply-seq="${replySeq}">${edCdNm}</td>
                                        </tr>
                                        <tr class="more_info">
                                            <td colspan="10" class="ta_l" style="position: relative;">
                                                <dl class="more_data">
                                                    <button type="button" class="lay_pop_close icon_btn" style="position: absolute;">
                                                        <i class="ic ic-close"></i>
                                                        <span class="blind">{{ message('item.com.037') }}</span>
                                                    </button>
                                                    <dt>{{ message('item.dfccy.083') }}</dt>
                                                    <dd> <input class="check_mark" type="checkbox" name="" id="" ${priorityCheck === 'Y' ? 'checked' : ''} disabled>
                                                    </dd>
                                                    <dt>{{ message('item.dfccy.026') }}</dt>
                                                    <dd> <input class="check_mark" type="checkbox" name="checkboxgroup" ${crtcIsueYn === 'Y' ? 'checked' : ''} disabled>
                                                    </dd>
                                                    <dt>{{ message('item.dfccy.034') }}</dt>
                                                    <dd>${dfccyLct}</dd>
                                                    <dt>{{ message('item.dfccy.035') }}</dt>
                                                    <dd><pre>${gaiaCommon.safeText(gaiaCommon.decodeSafeText(dfccyCntnts))}</pre></dd>
                                                    <dt>{{ message('item.com.063') }}</dt>
                                                    <dd>${rgstDt}</dd>
                                                    <dt>{{ message('item.com.062') }}</dt>
                                                    <dd>
                                                        <div class="attach_area">
                                                            <p class="data_info ${fileList && fileList.length > 0 ? 'hide' : ''}">
                                                                {{ message('msg.029') }} </p>
                                                            <div class="attach_list ${fileList && fileList.length > 0 ? '' : 'hide'}" style="width: 100%;">
                                                                <ul class="file_header">
                                                                    <li class="header_item">
                                                                        <div class="icon_btn">
                                                                            <i class="ic ic-folder-open" id="fileIcon"></i>
                                                                            <span class="blind">{{ message('item.com.020') }}</span>
                                                                        </div>
                                                                        <span class="f_name">{{ message('item.com.020') }}</span>
                                                                    </li>
                                                                </ul>
                                                                 ${fileListHtml}
                                                            </div>
                                                        </div>
                                                    </dd>
                                                </dl>
                                            </td>
                                        </tr>`;
                        $("#dfccyList").append(dfccyList);
                    });
                    if(curDfccyNo) {
                        page.currentDfccyNo = curDfccyNo;
                        page.currentReplySeq = $(`#tr_${curDfccyNo} td[data-reply-seq]`).attr('data-reply-seq');
                        $(`#tr_${curDfccyNo}`).addClass('selected-row');
                        $(`#tr_${curDfccyNo}`).next('.more_info').addClass('open');
                        gaiaCommon.checkAuth("DT_RESPONSE_CU_01", () => {
                            $("#popup").load(`/defectTracking/responsesForm?pjtNo=${pjtNo}&cntrctNo=${$("#cntrctNo").val()}`);
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error(status, error);
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                },
            })
        },

        updatePagination: function (currentPage, totalPages) {
            // 페이지 번호 업데이트
            $('.slick_paging').empty();
            $(".slick_paging").append(`<b class="page">${currentPage}</b> / ${totalPages}`);

            // "이전" 버튼 비활성화 여부
            if (currentPage === 1) {
                $('.btn.prev').prop('disabled', true);
            } else {
                $('.btn.prev').prop('disabled', false);
            }

            // "다음" 버튼 비활성화 여부
            if (currentPage === totalPages || totalPages === 0) {
                $('.btn.next').prop('disabled', true);
            } else {
                $('.btn.next').prop('disabled', false);
            }
        },

        // 셀렉트박스 호출
        makeSelectBox: function (comCodeSelectBoxGets) {
            $.ajax({
                url: "/api/util/make-selectBox",
                method: "POST",
                dataType: "json",
                xhrFields: { withCredentials: true },
                contentType: "application/json; charset=UTF-8",
                traditional: true,
                data: JSON.stringify(comCodeSelectBoxGets), // 요청 데이터로 comCodeSelectBoxGets 배열을 전송
                success: function (data) {
                    let returnMap = data.details.returnMap;
                    comCodeSelectBoxGets.forEach(function (item, index) {
                        let addAppLineContent = document.getElementById(
                            item.selectBoxId
                        );
                        let categorySelect = `${returnMap[item.selectBoxId]}`;
                        if (addAppLineContent) {
                            addAppLineContent.innerHTML =
                                returnMap[item.selectBoxId];
                        }
                        $(`#selectBox${index + 1}`).append(categorySelect);
                    });
                },
                error: function (xhr, status, error) {
                    console.error(status, error);
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                },
            });
        },

        initializeSelectBoxes() {
            let selectBoxRequests = [
                {
                    cmnGrpCd: "19a8bb53-74b4-405a-8d91-2b38555fc7d9",
                    selectBoxId: "dfccyCd",
                    selectBoxNmType: "KOR",
                    ckeckedValue: "",
                    orderByCol: "",
                    orderByType: "",
                    initText: "{{ message('item.dfccy.017') }}",
                    paramNm: "dfccyCd",
                    funName: "",
                    funParam: "this.value",
                    funtype: "onchange",
                },
                {
                    cmnGrpCd: "19a8bb53-74b4-405a-8d91-2b38555fc7d9",
                    selectBoxId: "detailDfccyCd",
                    selectBoxNmType: "KOR",
                    ckeckedValue: "",
                    orderByCol: "",
                    orderByType: "",
                    initText: "{{ message('item.dfccy.017') }}",
                    paramNm: "detailDfccyCd",
                    funName: "",
                    funParam: "this.value",
                    funtype: "onchange",
                },
            ];

            page.makeSelectBox(selectBoxRequests);
        },

        detailSearchOpen() {
            $("[data-name='search_detail']").addClass("on");
        },

        detailSearchClose() {
            $("[data-name='search_detail']").removeClass("on");
        },

        // 일반검색
        search() {
            dfccyCd = $('#selectbox_dfccy').val();
            rplyStatus = $('#rplyStatus').val();
            searchText = $('#searchText').val();
            currentPage = 1
            page.table(currentPage)
            page.inputPopupClose()
        },

        //상세검색
        detailSearch() {
            $('#selectbox_dfccy').val('');
            $('#rplyStatus').val('');
            $('#searchText').val('');

            // 상세 검색 조건 표시 on
            $('.selected_list').addClass('on');
            $('.selected_list').children().remove();

            dfccyCd = $("#detail_dfccyCd").val();
            rgstr = $("#detailRgstr").val();
            myRplyYn = $("input[id='detailMyRplyYn']:checked").val();
            startDfccyNo = $('#startDfccyNo').val();
            endDfccyNo = $('#endDfccyNo').val();
            activityNm = $('#activityNm').val();
            rplyStatus = $("#detailRplyStatus").val();
            rplyCd = $("#detailRplyCd").val();
            startRplyRecentDt = $('#startRplyRecentDt').val();
            endRplyRecentDt = $('#endRplyRecentDt').val();
            priorityCheck = $("input[id='priorityCheck']:checked").val();
            crtcIsueYn = $("input[id='crtcIsueYn']:checked").val();
            atachYn = $("input[id='atachYn']:checked").val();

            // 결함 분류
            if (dfccyCd && dfccyCd !== "all") {

                let dfccyCdText = $("#detail_dfccyCd option:selected").text();

                let keywordHtml = `
					<span class="selected_item detailDfccyCd">
						<span class="item dfCd">${dfccyCdText}</span>
						<input type="hidden" name="detailDfccyCd" data-name="dfccyCd" value="${dfccyCd}">
						<button type="button" class="icon_btn" onclick="page.detailSearchListClose('detailDfccyCd')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                $('.selected_list').append(keywordHtml);
            }

            // 작성자
            if (rgstr) {
                $('select[name="rgstr_search_select"]').val(rgstr); // 그리드 작성자 값 설정.

                let keywordHtml = `
					<span class="selected_item detailRgstr">
						<span class="item rgstr">${rgstr}</span>
						<input type="hidden" name="detailRgstr" data-name="rgstr" value="${rgstr}">
						<button type="button" class="icon_btn" onclick="page.detailSearchListClose('detailRgstr')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                $('.selected_list').append(keywordHtml);
            }

            // 결함번호 범위
            if (startDfccyNo && endDfccyNo) {
                let combinedValue = `${startDfccyNo} ~ ${endDfccyNo}`;
                let keywordHtml = `
					<span class="selected_item detailDfId">
						<span class="item dfId">${combinedValue}</span>
						<input type="hidden" name="startDfccyNo" data-name="startDfccyNo" value="${startDfccyNo}">
						<input type="hidden" name="endDfccyNo" data-name="endDfccyNo" value="${endDfccyNo}">
						<button type="button" class="icon_btn" onclick="page.detailSearchListClose('detailDfId')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                $('.selected_list').append(keywordHtml);
            }

            // Activity 이름
            if (activityNm) {
                let keywordHtml = `
					<span class="selected_item activityNm">
						<span class="item acNm">${activityNm}</span>
						<input type="hidden" name="activityNm" data-name="activityNm" value="${activityNm}">
						<button type="button" class="icon_btn" onclick="page.detailSearchListClose('activityNm')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                $('.selected_list').append(keywordHtml);
            }

            // 답변 상태
            if (rplyStatus && rplyCd) {
                if (rplyStatus !== "all" || rplyCd !== "all") {
                    let rplyStatusText = $("#detailRplyStatus option:selected").text();
                    let rplyCdText = $("#detailRplyCd option:selected").text();
                    let combinedValue = `${rplyStatusText} | ${rplyCdText}`;
                    let keywordHtml = `
						<span class="selected_item detailRplyStatus detailRplyCd">
							<span class="item rply">${combinedValue}</span>
							<input type="hidden" name="detailRplyStatus" data-name="rplyStatus" value="${rplyStatus}">
							<input type="hidden" name="detailRplyCd" data-name="rplyCd" value="${rplyCd}">
							<button type="button" class="icon_btn" onclick="page.detailSearchListClose('detailRplyStatus,detailRplyCd')">
								<i class="ic ic-close"></i>
								<span class="blind">{{ message('btn.002') }}</span>
							</button>
						</span>
					`;
                    $('.selected_list').append(keywordHtml);
                }
            }

            // 날짜 범위
            if (startRplyRecentDt || endRplyRecentDt) {
                let combinedValue = `${startRplyRecentDt} ~ ${endRplyRecentDt}`;
                let keywordHtml = `
					<span class="selected_item detailRecentDt">
						<span class="item rgstDt">${combinedValue}</span>
						<input type="hidden" name="startRplyRecentDt" data-name="startRplyRecentDt" value="${startRplyRecentDt}">
						<input type="hidden" name="endRplyRecentDt" data-name="endRplyRecentDt" value="${endRplyRecentDt}">
						<button type="button" class="icon_btn" onclick="page.detailSearchListClose('detailRecentDt')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                $('.selected_list').append(keywordHtml);
            }

            // 첨부 파일
            if (atachYn) {
                let keywordHtml = `
					<span class="selected_item detailAtachYn">
						<span class="item ">{{ message('item.com.062') }} O</span>
						<input type="hidden" name="atachYn" data-name="atachYn" value="${atachYn}">
						<button type="button" class="icon_btn" onclick="page.detailSearchListClose('detailAtachYn')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                $('.selected_list').append(keywordHtml);
            }

            // 중요
            if (priorityCheck) {
                let keywordHtml = `
					<span class="selected_item detailPriorityCheck">
						<span class="item ">{{ message('item.dfccy.083') }} O</span>
						<input type="hidden" name="priorityCheck" data-name="priorityCheck" value="${priorityCheck}">
						<button type="button" class="icon_btn" onclick="page.detailSearchListClose('detailPriorityCheck')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                $('.selected_list').append(keywordHtml);
            }

            // 생명/보건/안전
            if (crtcIsueYn) {
                let keywordHtml = `
					<span class="selected_item detailCrtcIsueYn">
						<span class="item ">{{ message('item.dfccy.037') }} O</span>
						<input type="hidden" name="crtcIsueYn" data-name="crtcIsueYn" value="${crtcIsueYn}">
						<button type="button" class="icon_btn" onclick="page.detailSearchListClose('detailCrtcIsueYn')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                $('.selected_list').append(keywordHtml);
            }

            // 내 의견
            if (myRplyYn) {
                let keywordHtml = `
					<span class="selected_item detailMyRplyYn">
						<span class="item ">{{ message('item.dfccy.007') }} O</span>
						<input type="hidden" name="detailMyRplyYn" data-name="myRplyYn" value="${myRplyYn}">
						<button type="button" class="icon_btn" onclick="page.detailSearchListClose('detailMyRplyYn')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
                $('.selected_list').append(keywordHtml);
            }

            if ($('.selected_list').children().length === 0) {
                $('.selected_list').removeClass('on');
            }

            currentPage = 1
            page.table(currentPage)
            page.detailSearchClose()
            page.inputPopupClose()
        },

        // 선택된 모든 검색 조건 삭제
        detailSearchListAllClose() {
            $('.selected_list').children().each(function () {
                let keyword = $(this).attr('class').split(' ')[1];

                let hiddenInputs = $(this).find('input[type="hidden"]');
                hiddenInputs.each(function () {
                    let key = $(this).attr('name');
                    let inputField = $(`[name="${key}"], #${key}`);

                    if (inputField.is(':checkbox') || inputField.is(':radio')) {
                        inputField.prop('checked', false);
                    }
                    else if (inputField.is('select')) {
                        inputField.prop('selectedIndex', 0);
                    }
                    else {
                        inputField.val('');
                    }
                });
                $(this).remove();
            });

            if ($('.selected_list').children().length === 0) {
                $('.selected_list').removeClass('on');
            }

            // 검색 테이블 갱신
            dfccyCd = $("#detailDfccyCd").val();
            rgstr = $("#detailRgstr").val();
            myRplyYn = $("input[id='detailMyRplyYn']:checked").val();
            startDfccyNo = $('#startDfccyNo').val();
            endDfccyNo = $('#endDfccyNo').val();
            activityNm = $('#activityNm').val();
            rplyStatus = $("#detailRplyStatus").val();
            rplyCd = $("#detailRplyCd").val();
            startRplyRecentDt = $('#startRplyRecentDt').val();
            endRplyRecentDt = $('#endRplyRecentDt').val();
            priorityCheck = $("input[id='priorityCheck']:checked").val();
            crtcIsueYn = $("input[id='crtcIsueYn']:checked").val();
            atachYn = $("input[id='atachYn']:checked").val();

            currentPage = 1;
            page.table(currentPage);
            page.inputPopupClose();
        },

        detailSearchReset() {
            $("#detailDfccyCd").val('')
            $("#detailRgstr").val('');
            $("#startDfccyNo").val('');
            $("#endDfccyNo").val('');
            $("#activityNm").val('');
            $("#detailRplyStatus").val('all')
            $("#detailRplyCd").val('all')
            $("#startRplyRecentDt").val('');
            $("#endRplyRecentDt").val('')

            $("input[name='checkbox']").prop('checked', false);
        },

        detailSearchListClose(keywords) {
            let keywordList = keywords.split(','); // 쉼표로 분리하여 배열로 저장

            keywordList.forEach(keyword => {
                let selectedItem = $(`.${keyword.trim()}`); // 개별 클래스 선택

                if (selectedItem.length) {
                    let hiddenInputs = selectedItem.find('input[type="hidden"]');

                    hiddenInputs.each(function () {
                        let key = $(this).attr('name');
                        let inputField = $(`[name="${key}"], #${key}`);

                        if (inputField.is(':checkbox') || inputField.is(':radio')) {
                            inputField.prop('checked', false);
                        } else if (inputField.is('select')) {
                            inputField.prop('selectedIndex', 0);
                        } else {
                            inputField.val('');
                        }
                    });

                    selectedItem.remove();
                }
            });

            if ($('.selected_list').children().length === 0) {
                $('.selected_list').removeClass('on');
            }

            // 검색 테이블 갱신
            dfccyCd = $("#detailDfccyCd").val();
            rgstr = $("#detailRgstr").val();
            myRplyYn = $("input[id='detailMyRplyYn']:checked").val();
            startDfccyNo = $('#startDfccyNo').val();
            endDfccyNo = $('#endDfccyNo').val();
            activityNm = $('#activityNm').val();
            rplyStatus = $("#detailRplyStatus").val();
            rplyCd = $("#detailRplyCd").val();
            startRplyRecentDt = $('#startRplyRecentDt').val();
            endRplyRecentDt = $('#endRplyRecentDt').val();
            priorityCheck = $("input[id='priorityCheck']:checked").val();
            crtcIsueYn = $("input[id='crtcIsueYn']:checked").val();
            atachYn = $("input[id='atachYn']:checked").val();
            currentPage = 1
            page.table(currentPage)
            page.inputPopupClose()
        },
        getDfccySelectbox(){
            $.ajax({
                url: "/api/defecttracking/verification/dfccy-selectbox",
                method: "GET",
                success: function (data) {
                    let dfccyCdList = data.details.dfccySelectbox;
                    $.each(dfccyCdList, function (index, obj) {
                        $('#selectbox_dfccy').append(`<option value="${obj.cmn_cd}">${obj.cmn_cd_nm_krn}</option>`);
                        $('#detail_dfccyCd').append(`<option value="${obj.cmn_cd}">${obj.cmn_cd_nm_krn}</option>`);
                    })
                },
                error: function (xhr, status, error) {
                    console.error(status, error);
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                }
            });
        },
        // 첨부파일 다운로드
        download(url){
            if(url) {
                gaiaCommon.download(url, function(error){
                    if (error.status === 404) {
                        gaiaCommon.customAlert("{{ message('msg.doc.128') }}");
                    } else if (error.status === 400) {
                        gaiaCommon.customAlert("{{ message('msg.059') }}");
                    } else {
                        gaiaCommon.customAlert("{{ message('msg.doc.129') }}");
                    }
                })
            }
        },
        // 컬럼 리사이징
        columnResizing() {
            let isResizing = false;
            let startX;
            let startWidth;
            let $th;
            let maxWidth;

            $(document).on("mousedown", ".resizer", function (e) {
                isResizing = true;
                $th = $(this).closest("th");
                startX = e.pageX;
                startWidth = $th.outerWidth();

                // 컨테이너 기준
                const container = document.querySelector(".gridContainer");
                $('.gridContainer').css("width", container.clientWidth + "px");
                if (document.querySelector(".gridContainer.active")) {
                    maxWidth = container.clientWidth * 0.55;
                } else {
                    maxWidth = container.clientWidth;
                }
                e.preventDefault();
            });

            $(document).on("mousemove", function (e) {
                if (!isResizing) return;
                let newWidth = startWidth + (e.pageX - startX) - 55;
                $("#grid").css("maxWidth", maxWidth + "px");
                // 최소 너비 제한
                if (newWidth < 50) newWidth = 50;

                const container = document.querySelector(".gridContainer");
                const table = document.querySelector(".table ");
                if(container.clientWidth < table.clientWidth) $("#grid table").css("width", "max-content");
                $th.css("width", newWidth + "px");
                e.preventDefault();
            });

            $(document).on("mouseup", function () {
                if (isResizing) isResizing = false;
            });

            $(window).off("resize.gridResize");
            let timer = null;
            // resize 이벤트 감지->gridResize(이벤트네임 등록)
            $(window).on("resize.gridResize", function () {
                clearTimeout(timer);
                timer = setTimeout(function(){
                    $('.gridContainer').removeAttr("style");
                    $('#grid').removeAttr("style");
                }, 300);
            });
        }
    }


    // "이전" 버튼 클릭 이벤트
    $('.btn.prev').on('click', function () {
        if (currentPage > 1) {
            currentPage--;
            page.table(currentPage);
        }
    });

    // "다음" 버튼 클릭 이벤트
    $('.btn.next').on('click', function () {
        currentPage++;
        page.table(currentPage);
    });

    // 상세정보 버튼 클릭 이벤트
    $(document).on('click', '.detail-btn', function () {
        $(this).closest('tr').next('.more_info').toggleClass('open');
        // event.stopPropagation();
    });

    // 닫기 버튼 클릭 이벤트
    $(document).on('click', '.lay_pop_close', function () {
        $(this).closest('.more_info').removeClass('open');
    });

    // 입력창 생성 이벤트
    $(document).on("click", "[data-dfccy-no]", function () {
        var dfccyNo = $(this).data("dfccy-no");
        var replySeq = $(this).data("reply-seq");
        $(".more_info").removeClass("open");
        $(".dfccy-row").removeClass("selected-row");
        $(this).closest(".dfccy-row").addClass("selected-row");
        page.inputPopupToggle(replySeq, dfccyNo);
    });


    // 그리드 마우스 호버 이벤트
    $(document).on("mouseenter", ".dfccy-row", function () {
        $(this).find(".act-btn").show();
        $(this).find(".detail-btn").show();
    });
    $(document).on("mouseleave", ".dfccy-row", function () {
        $(this).find(".act-btn").hide();
        $(this).find(".detail-btn").hide();
    });

    // 일괄선택 체크박스 클릭 이벤트
    $("#selectAllCheckbox").on('change', function () {
        const isChecked = $(this).is(':checked');
        $(".check_mark[name='checkboxList']").prop('checked', isChecked);
    });

    $('.lay_pop').mousedown(function (e) {
        e.stopPropagation();
    });

    $(document).mousedown(function (e) {
        page.detailSearchClose()
    });

    $(function () {
        gaia.create({
            $init: function ($params) {
                gaiaPortal.navMenuInit("M090103", "{{ message('item.dfccy.036') }}");
                page.getDfccySelectbox();
                page.columnResizing();
                select.init();
                gaia.loaded = true
            }
        });
    })

</script>
{% endblock footer_script %}
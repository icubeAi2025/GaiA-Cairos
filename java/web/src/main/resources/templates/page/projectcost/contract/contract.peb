{% extends header ? 'layout/base_content' : 'layout/base_popup' %}
{% block content %}

<section class="contents_wrap">
    <article class="conts_area">
        <article class="conts" id="contract_container">                     <!-- 계약코드 -->
            <div class="group">
                <h3 class='conts_tit' >{{ message('item.sub.040') }}</h3>   <!-- 변경차수 -->
                <div class="search_wrap" >
                    <span class='selectbox' style="width:100%" >
                        <select name='cntrctChgId' id='cntrctChgId'></select>
                    </span>
                </div>

                 <div class="btn_area s_default _outline" style="margin-top: 10px;">
					<button type="button" class="btn" id="close">{{ message('btn.007') }}</button>
				</div>

                <div class="s_conts g-group">
                    <iframe id="ifrEureca" src="" style="display:none;height: 95vh;" frameborder="0"></iframe>
                </div>
            </div>
        </article>
    </article>
</section>
{% include "page/projectcost/contract/contract_detail" %}
<input type="text" id="cntrct_chg_no_first" hidden/>
<input type="text" id="chg_no" hidden/>
<input type="text" id="cnsttySn_arr" hidden/>
{% endblock content %}
{% block footer_script %}
<style>
</style>

<script src="/assets/js/grid.js"></script>
<script src="/assets/js/fetch_options_data.js"></script>
<script src="/assets/js/projectcost/contract.js"></script>
<script>
    //새창 아이콘 렌더러
    const newModalRenderer = window.NewModalRenderer;
    let SearchArr = new Array();
    var urlParams = new URLSearchParams(location.search);
    var spCntrct = urlParams.get('id') ? urlParams.get('id').split(".") : null;
    var urlCntrctNo = spCntrct ? spCntrct[0]+"."+spCntrct[1] : null;
    var urlCntrctId = urlParams.get('id');
    var cntrctNo;
    var cntrctId;

    var loadEurecaView = function(cntrctNo) {
        const eurecaDomain = '{{ eurecaDomain }}';
        const eurecaView = '{{ eurecaContractListView }}';
        const eurecaParams = `cntrctChgId=${cntrctNo}&IDPLSSOID=383b4dbd1ed596c63f29155e008e3d54dacad733960bfeace51b21ab06492460`;

        console.log('eurecaDomain', eurecaDomain)
        const ifrEureca = $('#ifrEureca');
        ifrEureca.hide();
        const ifr = document.getElementById( 'ifrEureca' );

        ifrEureca.css({
            width: '100%',
        }).attr('src', `${eurecaDomain}/${eurecaView}?${eurecaParams}`).on('load', function() {
            console.log('eurecaDomain load')
            setTimeout(function() {
                ifr.contentWindow.postMessage({'eventType' : 'iframeHeight', 'sendData': ''}, eurecaDomain);
                ifrEureca.show();
            }, 200);
        });
    }

    var init = function(){

        $("#depth_txt").text("{{ message('item.projectcost.016') }}");


        gaiaCommon.makeCntrctAndChgIdSelectBox(
            "#contract_container",
            "#cntrctChgId",
            // 계약 없음 콜백
            function() {
                gaiaCommon.LoadingOverlay('body', false);
            },
            // initCb: 초기 세팅 후 호출
            function(initialCntrctNo) {
                cntrctNo = $('cntrctNo').val();
                loadEurecaView(initialCntrctNo);
            },
            // chgCb: 값 변경 시 호출
            function(newCntrctNo) {
                // cntrctNo = $('cntrctNo').val();
                loadEurecaView(newCntrctNo);
            }
        );

/**
        if (urlCntrctNo) {
            // 계약 현황에서 공사비관리 페이지 오픈한 경우
            cntrctNo = urlCntrctNo;
        }
*/
        gaia.loaded = true;

        $("#close").click(function () {
			window.close();
		});
    };



    $(function(){
        gaia.create({
            $init: function ($params) {
                if(gaiaCommon.me.isAdmin() || isGAIA()){
                    $("#conts_tit").show();
                    $("#cntrct_no_select").show();
                }

                $("._unit_won").addClass(getCookie('lang'));

                gaiaPortal.navMenuInit('M0301', '{{ message("item.projectcost.902") }}');
                $("#menuDepth").append('<li class=\"breadcrumb_item\" id=\"depth_txt\">{{ message("item.projectcost.016") }}</li>');

                // 계약 현황에서 오픈한 경우 url 에 id 파라미터가 포함되어 있음
                if(urlParams.get('id') != null){
                } else {
                    // 공사비 관리 페이지로 들어온 경우 닫기 버튼 제거
                    $('#close').closest('.btn_area').hide();
                }

                init();

                gaia.loaded = true
            }
        });
    });

</script>
<script src="/webjars/jstree/jstree.min.js"></script>
<script src="/assets/js/tree.js"></script>
{% endblock footer_script %}
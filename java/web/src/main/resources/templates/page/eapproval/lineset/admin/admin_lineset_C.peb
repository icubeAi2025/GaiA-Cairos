<div class="modal open" id="create_modal">
    <div class="pop_box _md">
        <div class="pop_header">
            <h5 class="pop_tit">{{ message('item.app.007') }}</h5>
            <div class="btn_area">
                <button type="button" class="icon_btn pop_close" onclick="createModal.close()">
                    <i class="ic ic-close"></i>
                    <span class="tooltip">{{ message('item.com.037') }}</span>
                </button>
            </div>

        </div>
        <div class="pop_body">
            <div class="form_box" style="margin-bottom: 25px;">
                <div class="row">
                    <div class="col">
                        <div class="form_label required">{{ message('item.app.058') }}</div>
                        <div class="form_data">
                            <input type="text" id="apLineNm" maxlength="30">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="form_label required">{{ message('item.app.059') }}</div>
                        <div class="form_data">
                            <span class="selectbox" style="z-index: 2 !important;">
                                <select name="select_apDiv" id="select_apDiv">
                                    <option value="">{{ message('item.com.005') }}</option>
                                </select>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="box default">
                <div class="btn_area s_small">
                    <button type="button" class="btn _fill" id="addBtn" onclick="createModal.addLine()">
                        <i class="ic ic-people-plus-one"></i>
                        {{ message('btn.022') }}
                    </button>
                </div>
                <p class="data_info" id="info_msg">{{ message('msg.app.005') }} "{{ message('btn.001') }}" {{ message('msg.app.006') }}</p>
                <ol id="modal_apLine" class="sortable_list ol_colorsquare"></ol>
                <script>
                    $(function () {
                        $(".sortable_list").sortable();
                    });
                </script>
            </div>
        </div>

        <div class="pop_footer">
            <div class="btn_area s_default jc_e">
                <button type="button" class="btn _outline" onclick="createModal.close()">{{ message('btn.005') }}</button>
<!--                {{ btnHtml | raw }}-->
                <button type="button" class="btn _fill" id="ckeckAppLine" onclick="createModal.save()">{{ message('btn.006') }}</button>
            </div>
        </div>
    </div>
</div>

{% include "page/eapproval/lineset/lineset_dept" %}

<script>
    var createModal = {
        open(){
            $('#create_modal').addClass('open');
        },
        close(){
            $('#create_modal').removeClass('open');
            $('#popup').empty();
        },
        addLine(){
            lineCnt++;
            if(lineCnt > 0) {
                $('#info_msg').hide();
            }
            lineIndex++;
            $('#modal_apLine').append(this.makeHtml());
        },
        makeHtml(){
            return `<li class="sortable_item appLine" data-index="${lineIndex}">
                        <div class="item_group">
                            <div class="search_wrap w-full">
                                <span class="selectbox">
                                    <select name="" id="apDivType" class="" onchange="createModal.changeApDiv(this)">
                                        <option value="A">{{ message('item.app.008') }}</option>
                                        <option value="R">{{ message('item.app.009') }}</option>
                                    </select>
                                </span>
                                <div class="searchbox_wrap">
                                    <input type="text" class="search_event" id="addAppLineName"
                                        placeholder="{{ message('msg.app.022') }}"
                                        oninput="page.search(event)"
                                        onkeyup="if(window.event.keyCode == 13 ) page.search(event)">
                                    <button type="button" class="icon_btn search_event" onclick="page.search(event)">
                                        <i class="ic ic-search"></i>
                                        <span class="blind">검색</span>
                                    </button>
                                    <button type="button" class="icon_btn" onclick="deptModal.open(${lineIndex}, 'admin')">
                                        <i class="ic ic-broadcast-one"></i>
                                        <span class="blind">조직도보기</span>
                                    </button>
                                    <div class="lay_pop filter_list" id="autoMaker"><div>
                                </div>
                            </div>
                            <button type="button" class="icon_btn" id="delAppLine" onclick="page.delLine(event);">
                                <i class="ic ic-close"></i>
                                <span class="blind">삭제</span>
                            </button>
                        </div>
                        <input type="hidden" id="choiceStatus" value="false">
                        <input type="hidden" id="add_usr_id" value="">
                        <input type="hidden" id="add_login_id" value="">
                        <input type="hidden" id="usr_nm" value="">
                    </li>`;
        },
        save(){
            let lineSet = [];
            var appLine = $(".sortable_item.appLine:visible");

            if(!$('#apLineNm').val()) {
                gaiaCommon.customAlert("{{ message('msg.app.047') }}");
                $('#apLineNm').focus();
                return
            }

            if(!$('#select_apDiv').val()) {
                gaiaCommon.customAlert("{{ message('msg.app.048') }}");
                $('#select_apDiv').focus();
                return
            }

            if(selectUsers.length < 1) {
                gaiaCommon.customAlert("{{ message('msg.app.049') }}");
                return
            }

            $(appLine).each(function(index, obj) {
                let apDiv = $(obj).find('#apDivType').val()
                let usrId =  $(obj).find('#add_usr_id').val();
                let loginId =  $(obj).find('#add_login_id').val();

                if(apDiv && usrId && loginId) {
                    lineSet.push({
                        apOrder: index+1,
                        apDiv: apDiv,
                        apUsrId: usrId,
                        apLoginId: loginId
                    })
                }
            })

            let data = {
                cntrctNo: $('#cntrctNo').val(),
                apLinesetMng: {
                    indvdlYn: 'N',
                    apType: $('#select_apDiv').val(),
                    apLineNm: $('#apLineNm').val()
                },
                apLineSet: lineSet,
            }

            gaiaCommon.LoadingOverlay('body', true);

            gaiaCommon.post("/api/eapproval/lineset/save-admin-lineset", data, function(result) {
                if(result.ok) {
                    gaiaCommon.customAlert("{{ message('msg.044') }}", function () {
                        location.reload();
                    });
                }
            }, function (error) {
                gaiaCommon.LoadingOverlay('body', false);
                if(error.errorCode === '1003') {
                    gaiaCommon.customAlert("{{ message('msg.app.050') }}");
                } else {
                    gaiaCommon.customAlert("{{ message('msg.060') }}");
                }
            });
        },
        changeApDiv(target){
            let usrId = $(target).closest('li').find('#add_usr_id').val();
            let apDiv = $(target).val();
            let prevDiv = apDiv === 'A' ? 'R' : 'A';

            if(usrId === '') {
                return
            }

            let isDuplicate = page.duplicate(usrId, apDiv);

            if (isDuplicate) {
                gaiaCommon.customAlert("{{ message('msg.app.023') }}");
                selectUsers = selectUsers.filter(item => !(item.userId === usrId && item.apDivType === prevDiv));
                $(target).closest('li').find('#add_usr_id').val('');
                $(target).closest('li').find('#add_login_id').val('');
                $(target).closest('li').find('#usr_nm').val('');
                $(target).closest('li').find('#addAppLineName').val('');
                $(target).closest('li').find('#choiceStatus').val('false');
                return;
            }

        },
        getSelectOptions() {
            gaiaCommon.get("/api/eapproval/approval/optionsList", "", function(result) {
                var tList = result.details.apTypeList;
                $.each(tList, function (index, obj) {
                    if(obj.cmnCd !== '01') {
                        $('#select_apDiv').append(`<option value="${obj.cmnCd}">${obj.cmnCdNmKrn}</option>`);
                    }
                })
            }, function (error) {
                gaiaCommon.customAlert("{{ message('msg.060') }}");
            });
        },
    }

    $(document).on('click', function(event) {
        var $target = $(event.target);

        // 결재선
        if (!$target.closest('.lay_pop.filter_list').length) {
            $('#modal_apLine .lay_pop.filter_list').removeClass('on');
        }

    });

    // 검색결과 focus이벤트
    $(document).on('click focus blur', '.search_event', function(event) {
        let focusYn = event.type === 'focus' || event.type === 'click';
        page.setFocus(event, focusYn);
    });


    $(function(){
        lineCnt = 0;
        lineIndex = 0;
        selectUsers = [];

        createModal.getSelectOptions();

        gaia.loaded = true;
    })
</script>
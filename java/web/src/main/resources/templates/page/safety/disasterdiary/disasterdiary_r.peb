{% extends 'layout/base_content' %}
{% block content %}
    <!-- 본문 영역 -->
<section class="contents_wrap">
    <article class="conts_area">
        <div class="conts">
            <div class="conts_form">
                <div class="btn_area s_default">
                    {{ btnHtml | raw }}
                    <!--<button type="button" class="btn _outline" id="edit">{{ message("btn.003") }}</button>-->
                    <button type="button" class="btn _outline" id="cancel">{{ message("btn.007") }}</button>
                </div>

                <form id='inputForm'>
                    <!--재해현황 S-->
                    <div class="s_conts" id="accidentDiv">
                        <span class="tree_route">{{ message("item.safetydiary.015") }}</span>

                        <div class="row cols form_box">
                            <div class="form_label" style="border-right: 1px solid var(--tb-bd);">재해 발생 현황</div>
                            <div style="width: 100%;">
                                <div class="conts_form">
                                    <div class="group">
                                        <!-- row -->
                                        <div class="row">
                                            <div class="col">
                                                <!-- 재해일자 -->
                                                <div class="form_label required">재해일자</div>
                                                <div class="form_data">
                                                    <span id="disasDt" name="disasDt" style="padding-left: 14px;"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- row -->
                                        <div class="row">
                                            <div class="col">
                                                <!-- 재해원인 -->
                                                <div class="form_label">재해원인</div>
                                                <div class="form_data">
                                                    <textarea id="disasCause" name="disasCause" class="maxlength" maxlength="5000" readonly></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- row -->
                                        <div class="row">
                                            <div class="col">
                                                <!-- 재해조치 -->
                                                <div class="form_label">재해조치</div>
                                                <div class="form_data">
                                                    <textarea id="disasAction" name="disasAction" class="maxlength" maxlength="5000" readonly></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col">
                                                <div class="form_label">재해인원</div>
                                                <div class="form_data">
                                                    <!-- 재해현황 테이블 -->
                                                    <div class="conts_grid" style="width: 100%;">
                                                        <table class="table ta_c">
                                                            <colgroup>
                                                                <col style="width:32%">
                                                                <col style="width:32%">
                                                            </colgroup>
                                                            <!-- 첫 번째 헤더 행 -->
                                                            <thead>
                                                            <tr>
                                                                <th scope="col">직종</th>
                                                                <th scope="col">성명</th>
                                                            </tr>
                                                            </thead>
                                                            <!-- 첫 번째 데이터 행 -->
                                                            <tbody id="disasterUserBody">
                                                                <tr class="disasterUserContent">
                                                                    <tr id="disasterUserDefaultContent">
                                                                        <td colspan="7">조회된 데이터가 없습니다.</td>
                                                                    </tr>
                                                                </tr>
                                                            </tbody>

                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--재해현황 E-->
                </form>
            </div>
        </div>
    </article>
</section>

{% endblock content %}

{% block footer_script %}
    <script>
        var urlParams = new URLSearchParams(location.search);
        var cntrctNo = urlParams.get('cntrctNo');
        var disasId = urlParams.get('disasId');
        var AccidentUserStatus = {};    // 재해인원 관련 모듈
        var page = {};

        page = {
            load: function () {
                gaiaCommon.LoadingOverlay('body', true);

                gaiaCommon.get(`/api/safety/disaster-diary/detail`,{
                    disasId: disasId,
                    cntrctNo: cntrctNo
                }, function(response){
                    gaiaCommon.LoadingOverlay('body', false);
                    console.log(response);

                    const disasterDiary = response.details.data.disasterDiary;
                    const disasterDiaryUserList = response.details.data.disasterUserList;

                    /* 재해현황 */
                    if (disasterDiary != null ) {
                        let repoDt = disasterDiary['disas_dt'];

                        if (/^\d{8}$/.test(repoDt)) {
                            const formatted = repoDt.replace(/^(\d{4})(\d{2})(\d{2})$/, '$1-$2-$3'); // "2025-08-23"
                            $('#disasDt').text(formatted);

                        }

                        // $("#disasDt").val(repoDt);
                        $("#disasCause").val(disasterDiary['disas_cause']);
                        $("#disasAction").val(disasterDiary['disas_action']);

                    }

                    /* 재해인원 */
                    if (disasterDiaryUserList != null) {
                        AccidentUserStatus.load(disasterDiaryUserList);
                    }
                });
            },

            // 수정
            update: function () {
                window.location.href = `/safety/disaster-diary/update?cntrctNo=${cntrctNo}&disasId=${disasId}`;
            },

        }

        AccidentStatus = {
            deletedDisasterUserIds: [],
        };

        AccidentUserStatus = {
            load: function (dataList) {
                $('#disasterUserDefaultContent').remove();
                if (dataList != null && dataList.length > 0) {
                    dataList.forEach((elem, idx) => {
                        let newRow = `
                        <tr class="disasterUserContent">
                            <td><span name="diasa_vic_occu" cols="30" rows="6" readonly>${elem.diasa_vic_occu}</input></td>
                            <td><span name="diasa_vic_nm" cols="30" rows="6" readonly>${elem.diasa_vic_nm}</input></td>
                       </tr>
                    `;
                        $("#disasterUserBody").append(newRow);
                    });
                }
                else {
                    let emptyRow = `
                        <tr id="disasterUserDefaultContent">
                            <td colspan="7">조회된 데이터가 없습니다.</td>
                        </tr>
                    `;
                    $("#disasterUserBody").append(emptyRow);
                }
            }
        }

        /************************************************************
         * 페이지 이벤트 바인딩
         ***********************************************************/
        // [수정] 버튼 이벤트 바인딩
        $("#edit").click(page.update);

        // [닫기] 버튼 이벤트 바인딩
        $("#cancel").click(function () {
            window.location.href = "/safety/disaster-diary" + `?pjtNo=${pjtInfo.pjtNo}&cntrctNo=${pjtInfo.cntrctNo}&_condition=init`;
        });

        /************************************************************
         * 페이지 로드
         ***********************************************************/
        $(document).ready(() => {
            gaia.create({
                $init: function ($params) {
                    // 메뉴 정보 init
                    gaiaPortal.navMenuInit('M10_DSD', "재해일지 조회");

                    // 상세데이터 조회
                    page.load();

                }
            });
        })
    </script>
{% endblock footer_script %}
{% block content %}
<div class="modal open">
    <div class="pop_box _sm">
        <div class="pop_header">
            <h3 class="pop_tit" id="work_cu_tit"></h3>
            <button type="button" class="icon_btn pop_close" onclick="popupWork.close()">
                <i class="ic ic-close"></i>
                <span class="blind">창닫기</span>
            </button>
        </div>

        <div class="pop_body">
            <div class="form_box" id="work-form">
                <div class="container" style="display: flex; align-items: center;">
                    <span class="caption">
                        <span><b class="c_red">*</b> {{ message('item.com.023') }}</span>
                    </span>
                </div>
                <form id="dept-form">
                    <!-- row -->
                    <div class="row">
                        <div class="col">
                            <div class="form_label">{{ message('item.quality.057') }}</div>
                            <div class="form_data">
                                <input type="text" id="upCnsttyCd" name="upCnsttyCd" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form_label required" id="cnsttyCd_form">{{ message('item.quality.054') }}</div>
                            <div class="form_data">
                                <div class="item_group">
                                    <input type="text" class="form-control maxlength" id="cnsttyCd" name="cnsttyCd"
                                        maxlength="20">
                                    <button type="button" class="btn _fill s_small" onclick="popupWork.check()">{{
                                        message('btn.028') }}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col merge3">
                            <div class="form_label required">{{ message('item.quality.055') }}</div>
                            <div class="form_data">
                                <input type="text" id="cnsttyNm" name="cnsttyNm" class="maxlength" maxlength="50">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="pop_footer">
            <div class="btn_area jc_e">
                <button type="button" class="btn _outline" onclick="popupWork.close()">{{ message('btn.007') }}</button>
                <button type="button" class="btn _fill" id="addButton" onclick="popupWork.save()">{{ message('btn.006')
                    }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}{% block footer_script %}
<script src="/assets/js/validation.js"></script>
<script>
    var popupWork = {
        mode: "",
        parent: {},
        popupWindow: null,
        isChecked: false,   // 중복체크 확인여부
        isDuplicate: false, // 중복 체크 결과 여부
        init: function () {
            if (this.isInitialized) return;
            this.isInitialized = true;

            this.mode = work.mode;

            if (this.mode === "update") {
                $("#upCnsttyCd").val(work.parent);
                $("#cnsttyCd").val(gaiaCommon.decodeSafeText(work.obj.id));
                $("#cnsttyNm").val(gaiaCommon.decodeSafeText(work.obj.text));

                $("#cnsttyCd").prop("readonly", true);
                $(".btn._fill.s_small").hide();
                $("#cnsttyCd_form").removeClass("required");
            } else {
                $("#upCnsttyCd").val(gaiaCommon.decodeSafeText(work.obj.id));

                $("#cnsttyCd").prop("readonly", false);
                $(".btn._fill.s_small").show();
            }
            $("#work_cu_tit").text("{{ message('item.quality.052') }}");

            $("#cnsttyCd").on('input', function () {
                popupWork.isChecked = false;
                popupWork.isDuplicate = false;
            });
        },
        close: function () {
            $("#popupWork").find("input[type='text'], textarea, select").val("");
            // 모든 text input 초기화
            $("#popupWork").css("display", "none");
            if (this.popupWindow) {
                this.popupWindow.close();
                this.popupWindow = null;
            }
            this.isChecked = false; // 중복 체크 수행 여부 초기화
            this.isDuplicate = false; // 중복 체크 결과 초기화
            this.isInitialized = false;
        },
        save: function () {
            if (this.mode == "create") {
                this.create();
            } else if (this.mode == "update") {
                this.update();
            }
        },
        // 하위 공종 추가
        create: function () {
            var cnsttyCd = $("#cnsttyCd").val();
            if (!cnsttyCd) {
                gaiaCommon.customAlert("{{ message('msg.quality.020') }}"); // 공종 코드를 입력해주세요.
                $('#cnsttyCd').focus();
                return;
            }

            let cntrctNoToUse = $("input[name='useYnGrid']:checked").val() === "Y" ? "CMIS" : cntrctNo;
            if (!gaiaCommon.me.info.admin) {
                cntrctNoToUse = cntrctNo;
            }

            if (!this.isChecked && work.obj.id.split('.').pop() !== document.getElementById("cnsttyCd").value) {
                gaiaCommon.customAlert("{{ message('msg.quality.018') }}");    // 코드명 중복 체크를 먼저 해주세요.
                return;
            }
            if (this.isDuplicate) {
                gaiaCommon.customAlert("{{ message('msg.quality.019') }}"); // 이미 존재하는 공종 코드입니다.
                return;
            }
            var cnsttyNm = $("#cnsttyNm").val();
            if (!cnsttyNm) {
                gaiaCommon.customAlert("{{ message('msg.quality.021') }}"); // 공종 명을 입력해주세요.
                $('#cnsttyNm').focus();
                return;
            }
            let param = {
                cntrctNo: cntrctNoToUse,
                cnsttyLvl: work.obj.data.level + 1,
                cnsttyYn: 'Y',
                cnsttyCd: cnsttyCd,
                cnsttyNm: cnsttyNm,
                upCnsttyCd: work.obj.id,
            };

            gaiaCommon.LoadingOverlay('body', true);
            $.ajax({
                url: "/api/safetymgmt/check/create/work",
                method: "POST",
                data: JSON.stringify(param),
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    gaiaCommon.customAlert("{{ message('msg.044') }}", function () {
                        gaiaCommon.LoadingOverlay('body', false);
                        popupWork.close();
                        $("#jstree").jstree(true).refresh();
                        $("#workcode").val("");
                        $("#workname").val("");
                        safety.resetGridData();
                    });
                },
                error: function (xhr, status, error) {
                    gaiaCommon.LoadingOverlay('body', false);
                    gaiaCommon.customAlert('{{ message("msg.045") }}');	// 저장에 실패 했습니다.
                }
            });
        },
        update: function () {
            var cnsttyCd = $("#cnsttyCd").val();
            if (!cnsttyCd) {
                gaiaCommon.customAlert("{{ message('msg.quality.020') }}"); // 공종 코드를 입력해주세요.
                return;
            }
            var cnsttyNm = $("#cnsttyNm").val();
            if (!cnsttyNm) {
                gaiaCommon.customAlert("{{ message('msg.quality.021') }}"); // 공종 명을 입력해주세요.
                return;
            }
            let param = {
                cntrctNo: work.obj.data.cntrctNo,
                cnsttyNm: $("#cnsttyNm").val(),
                cnsttyLvl: work.obj.data.level,
                cnsttyCd: cnsttyCd,
                upCnsttyCd: work.parent,
                isplstId: work.obj.data.isplstId
            };

            gaiaCommon.LoadingOverlay('body', true);
            $.ajax({
                url: "/api/safetymgmt/check/update/work",
                method: "POST",
                data: JSON.stringify(param),
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    gaiaCommon.customAlert("{{ message('msg.007') }}", function () {
                        gaiaCommon.LoadingOverlay('body', false);
                        popupWork.close();
                        $("#jstree").jstree(true).refresh();
                        $("#workcode").val("");
                        $("#workname").val("");
                        safety.resetGridData();
                    });
                },
                error: function (xhr, status, error) {
                    gaiaCommon.LoadingOverlay('body', false);
                    console.error("Error occurred: " + error);
                }
            });
        },
        // 중복 체크 함수
        check: function () {
            var cnsttyCd = $("#cnsttyCd").val();

            if (!cnsttyCd) {
                gaiaCommon.customAlert("{{ message('msg.quality.020') }}"); // 공종 코드를 입력해주세요.
                return;
            }

            var param = {
                cnsttyCd: cnsttyCd,
            };

            $.ajax({
                url: "/api/safetymgmt/check/checkCode",
                method: "POST",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(param),
                success: function (response) {
                    console.log("중복코드:", response);
                    popupWork.isChecked = true; // 중복 체크가 수행됨
                    if (response.details && response.details.result) { // 중복 값이 있을 경우
                        popupWork.isDuplicate = true;
                        gaiaCommon.customAlert("{{ message('msg.quality.019') }}"); // 이미 존재하는 공종 코드입니다.
                    } else { // 중복 값이 없을 경우
                        popupWork.isDuplicate = false;
                        gaiaCommon.customAlert("{{ message('msg.quality.022') }}"); // 사용 가능한 공종 코드입니다.
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error occurred: " + error);
                }
            });
        },
    };

    window.popupWork = popupWork;
</script>
{% endblock %}
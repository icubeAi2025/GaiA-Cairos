{% extends header ? 'layout/base_popup' : 'layout/base_content' %}
{% block content %}
<article class="conts g-row">
	<div class="group">
		<div class="conts_form" id="read-form">			
            <div class="btn_area s_default">
                {{ btnHtml | raw }}
                <button type="button" class="btn _outline" id="close-popup" onclick="page.close()">{{ message('btn.007') }}</button>
				<div class="btn_group iconbtns" id="popupBtn">
                    <button class="icon_btn" id="open-new-window" onclick="page.popupView()">
                        <i class="fa-solid fa-up-right-from-square"></i>
                        <span class="tooltip">팝업창으로 보기</span>
                    </button>
                </div>
				<div class="btn_group iconbtns" id="eduDtBtn" style="display: none; width: 100%;">
                    <span class="selectbox"style="justify-content : right;">
						<select name="eduId" id="eduId" style="width: 250px; justify-content : right;" onchange="page.search(this.value)"></select>
					</span>
                </div>
            </div>
			<div class="s_conts">
				<div class="form_box">
					<!-- row -->
					<div class="row cols2">
						<div class="col">
							<div class="form_label" style="justify-content : center;">교육구분명</div>
							<div class="form_data">
								<div class="item_group">
									<input type="text" id="eduTypeNm" readonly/>
								</div>
							</div>
						</div>
						<div class="col">
							<div class="form_label" style="justify-content : center;">교육일자</div>
							<div class="form_data">
								<div class="item_group">
									<input type="text" id="eduDt" readonly/>
								</div>
							</div>
						</div>
					</div>
					<div class="row cols2">
						<div class="col">
							<div class="form_label" style="justify-content : center;">교육자 직위(직책)</div>
							<div class="form_data">
								<div class="item_group">
									<input type="text" id="edu_rank" readonly/>
								</div>
							</div>
						</div>
						<div class="col">
							<div class="form_label" style="justify-content : center;">교육자 성명</div>
							<div class="form_data">
								<div class="item_group">
									<input type="text" id="edu_nm" readonly/>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<div class="form_label" style="justify-content : center;">교육인원</div>
							<div class="form_data">
								<div class="item_group">
									<table class="table ta_c table-scroll">
										<colgroup>
											<col width="20%">
											<col width="10%">
											<col width="10%">
											<col width="10%">
											<col>
										</colgroup>
										<thead>
											<tr>
												<th>구분</th>
												<th>남</th>
												<th>여</th>
												<th>계</th>
												<th>비고</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td>교육 대상 근로자수</td>
												<td id="edu_surv_m"></td>
												<td id="edu_surv_f"></td>
												<td id="edu_surv_sum"></td>
												<td><input type="text" id="edu_surv_note" style="background-color: #FFF;" disabled /></td>
											</tr>
											<tr>
												<td>교육 실시 근로자수</td>
												<td id="edu_acti_m"></td>
												<td id="edu_acti_f"></td>
												<td id="edu_acti_sum"></td>
												<td><input type="text" id="edu_acti_note" style="background-color: #FFF;" disabled /></td>
											</tr>
											<tr>
												<td>교육 미실시 근로자수</td>
												<td id="edu_no_acti_m"></td>
												<td id="edu_no_acti_f"></td>
												<td id="edu_no_acti_sum"></td>
												<td><input type="text" id="edu_no_acti_note" style="background-color: #FFF;" disabled /></td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<div class="form_label" style="justify-content : center;">교육내용의 개요</div>
							<div class="form_data">
								<div class="item_group">
									<textarea id="outline" style="background-color: #FFF;" disabled></textarea>
								</div>
							</div>
						</div>
					</div>
					<div class="row cols2">
						<div class="col">
							<div class="form_label" style="justify-content : center;">과목 또는 사항</div>
							<div class="form_data">
								<div class="item_group">
									<textarea id="subject" style="background-color: #FFF;" disabled></textarea>
								</div>
							</div>
						</div>
						<div class="col">
							<div class="form_label" style="justify-content : center;">교육방법</div>
							<div class="form_data">
								<div class="item_group">
									<textarea id="method" style="background-color: #FFF;" disabled></textarea>
								</div>
							</div>
						</div>
					</div>
					<div class="row cols2">
						<div class="col">
							<div class="form_label" style="justify-content : center;">교육시간</div>
							<div class="form_data">
								<div class="item_group">
									<textarea id="time" style="background-color: #FFF;" disabled></textarea>
								</div>
							</div>
						</div>
						<div class="col">
							<div class="form_label" style="justify-content : center;">사용교재등</div>
							<div class="form_data">
								<div class="item_group">
									<textarea id="textbook" style="background-color: #FFF;" disabled></textarea>
								</div>
							</div>
						</div>
					</div>
					<div class="row cols2">
						<div class="col">
							<div class="form_label" style="justify-content : center;">교육장소</div>
							<div class="form_data">
								<div class="item_group">
									<textarea id="location" style="background-color: #FFF;" disabled></textarea>
								</div>
							</div>
						</div>
						<div class="col">
							<div class="form_label" style="justify-content : center;">비고</div>
							<div class="form_data">
								<div class="item_group">
									<textarea id="note" style="background-color: #FFF;" disabled></textarea>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<div class="form_label" style="justify-content : center;">교육 참석자</div>
							<div class="form_data">
								<div class="col">
									<table class="table ta_c table-scroll">
										<colgroup>
											<col width="50%">
											<col>
										</colgroup>
										<thead>
											<tr>
												<th>직위 (직책)</th>  
												<th>성명</th>
											</tr>
										</thead>
										<tbody id="personnel">
											<tr id="eduDefault">
												<td colspan="2">등록된 교육 참석자가 없습니다.</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
					<div class="row cols">
						<div class="col">
							<div class="form_label">첨부파일</div>
							<div class="form_data">

								<div class="attach_wrap">
									<div class="attach_toolbar">
										<div class="attach_info">
										</div>
									</div>

									<div class="attach_area">
										<!-- 첨부파일 미등록 시 -->
										<p class="data_info">
											{{ message('msg.pinstall.003') }}
										</p>

										<!-- 첨부파일 등록 시 활성화 'hide' 제거-->
										<div class="attach_list hide">
											<ul class="file_header">
												<li class="header_item"
													style="display:flex; justify-content:space-between;">
													<span class="f_name">{{ message('item.com.020') }}</span>
													<!-- 파일명 -->
													<span class="f_capacity">{{ message('item.com.021') }}</span>
													<!-- 크기 -->
												</li>
											</ul>
											<ul class="file_list" id="fileList"></ul>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>			
		</div>
	</div>   
</article>
{% endblock content %} 
{% block footer_script %}
<script>
	let eduId;
	let popupCheck = '{{ header | raw }}';
	let openType = '{{ openType | raw }}';

	if(popupCheck === 'true') {
		$('#popupBtn').css('display', 'none');
	}	

	//부모창 변경 시 팝업창 닫기
	// $(window).on("blur", function () {
	// 	self.close();
	// });

    var page = {
        init: function () {
			// 첨부파일 관리자 초기화
			attachmentFile.init();

			eduId = page.getEduIdFromUrl();
			page.loadEduDiaryData(eduId);
        },

		getEduIdFromUrl: function () {
			const pathArray = window.location.pathname.split('/'); //'/'를 기준으로 url의 데이터를 배열로 저장.
			return pathArray[pathArray.length - 1]; //가장 마지막 요소(path-variable)를 추출.
		},

		loadEduDiaryData: function (eduId) {
			let readData = {
				eduId : eduId,
				openType: openType
            };
			gaiaCommon.get(
				"/api/safety/educationdiary/eduDiary-read",
				readData,
				function (result) {
					if(result.details?.educationDiaryInfoList){

						let educationDiaryInfo = result.details?.educationDiaryInfoList.educationDiaryInfo;

						console.log('data ::: ', result.details?.educationDiaryInfoList)
						educationDiaryInfo.forEach((item, index) => {
							if(index === 0) {
								$('#eduTypeNm').val(item.edu_type_nm);								
								$('#eduDt').val(item.edu_dt);
								$('#edu_rank').val(item.edu_rank);		
								$('#edu_nm').val(item.edu_nm);		
								$('#edu_surv_m').text(item.edu_surv_m);
								$('#edu_surv_f').text(item.edu_surv_f);
								$('#edu_surv_sum').text(item.edu_surv_m+item.edu_surv_f);
								$('#edu_surv_note').val(item.edu_surv_note);
								$('#edu_acti_m').text(item.edu_acti_m);
								$('#edu_acti_f').text(item.edu_acti_f);
								$('#edu_acti_sum').text(item.edu_acti_m+item.edu_acti_f);
								$('#edu_acti_note').val(item.edu_acti_note);
								$('#edu_no_acti_m').text(item.edu_no_acti_m);
								$('#edu_no_acti_f').text(item.edu_no_acti_f);
								$('#edu_no_acti_sum').text(item.edu_no_acti_m+item.edu_no_acti_f);
								$('#edu_no_acti_note').val(item.edu_no_acti_note);
								$('#outline').val(item.outline);
								$('#subject').val(item.subject);
								$('#method').val(item.method);
								$('#time').val(item.time);
								$('#textbook').val(item.textbook);
								$('#location').val(item.location);
								$('#note').val(item.note);
								if(item.edu_vic_occu) {
									$('#eduDefault').remove();
								}
							}

							if(item.edu_vic_occu) {
								let subTr = document.createElement('tr');
								subTr.innerHTML =	`
														<td>${item.edu_vic_occu}</td>
														<td>${item.edu_vic_nm}</td>
													`;
								
								$('#personnel').append(subTr);
							}
						});

						if(openType === 'true') {
							let eduTypeList = result.details?.educationDiaryInfoList.eduTypeList;
							if(eduTypeList.length > 1) {
								$('#eduDtBtn').css('display', 'block');

								eduTypeList.forEach((item, index) => {
									let addOption = document.createElement('option');
									addOption.setAttribute('value', item.edu_id);				
									addOption.innerHTML = item.edu_dt;
									$("#eduId").append(addOption);
								});
							}

							$("#eduId").val(eduId).attr("selected", "selected");	
						}

						const attachments = result.details?.educationDiaryInfoList.fileList || [];
						// 첨부파일 로드
						attachmentFile.processFiles(attachments);

					}else{
						// 프로그램 정보가 존재하지 않습니다.
						gaiaCommon.customAlert("{{ message('msg.105') }}", function(){
							page.close();
						});
					}
				}, function (error) {
					console.log("오류 처리 로직 추후 추가!!!!!!");
				}
			);
		},

		popupView: function () {
			let url = window.location.pathname + window.location.search + "?type=p";

			const _width = '1300';
            const _height = '1150';

            let _left = Math.ceil((window.screen.width - _width)/2);
            _left += window.screenLeft; // 듀얼 모니터일 때

            const _top = Math.ceil((window.screen.height - _height)/2);
			window.open(url, "교율일지 상세", 'width='+_width+', height='+_height+',left='+_left+',top='+_top+', scrollbars=yes, resizable=yes');
			location.replace(`/safety/educationdiary?pjtNo=${pjtInfo.pjtNo}&cntrctNo=${pjtInfo.cntrctNo}&_condition=init`);
		},

		search: function (selectEduId) {
			let url = "/safety/educationdiary/read/" + selectEduId + "?type=i";
			window.location.replace(url);
		},

		//수정 페이지 이동
		update: function () {
            window.location.href = `/safety/educationdiary/update_ready/`+eduId;
        },        

		//닫기 이벤트
		close: function () {
			if(popupCheck === 'true') {
				self.close();
			} else {
				window.location.replace(`/safety/educationdiary?pjtNo=${pjtInfo.pjtNo}&cntrctNo=${pjtInfo.cntrctNo}&_condition=init`);
			}
        },        
	};

	/************************************************************
	 * 첨부파일 관리 (조회 전용)
	 ***********************************************************/
	let attachmentFile = {
		totalFileSize: 0,
		serverFiles: [],

		init() {
			this.fileList = document.getElementById('fileList');
		},

		// 서버에서 받은 파일 목록 세팅
		processFiles(attachments) {
			if (!attachments || attachments.length === 0) {
				this.clearFileList();
				return;
			}

			this.serverFiles = attachments.map(file => ({
				name: file.fileNm,
				size: Number(file.fileSize) || 0,
				fileNo: file.fileNo,
				sno: file.sno
			}));
			this.renderFileList();
		},

		clearFileList() {
			if (this.fileList) this.fileList.innerHTML = '';
			this.totalFileSize = 0;

			const dataInfo = document.querySelector('.data_info');
			const attachList = document.querySelector('.attach_list');
			if (dataInfo && attachList) {
				dataInfo.classList.remove('hide');
				attachList.classList.add('hide');
			}
		},

		renderFileList() {
			if (!this.fileList || this.serverFiles.length === 0) {
				this.clearFileList();
				return;
			}

			this.fileList.innerHTML = '';
			this.totalFileSize = 0;

			document.querySelector('.data_info').classList.add('hide');
			document.querySelector('.attach_list').classList.remove('hide');

			this.serverFiles.forEach(file => {
				const li = this.createFileItem(file);
				this.fileList.appendChild(li);
				this.totalFileSize += file.size;
			});
		},

		createFileItem(file) {
			const li = document.createElement('li');
			li.classList.add('list_item');
			li.style.display = "flex";
			li.style.justifyContent = "space-between";
			li.style.alignItems = "center";

			// 파일명
			const fileName = document.createElement('span');
			fileName.classList.add('f_name');
			fileName.textContent = file.name;
			fileName.style.cursor = 'pointer';
			fileName.addEventListener('click', () => {
				this.download(`/api/util/CW_EDUCATION/${file.fileNo}/${file.sno}/file-download`);
			});

			// 크기
			const fileSize = document.createElement('span');
			fileSize.classList.add('f_capacity');
			fileSize.textContent = this.formatFileSize(file.size);

			li.appendChild(fileName);
			li.appendChild(fileSize);

			return li;
		},

		formatFileSize(size) {
			if (size >= 1024 * 1024) return (size / (1024 * 1024)).toFixed(2) + ' MB';
			if (size >= 1024) return (size / 1024).toFixed(2) + ' KB';
			return size + ' bytes';
		},

		download(url) {
			const a = document.createElement('a');
			a.href = url;
			a.download = '';
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
		}
	};


	$(function () {
        gaia.create({
            $init: function ($params) {
                page.init();
				gaiaPortal.navMenuInit("M10_EDU", "{{ message('item.education.005') }}");
				$("#menuDepth").append('<li class=\"breadcrumb_item\">'+ "{{ message('item.education.005') }}" +'</li>');

                gaia.loaded = true
            }
        });
    });
</script>
{% endblock footer_script %}
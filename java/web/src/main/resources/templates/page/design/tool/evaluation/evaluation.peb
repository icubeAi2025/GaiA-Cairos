{% extends 'layout/base_content' %} {% block head %}
<style>
    td {
        position: relative;
        max-width: 80px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .icon_btn.detail-btn,
    .icon_btn.act-btn {
        position: absolute;
        right: 10px;
        top: 10px;
    }

    .ty_list .more_data dt {
        width: 150px;
    }

    .ty_list .more_data dd {
        width: calc(100% - 150px - .5em);
        margin: 0;
    }

    .selected-row {
        background: var(--select-list-bg);
    }

    .gridContainer.active {
        display: flex;
        gap: 10px;
    }

    .gridContainer.active #grid {
        width: 55%;
    }

    .gridContainer.active #popup {
        width: 45%;
        display: block;
    }

    .ty_list h2 {
        margin-bottom: 0;
        color: #548554;
    }

    .name_color {
        font-size: medium;
        color: #548554;
        font-weight: 600;
        margin-right: 10px;
    }

    .activity_css {
        display: flex;
		justify-content: space-between;
		align-items: center;
		position: relative;
        padding-right: 17px;
		overflow: hidden;
    }

    .activity_link {
        flex-grow: 1;
		min-width: 0; 
		overflow: hidden;
		white-space: nowrap;
		text-overflow: ellipsis;
		text-decoration: none;
		color: inherit;
		display: block;
		max-width: 100%;
    }

    .min_width_css {
        min-width: 90px !important;
    }

    .width_css {
        width: 100% !important;
    }

    .dfccy_btn .slick_nav .icon_btn {
        width: 30px !important;
        height: 30px !important;
    }

    .chkbox {
        min-height: 30px !important;
    }

    #page_contents .toolbar>.btn_area{ width: 100%; margin-right:0; }
    #page_contents .toolbar>.btn_area .slick_nav{ position: static; margin-left: auto; }
</style>
{% endblock %} {% block content %}
<section class="contents_wrap g-col2 ty1">
    {% include "page/design/tool/common_tree" %}
    <article class="conts_area">
        <div class="conts g-row">
            <div class="conts_grid">
                {% include "page/design/tool/common_select" %}
                <div class="conts_grid" id="page_contents">
                    <span class="tree_route" id="dsgn_phase_path">
                        {{ message('item.dsgn.027') }}
                    </span>
                    <div class="search_wrap">
                        <span class="selectbox">
                            <select name="dsgnType" id="selectbox_dsgn">
                                <!-- <option selected disabled value="">{{ message('item.dsgn.007') }}</option> -->
                            </select>
                        </span>
                        <span class="selectbox">
                            <select name="apprerStatus" id="selectbox_confirm">
                                <option selected disabled value="">{{ message('item.dsgn.028') }}</option>
                                <option value="all">{{ message('btn.038') }}</option>
                                <option value="none">{{ message('item.dsgn.029') }}</option>
                                <option value="0301">{{ message('item.dfccy.009') }}</option>
                                <option value="0302">{{ message('item.dfccy.010') }}</option>
                            </select>
                        </span>
                        <!-- searchbox -->
                        <div class="searchbox_wrap">
                            <!-- 검색어 입력창 -->
                            <input type="text" id="search_text" placeholder="{{ message('item.dfccy.019') }}, {{ message('item.com.060') }}, {{ message('item.dsgn.008') }}" onkeypress="if(event.keyCode == 13){page.search();}">
                            <!-- 상세검색 아이콘 -->
                            <button type="button" class="btn icon_btn filter" onclick="page.detailSearch.open();">
                                <i class="ic ic-setting-config"></i>
                                <span class="blind">{{ message('item.com.044') }}</span>
                            </button>
                            <!-- 일반검색 아이콘 -->
                            <button type="button" class="icon_btn search" onclick="page.search();">
                                <i class="ic ic-search"></i>
                                <span class="blind">검색</span>
                            </button>
                            <!-- 상세검색 검색창 ("lay_pop on"일때 보여짐) -->
                            <div class="lay_pop" data-name="search_detail">
                                <button type="button" class="lay_pop_close icon_btn" onclick="page.detailSearch.close();" style="position: absolute;">
                                    <i class="ic ic-close"></i>
                                    <span class="blind">{{ message('item.com.037') }}</span>
                                </button>
                                <!-- 검토분류 -->
                                <div class="form_box ">
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dsgn.007') }}</div>
                                            <div class="form_data">
                                                <span class="selectbox width_css">
                                                    <select name="detail_dsgnCd" id="detail_dsgnCd">
                                                        <!-- <option selected disabled value="">{{ message('item.dsgn.007') }}</option> -->
                                                    </select>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 검토자 -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dsgn.008') }}</div>
                                            <div class="form_data">
                                                <input type="text" name="rgstrNm" id="rgstrNm" class="">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 내 작성 의견 -->
                                    <div class="row">
                                        <div class="col chkbox">
                                            <div class="form_label"></div>
                                            <div class="form_data detailSearch">
                                                <label class="form_check">
                                                    <input class="check_mark" type="checkbox" name="checkbox" id="detail_my_rplyYn" value="Y">
                                                    <span class="check_label">
                                                        {{ message('item.dfccy.021') }}
                                                    </span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 검토ID -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dsgn.009') }}</div>
                                            <div class="form_data">
                                                <div class="item_group">
                                                    <!-- 숫자만 입력 -->
                                                    <input type="text" name="startDsgnNo" id="startDsgnNo" class="number maxlength" maxlength="10">
                                                    ~
                                                    <input type="text" name="endDsgnNo" id="endDsgnNo" class="number maxlength" maxlength="10">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 답변결과 -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dsgn.010') }}</div>
                                            <div class="form_data">
                                                <span class="selectbox width_css">
                                                    <select name="detail_rplyCd" id="detail_rplyCd">
                                                        <option selected value="all">{{ message('btn.038') }}</option>
                                                        <option value="0201">{{ message('item.dfccy.024') }}</option>
                                                        <option value="0202">{{ message('item.dfccy.010') }}</option>
                                                        <option value="0203">{{ message('item.dsgn.003') }}</option>
                                                    </select>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 평가결과 -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dsgn.028') }}</div>
                                            <div class="form_data">
                                                <span class="selectbox width_css">
                                                    <select name="detail_apprerCd" id="detail_apprerCd">
                                                        <option selected value="all">{{ message('btn.038') }}</option>
                                                        <option value="0301">{{ message('item.dfccy.024') }}</option>
                                                        <option value="0302">{{ message('item.dfccy.010') }}</option>
                                                    </select>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 최근입력기간 -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form_label">{{ message('item.dfccy.025') }}</div>
                                            <div class="form_data">
                                                <div class="item_group">
                                                    <!-- 직접선택시 input type="date"를 "text"로 변경 -->
                                                    <input type="date" name="startRgstDt" id="startRgstDt" class="date" data-date-format="DD/MM/YYYY" onchange="page.detailSearch.setMinDate('startRgstDt', 'endRgstDt')">
                                                    ~
                                                    <input type="date" name="endRgstDt" id="endRgstDt" class="date" data-date-format="DD/MM/YYYY">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 문제점 -->
                                    <div class="row">
                                        <div class="col chkbox">
                                            <div class="form_label"></div>
                                            <div class="form_data detailSearch">
                                                <label class="form_check">
                                                    <input class="check_mark" type="checkbox" name="checkbox" id="isuYn" value="Y">
                                                    <span class="check_label">
                                                        {{ message('item.dsgn.011') }}
                                                    </span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 교훈 -->
                                    <div class="row">
                                        <div class="col chkbox">
                                            <div class="form_label"></div>
                                            <div class="form_data detailSearch">
                                                <label class="form_check">
                                                    <input class="check_mark" type="checkbox" name="checkbox" id="lesnYn" value="Y">
                                                    <span class="check_label">
                                                        {{ message('item.dsgn.012') }}
                                                    </span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 첨부파일 -->
                                    <div class="row">
                                        <div class="col chkbox">
                                            <div class="form_label"></div>
                                            <div class="form_data detailSearch">
                                                <label class="form_check">
                                                    <input class="check_mark" type="checkbox" name="checkbox" id="atachYn" value="Y">
                                                    <span class="check_label">
                                                        {{ message('item.dfccy.027') }}
                                                    </span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div class="btn_group _fill s_small jc_e">
                                    <button type="button" class="btn" onclick="page.detailSearch.setSearch()">{{message('btn.014') }}</button>
                                    <button type="button" class="btn" onclick="page.detailSearch.reset();">{{message('btn.024')}}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- // E: search wrap ---------------------------------------------- -->
                    
                    <!-- S: 상세검색에서 선택된 항목 표시 -->
                    <p class="selected_list"></p>
                    <!-- E: 상세검색에서 선택된 항목 표시 -->

                    <div class="toolbar dfccy_btn">
                        <div class="btn_area s_default _outline">
                            {{ btnHtml | raw }}
<!--                            <button type="button" class="btn" onclick="page.deleteAll();">{{message('item.dsgn.030')}}</button>-->

                            <div class="slick_nav" style="top: unset;right: 28px;">
                                <div class="slick_paging">
                                    <!-- <b class="page">1</b> / 2 -->
                                </div>
                                <div class="btn_area slick_indigator" style="margin-top: unset;">
                                    <div class="btn_group _outline">
                                        <button type="button" class="btn icon_btn prev">
                                            <span class="blind">이전</span>
                                        </button>
                                        <button type="button" class="btn icon_btn next">
                                            <span class="blind">다음</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="gridContainer">
                        <div id="grid">
                            <table class="table ta_c">
                                <colgroup>
                                    <col width="100px">
                                    <col width="130px">
                                    <col width="7%">
                                    <col width="10%">
                                    <col>
                                    <col width="7%">
                                    <col>
                                    <col>
                                    <col>
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th rowspan="2">
                                            <label class="form_check" style="display: block;">
                                                <input type="checkbox" id="checkAll" class="check_mark">
                                                <span class="check_label blind">선택</span>
                                            </label>
                                        </th>
                                        <th rowspan="2">ID</th> <!--ID-->
                                        <th rowspan="2">{{message('item.dsgn.008')}}</th> <!--검토자-->
                                        <th rowspan="2">설계등록일</th>
                                        <th rowspan="2">{{message('item.com.060')}}</th> <!--제목-->
                                        <th rowspan="2">{{message('item.dsgn.007')}}</th> <!--검토분류-->
                                        <th colspan="2">{{message('item.dsgn.005')}}</th> <!--평가-->
                                    </tr>
                                    <tr>
                                        <th width="10%">{{message('item.dsgn.031')}}</th> <!--최근입력일자-->
                                        <th width="10%">{{message('item.dsgn.014')}}</th> <!--결과-->
                                    </tr>
                                </thead>
                                <tbody class="ty_list" id="dsgnList">
                                </tbody>
                            </table>
                        </div>
                        <div id="popup">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </article>
</section>
{% endblock content %} {% block footer_script %}

<script>
    const dsgnPhaseCd = "0103";    // 구분: 결함사항
    let urlParams = new URLSearchParams(window.location.search);
    var dsgnPhaseNo = urlParams.get("dsgnPhaseNo") ?? null;
    var searchForm = {};
    var currentPage = 1;
    var itemsPerPage = 10;
    var currentDsgnNo = null;
    let isDelAuth = '{{ isDelAuth }}' === 'true' ? true : true; // 삭제 버튼 권한 적용 필요.

    var isClear = false;

    var page = {
        init() {
            $('#page_contents').show();
            
            currentDsgnNo = null;
            currentPage = 1;
            this.inputForm.close();
            $(".check_mark").prop("checked", false);

            page.resetSelectbox();

            page.detailSearch.reset();
            $('.selected_list').removeClass('on');
            $('.selected_list').children().remove();

            let urlParam = new URLSearchParams(window.location.search);
            let apprerCd = urlParam.get("apprerCd");
            let rgstrNm = urlParam.get("rgstrNm");
            let dsgnCd = urlParam.get("dsgnCd");

            if(apprerCd || rgstrNm || dsgnCd) {
                if (!isClear) {
                    if(apprerCd) $("select[name='detail_apprerCd']").val(apprerCd);
                    if(rgstrNm) $("#rgstrNm").val(rgstrNm);
                    if(dsgnCd) $("select[name='detail_dsgnCd']").val(dsgnCd);
                }

                // history.replaceState(null, null, window.location.pathname);
                page.detailSearch.setSearch();
            } else {
                page.read(currentPage);
            }

            gaia.loaded = true;
        },
        inputForm: {
            toggle(dsgnNo) {
                if (currentDsgnNo === dsgnNo) {
                    this.close(dsgnNo);
                } else {
                    this.open(dsgnNo)
                }
            },
            open(dsgnNo) {
                gaiaCommon.checkAuth("DM_EVAL_CU_01", () => {
                    $('.gridContainer').addClass('active');
                    $(`#tr_${dsgnNo}`).next('.more_info').addClass('open');
                    $("#popup").load(`/design/evaluationForm?pjtNo=${pjtNo}&cntrctNo=${cntrctNo}`);
                    currentDsgnNo = dsgnNo;
                });
            },
            close(dsgnNo) {
                $('.gridContainer').removeClass('active');
                $("#popup").empty();
                currentDsgnNo = null;
                $(`#tr_${dsgnNo}`).removeClass("selected-row");
                $(`#tr_${dsgnNo}`).next(".more_info").removeClass("open");

                // $(".dsgn-row").removeClass("selected-row");
            }
        },
        detailSearch: {
            open(){
                $("[data-name='search_detail']").addClass("on");
                this.reset();
            },
            close(){
                $("[data-name='search_detail']").removeClass("on");
            },
            reset(){
                // `lay_pop` 클래스 하위의 모든 입력 요소 선택
				const layPopElements = document.querySelector(".lay_pop");

                if (layPopElements) {
                    // 모든 input 요소 초기화
                    layPopElements.querySelectorAll("input").forEach(input => {
                        if (input.type === "checkbox" || input.type === "radio") {
                            input.checked = false; // 체크박스 및 라디오 버튼 초기화
                        } else {
                            input.value = ""; // 일반 입력 필드 초기화
                        }
                    });

                    // 모든 select 요소 초기화
                    layPopElements.querySelectorAll("select").forEach(select => {
                        select.selectedIndex = 0; // 첫 번째 옵션으로 설정
                    });

                    // 상세 검색 데이터 초기화
                    Object.keys(searchForm).forEach(key => {
                        searchForm[key] = null;
                    });
                }
            },
            setMinDate(startDtId, endDtId) {
				var startDate = new Date($(`#${startDtId}`).val());
				startDate.setDate(startDate.getDate() + 1);
				var minEndDate = startDate.toISOString().split('T')[0];
				$(`#${endDtId}`).attr('min', minEndDate);
			},
            setSearch(){
                $('.selected_list').addClass('on');
				$('.selected_list').children().remove();

                page.resetSelectbox();

                const dsgnCd = $("select[name='detail_dsgnCd']").val();
				const rgstrNm = $("#rgstrNm").val();
				const myRplyYn = $("input[id='detail_my_rplyYn']:checked").val();
				const startDsgnNo = $('#startDsgnNo').val();
				const endDsgnNo = $('#endDsgnNo').val();
				const rplyCd = $("select[name='detail_rplyCd']").val();
				const apprerCd = $("select[name='detail_apprerCd']").val();
				let startRgstDt = $('#startRgstDt').val();
				let endRgstDt = $('#endRgstDt').val();
                const isuYn = $("input[id='isuYn']:checked").val();
				const lesnYn = $("input[id='lesnYn']:checked").val();
				const atachYn = $("input[id='atachYn']:checked").val();

                searchForm = {
                    dsgnCd: dsgnCd && dsgnCd !== "all" ? dsgnCd : null,
					rgstrNm: rgstrNm ?? null,
					myRplyYn: myRplyYn ?? null,
					startDsgnNo: startDsgnNo || null,
					endDsgnNo: endDsgnNo || null,
					rplyCd: rplyCd && rplyCd !== "all" ? rplyCd : null,
                    apprerCd: apprerCd && apprerCd !== "all" ? apprerCd : null,
					startRgstDt: startRgstDt ?? null,	
                    endRgstDt: endRgstDt ?? null,
                    isuYn: isuYn ? isuYn : null,
                    lesnYn: lesnYn ? lesnYn : null, 		
                    atachYn: atachYn ?? null
                }

                // 검토 분류
				if (dsgnCd && dsgnCd !== "all") {
					$('select[id="dsgnCd"]').val(dsgnCd); // 그리드 결함 구분 값 설정.

					let dsgnCdText = $("#detail_dsgnCd option:selected").text();
					let keywordHtml = `
					<span class="selected_item detailDsCd">
						<span class="item dsCd">${dsgnCdText}</span>
						<input type="hidden" name="detail_dsgnCd" data-name="dsgnCd" value="${dsgnCd}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailDsCd')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
					$('.selected_list').append(keywordHtml);
				}

				// 작성자
				if (rgstrNm) {
					let keywordHtml = `
					<span class="selected_item detailRgstr">
						<span class="item rgstr">${rgstrNm}</span>
						<input type="hidden" name="detail_rgstr" data-name="rgstrNm" value="${rgstrNm}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailRgstr')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
					$('.selected_list').append(keywordHtml);
				}

				// 설계번호 범위
				if (startDsgnNo || endDsgnNo) {
					let combinedValue = `${startDsgnNo} ~ ${endDsgnNo}`;
					let keywordHtml = `
					<span class="selected_item detailDsId">
						<span class="item dsId">${combinedValue}</span>
						<input type="hidden" name="startDsgnNo" data-name="startDsgnNo" value="${startDsgnNo}">
						<input type="hidden" name="endDsgnNo" data-name="endDsgnNo" value="${endDsgnNo}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailDsId')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
					$('.selected_list').append(keywordHtml);
				}

				// 답변 결과
				if (rplyCd) {
					if(rplyCd !== "all"){
						let rplyCdText = $("#detail_rplyCd option:selected").text();
						let keywordHtml = `
						<span class="selected_item detailRply">
							<span class="item rply">${rplyCdText}</span>
							<input type="hidden" name="detail_rplyCd" data-name="rplyCd" value="${rplyCd}">
							<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailRply')">
								<i class="ic ic-close"></i>
								<span class="blind">{{ message('btn.002') }}</span>
							</button>
						</span>
					`;
						$('.selected_list').append(keywordHtml);
					}
				}

                
				// 평가 결과 
				if (apprerCd) {
					if(apprerCd !== "all"){
						let apprerCdText = $("#detail_apprerCd option:selected").text();
						let keywordHtml = `
						<span class="selected_item detailApprerCd">
							<span class="item apprer">${apprerCdText}</span>
							<input type="hidden" name="detail_apprerCd" data-name="apprerCd" value="${apprerCd}">
							<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailApprerCd')">
								<i class="ic ic-close"></i>
								<span class="blind">{{ message('btn.002') }}</span>
							</button>
						</span>
					`;
						$('.selected_list').append(keywordHtml);
					}
				}

				// 날짜 범위
				if (startRgstDt || endRgstDt) {
					let combinedValue = `${startRgstDt} ~ ${endRgstDt}`;
					let keywordHtml = `
					<span class="selected_item detailRgstDt">
						<span class="item rgstDt">${combinedValue}</span>
						<input type="hidden" name="startRgstDt" data-name="startRgstDt" value="${startRgstDt}">
						<input type="hidden" name="endRgstDt" data-name="endRgstDt" value="${endRgstDt}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailRgstDt')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
					$('.selected_list').append(keywordHtml);
				}

				// 첨부 파일
				if (atachYn) {
					let keywordHtml = `
					<span class="selected_item detailAtachYn">
						<span class="item ">{{ message('item.com.062') }} O</span>
						<input type="hidden" name="atachYn" data-name="atachYn" value="${atachYn}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailAtachYn')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
					$('.selected_list').append(keywordHtml);
				}

                
				// 문제점
				if (isuYn) {
					let keywordHtml = `
					<span class="selected_item detailIsuYn">
						<span class="item ">{{ message('item.dsgn.011') }} O</span>
						<input type="hidden" name="detail_isuYn" data-name="isuYn" value="${isuYn}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailIsuYn')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
					$('.selected_list').append(keywordHtml);
				}

				// 교훈
				if (lesnYn) {
					let keywordHtml = `
					<span class="selected_item detailLesnYn">
						<span class="item ">{{ message('item.dsgn.012') }} O</span>
						<input type="hidden" name="detail_lesnYn" data-name="lesnYn" value="${lesnYn}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailLesnYn')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
					$('.selected_list').append(keywordHtml);
				}

				// 내 의견
				if (myRplyYn) {
					let keywordHtml = `
					<span class="selected_item detailMyRplyYn">
						<span class="item ">{{ message('item.dfccy.007') }} O</span>
						<input type="hidden" name="detail_my_rplyYn" data-name="myRplyYn" value="${myRplyYn}">
						<button type="button" class="icon_btn" onclick="page.detailSearch.delete('detailMyRplyYn')">
							<i class="ic ic-close"></i>
							<span class="blind">{{ message('btn.002') }}</span>
						</button>
					</span>
				`;
					$('.selected_list').append(keywordHtml);
				}

				// 선택된 검색 필터가 없으면 selected_list를 비활성화
				if ($('.selected_list').children().length === 0) {
					$('.selected_list').removeClass('on');
				}
				page.detailSearch.close();
                page.inputForm.close();
                page.read(currentPage);
            },
            delete(keyword){
                let selectedItem = $(`.${keyword}`).closest('.selected_item');
			    let hiddenInputs = selectedItem.find('input[type="hidden"]');
                hiddenInputs.each((index, input) => {
                    let key = $(input).attr('data-name');
                    searchForm[key] = null;
                });

                selectedItem.remove();
                isClear = true;

                if ($('.selected_list').children().length === 0) {
                    $('.selected_list').removeClass('on');
                }

                currentPage = 1;
                page.read(currentPage);
            }
        },
        createAttachArea(fileList){
            let listItem = '';
            if (fileList && fileList.length > 0) {
                const imgExts = ['jpeg','jpg','png','webp','gif'];
                fileList.forEach((file, index) => {
                    let ext = file.fileDiskNm.split(".").pop()
                    listItem += `
                        <li class="list_item">
                            <a class="icon_btn" href="${file.fileDiskPath.replace(/\\/g, '/').replace(/^.*\/upload/, '/upload')}/${file.fileDiskNm}"  download="${file.fileNm}">
                                <i class="ic ic-folder-open"></i>
                                <span class="blind">${file.fileNm}</span>
                            </a>
                            <a class="f_name" href="${file.fileDiskPath.replace(/\\/g, '/').replace(/^.*\/upload/, '/upload')}/${file.fileDiskNm}"  download="${file.fileNm}" >${file.fileNm}</a>`
                    if(imgExts.includes(ext)){
                        listItem += `<div class='thumbnail'><a href="javascript:page.openImagePopup('${file.fileDiskPath.replace(/\\/g, '/').replace(/^.*\/upload/, '/upload')}/${file.fileDiskNm}')"><img src="${file.fileDiskPath.replace(/\\/g, '/').replace(/^.*\/upload/, '/upload')}/${file.fileDiskNm}"></a></div>`;
                    }
                    listItem += `</li>`;
                });
            }
            return listItem;
        },
        getDsgnSelectbox(){
            $('#selectbox_dsgn').empty().append(`<option selected disabled value="">{{ message('item.dsgn.007') }}</option>`);
            $('#detail_dsgnCd').empty().append(`<option selected disabled value="">{{ message('item.dsgn.007') }}</option>`);
            gaiaCommon.get("/api/design/dsgnCd/list",{},function (data) {
                let dsgnCdList = data.details.dsgnCdList;
                $.each(dsgnCdList, function (index, obj) {
                    $('#selectbox_dsgn').append(`<option value="${obj.cmnCd}">${obj.cmnCdNmKrn}</option>`);
                    $('#detail_dsgnCd').append(`<option value="${obj.cmnCd}">${obj.cmnCdNmKrn}</option>`);
                })
            },function(error){
                console.error(`설계 검토 툴 평가의 셀렉트박스 생성 실패, /api/design/dsgnCd/list, PARAMS : {}`,error);
            })
        },
        resetSelectbox(){
            $('#search_text').val('');
            $('#selectbox_confirm').val('');
            $('#selectbox_dsgn').val('');
		},
        search(){
            let dsgnCd = $('#selectbox_dsgn').val();
            let apprerStatus = $('#selectbox_confirm').val();
			let keyword = $('#search_text').val();

            searchForm = {}

            searchForm = {
                dsgnCd: dsgnCd,
                apprerStatus: apprerStatus,
                keyword: keyword
            }
            currentPage = 1;
            page.read(currentPage);
        },
        read(curPage, curDsgnNo){
            let params = {
                page: curPage,
                size: itemsPerPage,
                dsgnPhaseNo: dsgnPhaseNo,
                cntrctNo: $("#cntrctNo").val(),
                dsgnPhaseCd: dsgnPhaseCd,
                ...searchForm
            }
            gaiaCommon.post('/api/design/evaluation/list',params,function (data) {
                let list = data.details.dsgnList;
                let totalCount = data.details.totalCount;
                let totalPages = Math.ceil(totalCount / itemsPerPage);

                // 페이지네이션 업데이트
                page.updatePagination(curPage, totalPages);

                if(list && list.length > 0) {
                    $('#dsgnList').empty();

                    list.forEach((dsgnList, index) => {
                        // null이면 빈 문자열로 대체
                        var dsgnNo = dsgnList.dsgn_no ?? "";
                        var rgstrNm = dsgnList.rgstr_nm ?? "";
                        var title = dsgnList.title ?? "";

                        if (dsgnList.isu_yn === 'Y') {
                            title = `<span class="dfccy_priority">${title}</span>`
                        }

                        var dsgnCdNm = dsgnList.dsgn_cd_krn ?? "";
                        var docNo = dsgnList.doc_no ?? "";
                        var dwgNo = dsgnList.dwg_no ?? "";
                        var dwgNm = dsgnList.dwg_nm ?? "";
                        var rvwOpnin = dsgnList.rvw_opnin ?? "";
                        var isuYn = dsgnList.isu_yn ?? "";
                        var lesnYn = dsgnList.lesn_yn ?? "";
                        var rgstDt = dsgnList.rgst_dt ?? "";
                        var backchkCd = dsgnList.backchk_cd ?? "";
                        var apprerRgstDt = dsgnList.apprer_rgst_dt ?? "";
                        var apprerCd = dsgnList.apprer_cd_nm ?? "";
                        var rplyStatus = dsgnList.rply_cd_nm ?? "";
                        var rplyNm = dsgnList.rply_nm ?? "";
                        var rplyCntnts = dsgnList.rply_cntnts ?? "";
                        var rplyDt = dsgnList.rply_dt ?? "";

                        // 결함 첨부파일
                        var dsgnFiles = dsgnList.dsgnFiles;
                        let dsgnFileHtml = page.createAttachArea(dsgnFiles);

                        // 답변 첨부파일
                        var rplyFiles = dsgnList.rplyFiles;
                        let rplyFileHtml = page.createAttachArea(rplyFiles);

                        // 설계도서 설명
                        var rvwDwgDscrpt = dsgnList.rvw_dwg_dscrpt ?? "";
                        var chgDwgDscrpt = dsgnList.chg_dwg_dscrpt ?? "";
                        var rplyDwgDscrpt = dsgnList.rply_dwg_dscrpt ?? "";

                        // 설계도서 파일
                        var rvwDwgFile = dsgnList.rvwDwgFile;
                        let rvwSrc = rvwDwgFile ? rvwDwgFile.fileDiskPath.replace(/\\/g, '/').replace(/^.*\/upload/, '/upload') + "/" + rvwDwgFile.fileDiskNm : "";
                        let rvwHtml = rvwDwgFile ? ` <dd class="item_dd" style="width: 100%;">
                                            <figure class="p_photo_info">
                                                <a href="javascript:void(0);" onclick="page.openImagePopup('${rvwSrc}')">
                                                    <img src="${rvwSrc}" style="min-height:200px;">
                                                </a>
                                                <figcaption>
                                                    <p class="desc">${rvwDwgDscrpt}</p>
                                                </figcaption>
                                            </figure>
                                        </dd>` : `<dd>{{ message('msg.dsgn.001') }}</dd>`;

                        // 변경요청도서
                        var chgDwgFile = dsgnList.chgDwgFile;
                        let chgSrc = chgDwgFile ? chgDwgFile.fileDiskPath.replace(/\\/g, '/').replace(/^.*\/upload/, '/upload') + "/" + chgDwgFile.fileDiskNm : "";
                        let chgHtml = chgDwgFile ? ` <dd class="item_dd" style="width: 100%;">
                                            <figure class="p_photo_info">
                                                <a href="javascript:void(0);" onclick="page.openImagePopup('${chgSrc}')">
                                                    <img src="${chgSrc}" style="min-height:200px;">
                                                </a>
                                                <figcaption>
                                                    <p class="desc">${chgDwgDscrpt}</p>
                                                </figcaption>
                                            </figure>
                                        </dd>` : `<dd>{{ message('msg.dsgn.002') }}</dd>`;

                        // 답변도서
                        var rplyDwgFile = dsgnList.rplyDwgFile;
                        let rplySrc = rplyDwgFile ? rplyDwgFile.fileDiskPath.replace(/\\/g, '/').replace(/^.*\/upload/, '/upload') + "/" + rplyDwgFile.fileDiskNm : "";
                        let rplyHtml = rplyDwgFile ? ` <dd class="item_dd" style="width: 100%;">
                                            <figure class="p_photo_info">
                                                <a href="javascript:void(0);" onclick="page.openImagePopup('${rplySrc}')">
                                                    <img src="${rplySrc}" style="min-height:200px;">
                                                </a>
                                                <figcaption>
                                                    <p class="desc">${rplyDwgDscrpt}</p>
                                                </figcaption>
                                            </figure>
                                        </dd>` : `<dd>{{ message('msg.dsgn.003') }}</dd>`;

                        var dsgnList = `
                            <tr class="dsgn-row" id="tr_${dsgnNo}">
                                <td>
                                    <div class="item_group">
                                        <label class="form_check">
                                            <input class="check_mark" type="checkbox" name="select_check">
                                            <span class="check_label blind">선택</span>
                                        </label>
                                        ${'{{ isDelAuth }}' == 'true' ?'<button type="button" class="icon_btn" onclick="page.delete(this)"><i class="ic ic-delete"></i><span class="blind">삭제</span></button>' : ""}
                                    </div>
                                </td>
                                <td style="padding-right:20px">
                                    <a><span>${dsgnNo}</span></a>
                                    <button type="button" class="icon_btn detail-btn" style="display:none;">
                                        <i class="ic ic-sent-to-back"></i>
                                        <span class="blind">상세정보</span>
                                    </button>
                                </td>
                                <td data-dsgn-no="${dsgnNo}">${rgstrNm}</td>
                                <td data-dsgn-no=${dsgnNo}>${rgstDt}</td>
                                <td data-dsgn-no="${dsgnNo}" style="text-align:left;">${title}</td>
                                <td data-dsgn-no="${dsgnNo}">${dsgnCdNm}</td>
                                <td data-dsgn-no="${dsgnNo}">${apprerRgstDt}</td>
                                <td data-dsgn-no="${dsgnNo}">${apprerCd}</td>
                                <input type="hidden" data-backchk-cd=${backchkCd}></input>
                            </tr>
                            <tr class="more_info">
                                <td colspan="8" class="ta_l" style="position: relative;">
                                    <dl class="more_data">
                                        <button type="button" class="lay_pop_close icon_btn"
                                            style="position: absolute;">
                                            <i class="ic ic-close"></i>
                                            <span class="blind">{{ message('item.com.037') }}</span>
                                        </button>
                                        <dt>{{ message('item.dsgn.015') }}</dt>
                                        <dd>${docNo}</dd>
                                        <dt>{{ message('item.dsgn.016') }}</dt>
                                        <dd>${dwgNo}</dd>
                                        <dt>{{ message('item.dsgn.017') }}</dt>
                                        <dd>${dwgNm}</dd>
                                        <dt>{{ message('item.dsgn.018') }}</dt>
                                        <dd class="dsgn_wrap">${rvwOpnin}</dd>
                                        <dt>{{ message('item.dsgn.011') }}</dt>
                                        <dd>${isuYn === 'Y' ? 'YES' : 'NO'}</dd>
                                        <dt>{{ message('item.dsgn.012') }}</dt>
                                        <dd>${lesnYn === 'Y' ? 'YES' : 'NO'}</dd>
                                        <dt>{{ message('item.com.062') }}</dt>
                                        <dd>
                                            <div class="attach_area detail">
                                                <p class="data_info ${dsgnFileHtml != ''? 'hide' : ''}">
                                                    {{message('msg.029')}} </p>
                                                <div class="attach_list ${dsgnFileHtml != ''? '' : 'hide'}" style="width: 100%;">
                                                    <ul class="file_header">
                                                        <li class="header_item">
                                                            <div class="icon_btn">
                                                                <i class="ic ic-folder-open" id="fileIcon"></i>
                                                                <span class="blind">{{message('item.com.020')}}</span>
                                                            </div>
                                                            <span class="f_name">{{message('item.com.020')}}</span>
                                                        </li>
                                                    </ul>
                                                    <ul class="file_list">
                                                        ${dsgnFileHtml}
                                                    </ul>
                                                </div>
                                            </div>
                                        </dd>
                                        <dt>{{message('item.dsgn.021')}}</dt>
                                        <dd>
                                            <button type="button" class="icon_btn toggle-btn" style="padding: 0 0 .35em 0;" onclick="page.toggleView(this)">[ {{message('item.dsgn.034')}} ]</button>
                                            <div class="toggle-content" style="display:none;">
                                                <dl class="dl_box p_photo" style="width: 100%; min-height:auto;">
                                                    <dt class="item_dt" style="width: 100%;">
                                                        <label class="form_check"><span class="check_label">{{message('item.dsgn.019')}}</span></label>
                                                    </dt>
                                                    ${rvwHtml}
                                                </dl>
                                                <dl class="dl_box p_photo" style="width: 100%; min-height:auto;">
                                                    <dt class="item_dt" style="width: 100%;">
                                                        <label class="form_check"><span class="check_label">{{message('item.dsgn.020')}}</span></label>
                                                    </dt>
                                                    ${chgHtml}
                                                </dl>
                                            </div>
                                        </dd>
                                        <h2>{{message('item.dfccy.008')}}</h2>
                                        <hr />
                                    </dl>
                                    <dl class="more_data">
                                        <div>
                                            <span class="name_color">${rplyNm}</span>
                                            <span>${rplyDt}</span>
                                        </div>
                                    </dl>
                                    <dl class="more_data">
                                        <dt>{{message('item.dfccy.039')}}</dt>
                                        <dd>${rplyStatus}</dd>
                                        <dt>{{message('item.dfccy.040')}}</dt>
                                        <dd class="dsgn_wrap">${rplyCntnts}</dd>
                                        <dt>{{ message('item.com.062') }}</dt>
                                        <dd>
                                            <div class="attach_area detail">
                                                <p class="data_info ${rplyFiles != ''? 'hide' : ''}">
                                                    {{message('msg.029')}} </p>
                                                <div class="attach_list ${rplyFiles != ''? '' : 'hide'}" style="width: 100%;">
                                                    <ul class="file_header">
                                                        <li class="header_item">
                                                            <div class="icon_btn">
                                                                <i class="ic ic-folder-open" id="fileIcon"></i>
                                                                <span class="blind">{{message('item.com.020')}}</span>
                                                            </div>
                                                            <span class="f_name">{{message('item.com.020')}}</span>
                                                        </li>
                                                    </ul>
                                                    <ul class="file_list">
                                                        ${rplyFileHtml}
                                                    </ul>
                                                </div>
                                            </div>
                                        </dd>
                                        <dt>{{message('item.dsgn.033')}}</dt>
                                        <dd>
                                            <button type="button" class="icon_btn toggle-btn" style="padding: 0 0 .35em 0;" onclick="page.toggleView(this)">[ {{message('item.dsgn.034')}} ]</button>
                                            <div class="toggle-content" style="display:none;">
                                                <dl class="dl_box p_photo" style="width: 50%; min-height:auto;">
                                                    <dt class="item_dt" style="width: 100%;">
                                                        <label class="form_check"><span class="check_label">{{message('item.dsgn.021')}}</span></label>
                                                    </dt>
                                                    ${rplyHtml}
                                                </dl>
                                            </div>
                                        </dd>
                                    </dl>
                                </td>
                            </tr>
                            `;
                        $("#dsgnList").append(dsgnList);
                    });

                    if(curDsgnNo) {
                        currentDsgnNo = curDsgnNo;
                        $(`#tr_${currentDsgnNo}`).addClass('selected-row');
                    }
                } else {
                    $("#dsgnList").children().empty();
                    $("#dsgnList").append(`<tr>
                                                <td colspan="8">
                                                    <div style="display: inline-block;">
                                                        <p class="data_info">
                                                            {{message('msg.091')}}
                                                        </p>
                                                    </div>
                                                </td>
                                            </tr>`);
                }
            },function(error){
                gaiaCommon.customAlert("{{message('msg.060')}}");
                console.error(`설계 검토 툴 평가의 목록 불러오기 실패, /api/design/evaluation/list, PARAMS : ${params}`,error);
            })
        },
        deleteAll(){
            let delEvaList = [];
            let goDelete = true;
            $('input:checkbox[name=select_check]:checked').each(function(){
                const dsgnNo = $(this).closest('tr').find("[data-dsgn-no]").data("dsgn-no");
                let backchkCd = $(this).closest('tr').find("[data-backchk-cd]").data("backchk-cd");

                // 등록기간이 종료됐거나 종결처리 됐으면 삭제불가
                if (backchkCd === '0402') {
                    gaiaCommon.customAlert("{{message('msg.dfccy.010')}}");
                    goDelete = false;
                    return
                }

                if(isEnd) {
                    gaiaCommon.customAlert("{{message('msg.dfccy.011')}}");
                    goDelete = false;
                    return 
                } 
                
                delEvaList.push({dsgnNo: dsgnNo});
            })

            if(!goDelete) {
                return
            }

            let data = {
                delEvaList: delEvaList
            }

            gaiaCommon.customConfirm("{{message('item.dfccy.052')}}", "{{message('msg.dfccy.012')}}", "{{message('msg.dfccy.013')}}", function(){
                gaiaCommon.post('/api/design/evaluation/delete-list',data,function(result) {
                    gaiaCommon.customAlert("{{message('msg.006')}}", function(){
                        page.init();
                    });
                },function(error){
                    console.error(`설계 검토 툴 평가의 여러개 삭제 실패, /api/design/evaluation/delete-list, PARAMS : ${data}`,error);
                    gaiaCommon.customAlert("{{message('msg.monthlyreport.003')}}");
                })
            });
        },
        delete(btn){
            $(btn).closest('tr').find('input:checkbox[name=select_check]').prop('checked', true);
            page.deleteAll();
        },
        convert(string){
            switch(string) {
                case 'ing': return "{{message('item.com.041')}}"; 
                case 'end': return "{{message('item.dfccy.004')}}"; 
                case 'ok': return "{{message('btn.010')}}";
            }
        },
        updatePagination(currentPage, totalPages) {
            // 페이지 번호 업데이트
            $('.slick_paging').empty();
            if(totalPages > 0) {
                $(".slick_paging").append(`<b class="page">${currentPage}</b> / ${totalPages}`);
            }

            // "이전" 버튼 비활성화 여부
            if (currentPage === 1) {
                $('.btn.prev').prop('disabled', true);
            } else {
                $('.btn.prev').prop('disabled', false);
            }

            // "다음" 버튼 비활성화 여부
            if (currentPage === totalPages || totalPages === 0) {
                $('.btn.next').prop('disabled', true);
            } else {
                $('.btn.next').prop('disabled', false);
            }
        },
        toggleView: function (button) {
            let $button = $(button);
            let content = $button.next();

            if (content.is(":hidden")) {
                content.css("display", "flex");
                $button.text("[ {{message('btn.007')}} ]");
            } else {
                content.hide();
                $button.text("[ {{message('item.dsgn.034')}} ]");
            }
        },

        openImagePopup(imageSrc) {
            var img = new Image();
            img.src = imageSrc;
            img.onload = function () {
                var width = img.width;
                var height = img.height;
                window.open(imageSrc, 'popup', `width=${width},height=${height},scrollbars=yes`);
            };
        }
    }

    // 전체선택
    $('#checkAll').on("change", function () {
		const isChecked = $(this).prop("checked");
		$(".gridContainer .check_mark").prop("checked", isChecked);
	});

    // "이전" 버튼 클릭 이벤트
    $('.btn.prev').on('click', function () {
        if (currentPage > 1) {
            currentPage--;
            page.read(currentPage);
        }
    });

    // "다음" 버튼 클릭 이벤트
    $('.btn.next').on('click', function () {
        currentPage++;
        page.read(currentPage);
    });

    // 상세정보 버튼 클릭 이벤트
    $(document).on('click', '.detail-btn', function () {
        $(this).closest('tr').next('.more_info').toggleClass('open');
        event.stopPropagation();
    });

    // 닫기 버튼 클릭 이벤트
    $(document).on('click', '.lay_pop_close', function () {
        $(this).closest('.more_info').removeClass('open');
    });

    // 입력창 생성 이벤트
    $(document).on("click", "[data-dsgn-no]", function () {
        var dsgnNo = $(this).data("dsgn-no");
        $(".more_info").removeClass("open");
        $(".dsgn-row").removeClass("selected-row");
        $(this).closest(".dsgn-row").addClass("selected-row");
        page.inputForm.toggle(dsgnNo);
    });

    $(document).on("mouseenter", ".dsgn-row", function () {
        $(this).find(".act-btn").show();
        $(this).find(".detail-btn").show();
    });
    $(document).on("mouseleave", ".dsgn-row", function () {
        $(this).find(".act-btn").hide();
        $(this).find(".detail-btn").hide();
    });

    $(function(){
        gaia.create({
            $init: function ($params) {

                gaiaPortal.navMenuInit("M080104", "{{message('item.dsgn.032')}}");
                select.init();
                page.getDsgnSelectbox();
            }
        });
    })
</script>
{% endblock footer_script %}
<!-- 속성 추가 팝업 -->
<div class="modal" id="registPropertyForm">	
    <div class="pop_box _sm">
        <div class="pop_header">
            <h5 class="pop_tit" id="property_cu_tit">{{ message('item.doc.027') }}</h5> <!--속성추가-->
            <div class="btn_area">
                <button type="button" class="icon_btn pop_close" onclick="modal.close()">
                    <i class="ic ic-close"></i>
                    <span class="blind">{{ message('item.com.037') }}</span>
                </button>
            </div>
        </div>
        <div class="pop_body">
			<div class="form_box">
				
				<div class="row">
					<div class="col">
						<div class="form_label required" id="attrbtCd_req">{{ message('item.doc.021') }}</div> <!--속성코드-->
						<div class="form_data">
							<div class="item_group">								
								<!-- <input type="text" id="attrbtCd" class="" maxlength="20" onblur="modal.checkDuplicated()" onfocus="modal.onFocus(this)"> -->
								<input type="text" id="attrbtCd" class="" maxlength="20">
								<button type="button" class="btn _fill s_small" onclick="modal.checkDuplicated()">{{ message('btn.028') }}</button>
							</div>
							<span style="display: inline-block; width: 99%; text-align: right; padding-top: 5px;"><span>{{ message('msg.doc.001') }} [ <font color="red">\ / : * ? " < > . |</font> ]</span></span>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<div class="form_label required">{{ message('item.doc.022') }}</div> <!--이름(한)-->
						<div class="form_data">
							<input type="text" class="" id="attrbtNmKrn" name="attrbtNmKrn" required maxlength="50">
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<div class="form_label">{{ message('item.doc.023') }}</div> <!--이름(영)-->
						<div class="form_data">
							<input type="text" class="" id="attrbtNmEng" name="attrbtNmEng" maxlength="50">
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<div class="form_label required">{{ message('item.doc.024') }}</div>  <!--타입-->
						<div class="form_data select_area">
							<div id="attrbtType_form">
								<span class="selectbox" style="z-index: 1;">
									<select id="attrbtType" onchange="modal.changeAttrbtType(event)">
									</select>
								</span>
							</div>
							<div id="attrbtTypeSel_form" style="display: none;">
								<span class="selectbox" style="z-index: 1;">
									<select id="attrbtTypeSel">
										<!-- <option selected disabled value="">선택</option>
										<option value="08798bce-ecc0-48c7-97f7-d11fcb206fb6">결재 상태</option>
										<option value="f2ddc3aa-bba7-4021-a68c-f73b9b16321e">결재 문서 상태</option>
										<option value="0e7c65be-60ee-4362-8c1b-b18eff238bd2">결재 구분</option> -->
									</select>
								</span>
							</div>
						</div>
					</div>
				</div>
                <div class="row">
                    <div class="col">
                        <div class="form_label required">{{ message('item.doc.025') }}</div> <!--표시여부-->
                        <div class="form_data">
                            <div class="item_group" role="group" aria-label="Basic radio group">
                                <label class="form_check">
                                    <input class="check_mark" type="radio" id="dsplyY" name="attrbtDsplyYn" value="Y" checked>
                                    <span class="check_label">{{ message('btn.008') }}</span>
                                </label>
                                <label class="form_check">
                                    <input class="check_mark" type="radio" id="dsplyN" name="attrbtDsplyYn" value="N">
                                    <span class="check_label">{{ message('btn.009') }}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
				<div class="row">
					<div class="col">
						<div class="form_label">{{ message('item.com.082') }}</div> <!--순서-->
						<div class="form_data">
							<input type="text" id="attrbtDsplyOrder" class="number" name="attrbtDsplyOrder" required  max="32767">
						</div>
					</div>
				</div>
				<input type="hidden" id="attrbtNo">
            </div>			
		</div>
		<div class="pop_footer">
			<div class="btn_area jc_e">
				<button type="button" class="btn _outline" onclick="modal.close()">{{ message('btn.007') }}</button>
				<button type="button" class="btn _fill" onclick="modal.finish()">{{ message('btn.006') }}</button>
			</div>
		</div>
	</div>
</div>
<!-- 속성 수정 팝업 -->
<div class="modal" id="modifyPropertyForm">	
    <div class="pop_box _sm">
        <div class="pop_header">
            <h5 class="pop_tit" id="doc_property_u_tit">{{ message('item.doc.034') }}</h5> <!-- 속성 정보 수정 -->
            <div class="btn_area">
                <button type="button" class="icon_btn pop_close" onclick="modal.close()">
                    <i class="ic ic-close"></i>
                    <span class="blind">{{ message('item.com.037') }}</span>
                </button>
            </div>
        </div>
        <div class="pop_body">
			<div class="form_box">
				
				<div class="row">
					<div class="col">
						<div class="form_label required" id="attrbtCd_req">{{ message('item.doc.021') }}</div> <!--속성코드-->
						<div class="form_data">
							<div class="item_group">								
								<!-- <input type="text" id="attrbtCd" class="" maxlength="20" onblur="modal.checkDuplicated()" onfocus="modal.onFocus(this)"> -->
								<input type="text" id="attrbtCd" class="" maxlength="20">
								<button type="button" class="btn _fill s_small" onclick="modal.checkDuplicated()">{{ message('btn.028') }}</button>
							</div>
							<span style="display: inline-block; width: 99%; text-align: right; padding-top: 5px;"><span>{{ message('msg.doc.001') }} [ <font color="red">\ / : * ? " < > . |</font> ]</span></span>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<div class="form_label required">{{ message('item.doc.022') }}</div> <!--이름(한)-->
						<div class="form_data">
							<input type="text" class="" id="attrbtNmKrn" name="attrbtNmKrn" required maxlength="50">
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<div class="form_label">{{ message('item.doc.023') }}</div> <!--이름(영)-->
						<div class="form_data">
							<input type="text" class="" id="attrbtNmEng" name="attrbtNmEng" maxlength="50">
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<div class="form_label required">{{ message('item.doc.024') }}</div>  <!--타입-->
						<div class="form_data select_area">
							<div id="attrbtType_form">
								<span class="selectbox" style="z-index: 1;">
									<select id="attrbtType" onchange="modal.changeAttrbtType(event)">
									</select>
								</span>
							</div>
							<div id="attrbtTypeSel_form" style="display: none;">
								<span class="selectbox" style="z-index: 1;">
									<select id="attrbtTypeSel">
										<!-- <option selected disabled value="">선택</option>
										<option value="08798bce-ecc0-48c7-97f7-d11fcb206fb6">결재 상태</option>
										<option value="f2ddc3aa-bba7-4021-a68c-f73b9b16321e">결재 문서 상태</option>
										<option value="0e7c65be-60ee-4362-8c1b-b18eff238bd2">결재 구분</option> -->
									</select>
								</span>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<div class="form_label">{{ message('item.com.082') }}</div> <!--순서-->
						<div class="form_data">
							<input type="text" id="attrbtDsplyOrder" class="number" name="attrbtDsplyOrder" required  max="32767">
						</div>
					</div>
				</div>
				<input type="hidden" id="attrbtNo">
            </div>			
		</div>
		<div class="pop_footer">
			<div class="btn_area jc_e">
				<button type="button" class="btn _outline" onclick="modal.close()">{{ message('btn.007') }}</button>
				<button type="button" class="btn _fill" onclick="modal.finish()">{{ message('btn.006') }}</button>
			</div>
		</div>
	</div>
</div>
<script>
	const modal = {
		cbgnNo:'',
		mode:'',
		attrbtTypeList:[],
		attrbtTypeSelOptions:[],
		attrbtHtmlOptions:[],
		//init 함수를 통해 필드 생성 및 팝업창 열기
		init:function(data,finishMethod){
			this.mode = data.mode == "modify"?"modify":"regist";
			$(`#${modal.mode}PropertyForm`).addClass("open");
			this.checkedValue={
				cbgnNo:data.cbgnNo,
				attrbtCd:'',
				attrbtCdType:'',
				attrbtType:"",
				attrbtTypeSel:"",
				attrbtNmKrn:'',
				attrbtNmEng:'',
                attrbtDsplyYn:'',
				attrbtDsplyOrder:''
			}
			this.cbgnNo = data.cbgnNo;
			this.finishMethod=finishMethod;

			gaiaCommon.get("/api/system/document/property/code-combo-list", {}, function (result) {
				if(result.details){
					modal.attrbtTypeList = result.details.codeComboMap.attrbtType

					modal.attrbtTypeSelOptions = result.details.codeComboMap.attrbtTypeSel.map(item => ({
						value: item.cmn_grp_cd,
						text: item.cmn_cd_nm
					}));

					modal.attrbtHtmlOptions = result.details.attrbtHtmlOptions.map(item => ({
						value: item.formNo,
						text: item.formNm
					}));
					const attrbtTypeSelect = $(`#${modal.mode}PropertyForm #attrbtType`);

					attrbtTypeSelect.empty().append('<option selected disabled value="">{{ message("item.com.005") }}</option>');
					modal.attrbtTypeList.forEach(option => {
						attrbtTypeSelect.append(`<option value="${option.cmn_cd}">${option.cmn_cd_nm}</option>`);
					});
					if(modal.mode == "modify"){
						modal.checkedValue = data.attrbtNo;
                        gaiaCommon.get(`/api/system/document/property/${data.attrbtNo}`, {}, function (result) {
                            const property = result.details.property;
                            modal.checkedValue = {
                                attrbtNo:property.attrbtNo,
                                cbgnNo:data.cbgnNo,
                                attrbtCd:property.attrbtCd,
                                attrbtType:property.attrbtType,
                                attrbtTypeSel:property.attrbtTypeSel,
                                attrbtNmEng:property.attrbtNmEng,
                                attrbtNmKrn:property.attrbtNmKrn,
                                attrbtDsplyYn:property.attrbtDsplyYn,
                                attrbtDsplyOrder:property.attrbtDsplyOrder,
                            }
                            console.log(modal.checkedValue, property);
                            $(`#${modal.mode}PropertyForm #attrbtCd`).val(property.attrbtCd)
                            $(`#${modal.mode}PropertyForm #attrbtNmEng`).val(property.attrbtNmEng)
                            $(`#${modal.mode}PropertyForm #attrbtNmKrn`).val(property.attrbtNmKrn)
                            $(`#${modal.mode}PropertyForm #attrbtDsplyOrder`).val(property.attrbtDsplyOrder)

                            $(`#${modal.mode}PropertyForm #attrbtType [value=${property.attrbtType}]`).prop('selected',true).trigger('change');
                            $(`#${modal.mode}PropertyForm #attrbtTypeSel`).val(property.attrbtTypeSel).trigger('change');

                            $(`#${modal.mode}PropertyForm [name='attrbtDsplyYn'][value=${property.attrbtDsplyYn}]`).prop('checked',true).trigger('change');
                        },function(error){
                            console.log(`[Modal] 착공계 관리 속성 수정 초기 데이터 세팅 실패, /api/system/document/property/${data.attrbtNo}, PARAMS : {}`,error);
                        })
					}
				};
			},function(error){
				console.log(`속성 타입 드롭다운 리스트 조회 실패, /api/document/name/update, PARAMS : ${this.checkedValue}`,error);
			});

			
		},
		close:function(){
			this.checkedValue={
				cbgnNo:'',
				attrbtCd:'',
				attrbtCdType:'',
				attrbtType:"",
				attrbtTypeSel:"",
				attrbtNmKrn:'',
				attrbtNmEng:'',
                attrbtDsplyYn:'',
				attrbtDsplyOrder:''
			}
			$(`#${modal.mode}PropertyForm .form_box input[type=text]`).val("");
            $(`#${modal.mode}PropertyForm [name='attrbtDsplyYn'][value='Y']`).prop("checked",true).trigger('change');
			$(`#${modal.mode}PropertyForm`).removeClass('open');

			this.finishMethod();
		},
		finish:function(){
			//양식 이름 유효성 검사
			const addRegex = /^(?!\s)[^\/:*?"<>.|]+$/;
			const attrbtCd = $(`#${modal.mode}PropertyForm #attrbtCd`);
			if(attrbtCd.val() == ""){
                gaiaCommon.customAlert('속성 코드를 입력하세요.');
				attrbtCd.focus();
				return;
			}
			if(this.checkedValue.attrbtCd == ""){
                gaiaCommon.customAlert("중복 체크를 해주세요.")
				return;
			}
			if(!addRegex.test(attrbtCd.val())){
                gaiaCommon.customAlert('속성 코드에 사용할 수 없는 문자가 포함되어 있습니다.');
				attrbtCd.focus();
				return;
			}
			if(this.checkedValue.attrbtCd != attrbtCd.val()){
                gaiaCommon.customAlert('중복 체크를 다시 해주세요.')
				return;
			}

			const attrbtNmKrn = $(`#${modal.mode}PropertyForm #attrbtNmKrn`);
			if(attrbtNmKrn.val() == ""){
                gaiaCommon.customAlert('한글 속성 이름을 입력하세요.')
				attrbtNmKrn.focus();
				return;
			}
			this.checkedValue.attrbtNmKrn = attrbtNmKrn.val();

			const selectedValue1 = $(`#${modal.mode}PropertyForm #attrbtType`).val();
			if(selectedValue1 == null){
                gaiaCommon.customAlert('속성 타입을 선택하세요.')
				return;
			}
			this.checkedValue.attrbtType = selectedValue1;
			const selectedValue2 = $(`#${modal.mode}PropertyForm #attrbtTypeSel`).val();
			if(selectedValue1 == "SEL" || selectedValue1 == "HTML"){
				if(selectedValue2 == null){
                    gaiaCommon.customAlert('세부 속성 타입을 선택하세요.')
					return;
				}
			}
			this.checkedValue.attrbtTypeSel = selectedValue2;
			this.checkedValue.attrbtNmEng = $(`#${modal.mode}PropertyForm #attrbtNmEng`).val();
            this.checkedValue.attrbtDsplyYn = $(`#${modal.mode}PropertyForm [name='attrbtDsplyYn']:checked`).val();
			this.checkedValue.attrbtDsplyOrder = $(`#${modal.mode}PropertyForm #attrbtDsplyOrder`).val();

			console.log(this.checkedValue);

			gaiaCommon.post(`/api/system/document/property/${modal.mode}`,modal.checkedValue,function(result){
				console.log(result)
				gaiaCommon.customAlert(`속성 ${modal.mode=="regist"?"등록":"수정"}이 완료되었습니다.`)
				modal.close();
			},function(error){
				console.log(`[Modal] 속성 ${modal.mode=="regist"?"등록":"수정"} 실패, /api/system/document/property/${modal.mode}, PARAMS : ${modal.checkedValue}`,error);
			});
		},
		checkDuplicated:function(){
			const attrbtCd = document.querySelector(`#${modal.mode}PropertyForm #attrbtCd`);
			if(attrbtCd.value == ""){
				gaiaCommon.customAlert('속성 코드를 입력하세요.')
				attrbtCd.focus();
				return;
			}
            gaiaCommon.get(`/api/system/document/property/check-duplicated?attrbtCd=${attrbtCd.value}&cbgnNo=${this.cbgnNo}`,{},function(result){
                if(result.ok){
                    modal.checkedValue.attrbtCd = attrbtCd.value;
                    // attrbtCd.className = 'validated';
                    gaiaCommon.customAlert("중복된 코드가 없습니다.")
                    $(`#${modal.mode}PropertyForm #attrbtNmKrn`).focus();
                }
                else{
                    gaiaCommon.customAlert("중복된 코드가 있습니다.")
                    attrbtCd.focus();
                    // attrbtCd.className = "no-validated";
                }
            },function(error){
                console.log(`[Modal] 속성 코드 중복 체크 실패, /api/system/document/property/check-duplicated?attrbtCd=${attrbtCd.value}&cbgnNo=${this.cbgnNo}, PARAMS :`,'{}',error);
            })
		},
		// onFocus:function(target){
		// 	setTimeout(()=>{
		// 		target.className = "";
		// 		modal.checkedValue[target.id] = '';
		// 	},400)
		// }
		changeAttrbtType:function(e){
			const attrbtTypeSel = $(`#${modal.mode}PropertyForm #attrbtTypeSel`);
			const attrbtTypeSelForm = $(`#${modal.mode}PropertyForm #attrbtTypeSel_form`);
			if(e.target.value == "SEL" || e.target.value == "HTML"){
				attrbtTypeSel.prop("disabled", false); // 활성화
				attrbtTypeSelForm.show();
				
				//속성 타입이 SEL(콤보박스) 일 때,
				if(e.target.value === "SEL"){
					attrbtTypeSel.empty().append('<option selected disabled value="">{{ message("item.com.005") }}</option>');
					
					modal.attrbtTypeSelOptions.forEach(option => {
						attrbtTypeSel.append(`<option value="${option.value}">${option.text}</option>`);
					});
				}
				// 속성 타입이 HTML 일 때,
				else if(e.target.value === "HTML"){
					attrbtTypeSel.empty().append('<option selected disabled value="">{{ message("item.com.005") }}</option>');

					modal.attrbtHtmlOptions.forEach(option => {
						attrbtTypeSel.append(`<option value="${option.value}">${option.text}</option>`);
					});
				}
			}
			else{
				attrbtTypeSel.prop("disabled", true); // 활성화
				attrbtTypeSelForm.hide();
			}
		}
	}
</script>

<!DOCTYPE html>
<html lang="ko">
<head>
	{% include "sub/head" %}
    <style>
		/* 트리뷰 영역 */
		.treeview_area {
		border: 1px solid #e0e0e0;
		border-radius: 4px;
		padding: 8px;
		max-height: 60vh;
		overflow-y: auto;
		}
		/* 버튼 최소 너비 */
		.btn {
		min-width: 80px;
		padding: 6px 12px;
		}
    </style>
</head>
<body>
    <div class="page_wrap">
        <section class="contents_wrap g-row">
            <article class="conts g-row">
                <div class="group" style="width: 24%;">
                    <h3 class="conts_tit">{{ message('item.resources.012') }}</h3>      <!-- 사용자 목록-->           
					<div class="searchbox_wrap" style="width: 100%;">
						<input type="text" name = "treeKeyword" placeholder="{{ message('msg.004') }}">
						<button type="submit" class="icon_btn search" onclick="tree.search()">
							<i class="ic ic-search"></i>
							<span class="blind">{{ message('item.com.014') }}</span>
						</button>
						<button type="button" class="btn _outline" id="close-popup" onclick="tree.select()">선택</button>  
						<button type="button" class="btn _outline" id="close-popup" onclick="window.close()">{{ message('btn.007') }}</button>   
					</div>        
					<div class="treeview_area">
						<div class="treeview ty_pd0" id="jstree"></div>
					</div>
                </div>
            </article>
        </section>
    </div>
	{% include "sub/pop_box" %}
</body>
<script src="/webjars/jstree/jstree.min.js"></script>
<script src="/assets/js/tree.js"></script>
<script>
	let menuType;
	let menuCd;
	let menuNm;

	var tree = {
		obj: null,

		search() {
			const keyword = $('input[name="treeKeyword"]').val();
			$("#jstree").jstree("search", keyword);  
		},

		init() {
			var url = "/api/util/gat-menuList";

			this.obj = $("#jstree").jstree({
				plugins: ["search"],
				search: {
					"show_only_matches" : true,
					"show_only_matches_children" : true,
				},
				core: {
					data(obj, cb) {
					gaiaCommon.get(url, {}, function (result) {
						var data = [];
						if (result.details?.menuAllList) {
							result.details?.menuAllList.forEach((item, index) => {
								data.push({ 
									id: item.menu_cd, 
									parent: item.up_menu_cd, 
									text: item.menu_nm, 
									state: { opened: false }, 
									data: item
								});
							});
							cb.call(obj, data);
						}
					});
					},
					check_callback: true, // 요거이 없으면, create_node 안먹음
					themes : {
						"theme" : "default",
						"dots": false,
						"responsive": false,
						"icons" : false
					}
				},
			});

			this.obj.on("ready.jstree", function(e, data){
				tree.openFirstChild('#', data); // 루트 노드에서 시작하여 첫 번째 자식만 열기

				// if (menuCd) {
				// 	tree.selectNode(menuCd); // 트리가 준비된 후 menuCd를 기준으로 노드 선택
				// }
			});

			this.obj.on("select_node.jstree", function (e, data) {
				console.log(data.node.data);
				menuType = data.node.data.lk_yn;
				menuCd = data.node.data.menu_cd;
				menuNm = data.node.data.menu_nm;
			});

		},

		//첫번째 노드만 열린 상태로 하는 함수
		openFirstChild(nodeId, data){
			var node = data.instance.get_node(nodeId);
					
			if (node.children.length > 0) {
				data.instance.open_node(node.children[0]); // 첫 번째 자식 노드만 열기
			}
		},
		//메뉴 선택 함수
		select(){
			if(!menuCd || menuCd === "M") {
				gaiaCommon.customConfirm("{{ message('item.resources.013') }}", "{{ message('msg.112') }} ", "{{ message('msg.101') }}", function () {
					 opener.document.getElementById('menuCd').value = '';
					 opener.document.getElementById('menuNm').value = '';
					 window.close();
				});				
			}else if(menuType === "N"){
				gaiaCommon.customAlert("{{ message('msg.mauth.003') }}");
			}else {
				gaiaCommon.customConfirm("{{ message('item.resources.013') }}", "{{ message('msg.100') }} ".replace('{명}', menuNm), "{{ message('msg.101') }}", function () {
					 opener.document.getElementById('menuCd').value = menuCd;
					 opener.document.getElementById('menuNm').value = menuNm;
					 window.close();
				});
			}
		}
	};

	$(document).ready(function () {
		gaia.create({
            $init: function ($params) {
				tree.init();
            }
        });
	});

</script>
</html>
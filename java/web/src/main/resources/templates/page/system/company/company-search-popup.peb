<style>
    .selectbox:not(.readonly)::after {
        z-index: 1 !important;
    }

    #company-grid .tui-grid-cell-current-row {
        background-color: var(--select-list-bg);
    }

    .search_wrap{
        align-items: center;
        gap:0.5rem;
    }

    .platform-checkbox-area{
        display: flex;
    }
</style>
<div class="modal open">
    <div class="pop_box _lg">
        <div class="pop_header">
            <h5 class="pop_tit" id="code_cu_tit">{{ message('item.psearch.001') }}</h5>
            <button type="button" class="icon_btn pop_close" name="btnPopupClose">
                <i class="ic ic-close"></i>
                <span class="blind">{{ message('item.com.038') }}</span>
            </button>
        </div>
        <div class="pop_body">
            <div class="group">
                <div class="conts_grid">
                    <!-- S: search wrap ---------------------------------------------- -->
                    <div class="toolbar">
                        <div class="search_wrap">
                            <div class="search_label">구분</div>
                            <div class="platform-checkbox-area">
                                <label class="form_check">
                                    <input class="check_mark" type="radio" id="platform_pces" name="platform" value="PCES" checked>
                                    <span class="check_label">PCES</span>
                                </label>
                                <label class="form_check">
                                    <input class="check_mark" type="radio" id="platform_idea" name="platform" value="IDEA">
                                    <span class="check_label">IDEA PLATFORM</span>
                                </label>
                            </div>

                            <!-- searchbox -->
                            <div class="searchbox_wrap">
                                <input type="text" id="keyword" placeholder="{{ message('item.comp.003') }}"
                                       onkeypress="if( event.keyCode == 13 ){grid.search();}"> <!-- 회사명 -->
                                <button type="submit" class="icon_btn search" onclick="grid.search()">
                                    <i class="ic ic-search"></i>
                                    <span class="blind">{{ message('btn.014') }}</span>
                                </button>
                            </div>
                        </div>

                        <div class="selectbox sort">
                            <select name="items-per-page" id="items-per-page" onchange="grid.changePerPage()">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid" id="company-grid">
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" id="codeCheck" value="true">
        <div class="pop_footer">
            <div class="btn_area jc_e">
                <button type="button" class="btn _outline" name="btnPopupClose">{{ message('btn.007') }}</button>
                <!-- 닫기 -->
                <button type="button" class="btn _fill" id="btnSelected">
                    {{ message('btn.056') }}
                </button> <!-- 추가 -->
            </div>
        </div>
    </div>
</div>
<script>
    //회사 목록 그리드
    var grid = {
        init: function () {
            this.makeCompanyGrid();
        },

        makeCompanyGrid: function (keyword) {
            const Grid = tui.Grid;
            let _this = this;

            if (this.companyGrid) {
                this.companyGrid.destroy();
                this.companyGrid = null;
            }

            const dataSource = createDataSource({
                readData: {
                    url: `/api/system/company/search`, // 데이터를 요청할 API URL
                    method: 'GET',
                    initParams: {
                        platform: $('[name="platform"]:checked').val(),
                        type: "companyName",
                        keyword: keyword
                    },
                }
            });

            if (!this.companyGrid) {
                this.companyGrid = new Grid({
                    el: document.getElementById("company-grid"),
                    data: dataSource,
                    scrollX: false,
                    scrollY: true,
                    draggable: false,
                    contextMenu: null,
                    minBodyHeight: 200,
                    bodyHeight: 200,
                    pageOptions: {
                        perPage: 10,
                    },
                    columns: [
                        {
                            header: "{{ message('item.comp.001') }}", // 회사 코드
                            name: "corpNo",
                            align: "center",
                        },
                        {
                            header: "{{ message('item.comp.003') }}", // 회사 명
                            name: "compNm",
                            ellipsis: true,
                            resizable: true,
                            align: "center",
                        },
                        {
                            header: "사업자번호", // 사업자번호
                            name: "bizno",
                            align: "center",
                        },
                        {
                            header: "대표명", // 대표명
                            name: "ceoNm",
                            align: "center",
                        },
                        { header: "", name: "compTelno", hidden: true },
                        { header: "", name: "compFaxno", hidden: true },
                    ],
                });
                this.companyGrid.on("click", function (e) {
                    const rowKey = e.rowKey;
                    const clickedRowData = _this.companyGrid.getRow(rowKey);

                    if (!clickedRowData || !clickedRowData._attributes) {
                        return;
                    }

                    clickedRowData._attributes.checked = !clickedRowData._attributes.checked;
                    _this.companyGrid.setRow(rowKey, clickedRowData);

                });
            }
        },

        search: function () {
            let keyword = $("#keyword").val();
            grid.makeCompanyGrid(keyword);
        },

        clear: function () {
            $('.check_mark').prop('checked', false);
            grid.updateSelectBoxText();
        },

        changePerPage: function () {
            var size = $('select[id="items-per-page"]').val();
            this.companyGrid.setPerPage(size);

            const pagination = this.companyGrid.paginationManager.getPagination();
            pagination.setItemsPerPage(size);
            pagination.reset();
        },
    };

    $(function(){
        grid.init();

        // 팝업 닫기
        $('[name=btnPopupClose]').on('click', function () {
            $('#popup').empty();
        });

        $('#btnSelected').on('click', function () {
            const rowKey = grid.companyGrid.getFocusedCell()?.rowKey;
            const rowData = grid.companyGrid.getRow(rowKey);

            if (rowData) {
                $('#compNm').val(rowData?.compNm?.trim());
                $('#bsnsmnNo').val(rowData?.bizno?.trim());
                $('#corpCeo').val(rowData?.ceoNm?.trim());

                $('#popup').empty();
            } else {
                gaiaCommon.customAlert("{{ message('msg.067') }}"); // 선택된 회사가 없습니다.
            }
        });

        gaia.loaded = true;
    })

</script>